function e(e,t,i,s,n){var r={};return Object.keys(s).forEach((function(e){r[e]=s[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),r),n&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(n):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}let t=!0,i=!0;function s(e,t,i){const s=e.match(t);return s&&s.length>=i&&parseInt(s[i],10)}function n(e,t,i){if(!e.RTCPeerConnection)return;const s=e.RTCPeerConnection.prototype,n=s.addEventListener;s.addEventListener=function(e,s){if(e!==t)return n.apply(this,arguments);const r=e=>{const t=i(e);t&&(s.handleEvent?s.handleEvent(t):s(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(s,r),n.apply(this,[e,r])};const r=s.removeEventListener;s.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(i))return r.apply(this,arguments);const s=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,s])},Object.defineProperty(s,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function r(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(t=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function a(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function o(){if("object"==typeof window){if(t)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function c(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")}function d(e){return"[object Object]"===Object.prototype.toString.call(e)}function l(e){return d(e)?Object.keys(e).reduce((function(t,i){const s=d(e[i]),n=s?l(e[i]):e[i],r=s&&!Object.keys(n).length;return void 0===n||r?t:Object.assign(t,{[i]:n})}),{}):e}function h(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((s=>{s.endsWith("Id")?h(e,e.get(t[s]),i):s.endsWith("Ids")&&t[s].forEach((t=>{h(e,e.get(t),i)}))})))}function u(e,t,i){const s=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const r=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)})),r.forEach((t=>{e.forEach((i=>{i.type===s&&i.trackId===t.id&&h(e,i,n)}))})),n}const p=o;function _(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const s=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const s="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==s.exact&&"number"==typeof s.exact&&(s.min=s.max=s.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==s.ideal){t.optional=t.optional||[];let e={};"number"==typeof s.ideal?(e[n("min",i)]=s.ideal,t.optional.push(e),e={},e[n("max",i)]=s.ideal,t.optional.push(e)):(e[n("",i)]=s.ideal,t.optional.push(e))}void 0!==s.exact&&"number"!=typeof s.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=s.exact):["min","max"].forEach((e=>{void 0!==s[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=s[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"==typeof e.video){let r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});const a=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let a=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!a&&i.length&&t.includes("back")&&(a=i[i.length-1]),a&&(e.video.deviceId=r.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=s(e.video),p("chrome: "+JSON.stringify(e)),n(e)}))}e.video=s(e.video)}return p("chrome: "+JSON.stringify(e)),n(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,s){n(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{s&&s(r(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(r(e))))))}}}function m(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function g(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else n(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function f(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,s){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){s.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function S(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,s]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},r=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const s=function(e){i(r(n(e)))};return t.apply(this,[s,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(r(n(t)))},i])})).then(i,s)}}function v(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>u(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),n(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>u(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,s;return this.getSenders().forEach((i=>{i.track===e&&(t?s=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?s=!0:i=t),t.track===e))),s||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function y(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const s=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(s)&&this._shimmedLocalStreams[i.id].push(s):this._shimmedLocalStreams[i.id]=[i,s],s};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const s=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(s)};const s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],s.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function T(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return y(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}s.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const s=e._reverseStreams[t],n=e._streams[s.id];i=i.replace(new RegExp(n.id,"g"),s.id)})),new RTCSessionDescription({type:t.type,sdp:i})}function a(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const s=e._reverseStreams[t],n=e._streams[s.id];i=i.replace(new RegExp(s.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const s=[].slice.call(arguments,1);if(1!==s.length||!s[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const s=new e.MediaStream([t]);this._streams[i.id]=s,this._reverseStreams[s.id]=i,this.addStream(s)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=r(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>r(this,e)))}};e.RTCPeerConnection.prototype[t]=s[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=a(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function I(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=s[t]}))}function b(e,t){n(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var E=Object.freeze({__proto__:null,shimMediaStream:m,shimOnTrack:g,shimGetSendersWithDtmf:f,shimGetStats:S,shimSenderReceiverGetStats:v,shimAddTrackRemoveTrackWithNative:y,shimAddTrackRemoveTrack:T,shimPeerConnection:I,fixNegotiationNeeded:b,shimGetUserMedia:_,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const s=i.video&&i.video.width,n=i.video&&i.video.height,r=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r||3}},s&&(i.video.mandatory.maxWidth=s),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});var C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},R={exports:{}};!function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((function(e){return 0===e.indexOf(i)}))},t.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},s=8;s<t.length;s+=2)switch(t[s]){case"raddr":i.relatedAddress=t[s+1];break;case"rport":i.relatedPort=parseInt(t[s+1],10);break;case"tcptype":i.tcpType=t[s+1];break;case"ufrag":i.ufrag=t[s+1],i.usernameFragment=t[s+1];break;default:i[t[s]]=t[s+1]}return i},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,i={},s=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<s.length;n++)i[(t=s[n].trim().split("="))[0].trim()]=t[1];return i},t.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var s=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?s.push(t+"="+e.parameters[t]):s.push(t)})),t+="a=fmtp:"+i+" "+s.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},s=e.indexOf(":",t);return s>-1?(i.attribute=e.substr(t+1,s-t-1),i.value=e.substr(s+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var s=t.matchPrefix(e+i,"a=ice-ufrag:")[0],n=t.matchPrefix(e+i,"a=ice-pwd:")[0];return s&&n?{usernameFragment:s.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=t.splitLines(e)[0].split(" "),n=3;n<s.length;n++){var r=s[n],a=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(a){var o=t.parseRtpMap(a),c=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(o.parameters=c.length?t.parseFmtp(c[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),i.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(o.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){var s="";s+="m="+e+" ",s+=i.codecs.length>0?"9":"0",s+=" UDP/TLS/RTP/SAVPF ",s+=i.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",s+="c=IN IP4 0.0.0.0\r\n",s+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((function(e){s+=t.writeRtpMap(e),s+=t.writeFmtp(e),s+=t.writeRtcpFb(e)}));var n=0;return i.codecs.forEach((function(e){e.maxptime>n&&(n=e.maxptime)})),n>0&&(s+="a=maxptime:"+n+"\r\n"),s+="a=rtcp-mux\r\n",i.headerExtensions&&i.headerExtensions.forEach((function(e){s+=t.writeExtmap(e)})),s},t.parseRtpEncodingParameters=function(e){var i,s=[],n=t.parseRtpParameters(e),r=-1!==n.fecMechanisms.indexOf("RED"),a=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=o.length>0&&o[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(i=d[0][1]),n.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&i&&(t.rtx={ssrc:i}),s.push(t),r&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},s.push(t))}})),0===s.length&&c&&s.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,s.forEach((function(e){e.maxBitrate=l}))),s},t.parseRtcpParameters=function(e){var i={},s=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];s&&(i.cname=s.value,i.ssrc=s.ssrc);var n=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=n.length>0,i.compound=0===n.length;var r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.parseMsid=function(e){var i,s=t.matchPrefix(e,"a=msid:");if(1===s.length)return{stream:(i=s[0].substr(7).split(" "))[0],track:i[1]};var n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return n.length>0?{stream:(i=n[0].value.split(" "))[0],track:i[1]}:void 0},t.parseSctpDescription=function(e){var i,s=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");n.length>0&&(i=parseInt(n[0].substr(19),10)),isNaN(i)&&(i=65536);var r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:s.fmt,maxMessageSize:i};if(t.matchPrefix(e,"a=sctpmap:").length>0){var a=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,s){var n=void 0!==i?i:2;return"v=0\r\no="+(s||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,i,s,n){var r=t.writeRtpDescription(e.kind,i);if(r+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===s?"actpass":"active"),r+="a=mid:"+e.mid+"\r\n",e.direction?r+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?r+="a=sendrecv\r\n":e.rtpSender?r+="a=sendonly\r\n":e.rtpReceiver?r+="a=recvonly\r\n":r+="a=inactive\r\n",e.rtpSender){var a="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";r+="a="+a,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),r},t.getDirection=function(e,i){for(var s=t.splitLines(e),n=0;n<s.length;n++)switch(s[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return s[n].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var i=t.splitLines(e),s=0;s<i.length;s++)if(i[s].length<2||"="!==i[s].charAt(1))return!1;return!0},e.exports=t}(R);var k=R.exports,w=R.exports;function A(e,t,i,s,n){var r=w.writeRtpDescription(e.kind,t);if(r+=w.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=w.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":n||"active"),r+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?r+="a=sendrecv\r\n":e.rtpSender?r+="a=sendonly\r\n":e.rtpReceiver?r+="a=recvonly\r\n":r+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var o="msid:"+(s?s.id:"-")+" "+a+"\r\n";r+="a="+o,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+w.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+w.localCName+"\r\n"),r}function D(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},s=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},n=function(e,t,i,n){var r=s(e.parameters.apt,i),a=s(t.parameters.apt,n);return r&&a&&r.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach((function(s){for(var r=0;r<t.codecs.length;r++){var a=t.codecs[r];if(s.name.toLowerCase()===a.name.toLowerCase()&&s.clockRate===a.clockRate){if("rtx"===s.name.toLowerCase()&&s.parameters&&a.parameters.apt&&!n(s,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(s.numChannels,a.numChannels),i.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter((function(e){for(var t=0;t<s.rtcpFeedback.length;t++)if(s.rtcpFeedback[t].type===e.type&&s.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var s=0;s<t.headerExtensions.length;s++){var n=t.headerExtensions[s];if(e.uri===n.uri){i.headerExtensions.push(n);break}}})),i}function P(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function N(e,t){var i=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return i||e.addRemoteCandidate(t),!i}function M(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}var L=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function s(t,i,s,n){var r=new Event("track");r.track=i,r.receiver=s,r.transceiver={receiver:s},r.streams=n,e.setTimeout((function(){t._dispatchEvent("track",r)}))}var n=function(i){var s=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){s[e]=n[e].bind(n)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw M("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var s=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof s;return n&&(s=[s]),s=s.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(i=!0,!0)})),delete e.url,e.urls=n?s[0]:s,!!s.length}}))}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var r=i.iceCandidatePoolSize;r>0;r--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=w.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(n.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(n.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),n.prototype.onicecandidate=null,n.prototype.onaddstream=null,n.prototype.ontrack=null,n.prototype.onremovestream=null,n.prototype.onsignalingstatechange=null,n.prototype.oniceconnectionstatechange=null,n.prototype.onconnectionstatechange=null,n.prototype.onicegatheringstatechange=null,n.prototype.onnegotiationneeded=null,n.prototype.ondatachannel=null,n.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},n.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},n.prototype.getConfiguration=function(){return this._config},n.prototype.getLocalStreams=function(){return this.localStreams},n.prototype.getRemoteStreams=function(){return this.remoteStreams},n.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,s={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)s.iceTransport=this.transceivers[0].iceTransport,s.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();s.iceTransport=n.iceTransport,s.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(s),s},n.prototype.addTrack=function(t,i){if(this._isClosed)throw M("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var s;if(this.transceivers.find((function(e){return e.track===t})))throw M("InvalidAccessError","Track already exists.");for(var n=0;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(s=this.transceivers[n]);return s||(s=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),s.track=t,s.stream=i,s.rtpSender=new e.RTCRtpSender(t,s.dtlsTransport),s.rtpSender},n.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach((function(t){i.addTrack(t,e)}));else{var s=e.clone();e.getTracks().forEach((function(e,t){var i=s.getTracks()[t];e.addEventListener("enabled",(function(e){i.enabled=e.enabled}))})),s.getTracks().forEach((function(e){i.addTrack(e,s)}))}},n.prototype.removeTrack=function(t){if(this._isClosed)throw M("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find((function(e){return e.rtpSender===t}));if(!i)throw M("InvalidAccessError","Sender was not created by this connection.");var s=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(s)&&this.localStreams.indexOf(s)>-1&&this.localStreams.splice(this.localStreams.indexOf(s),1),this._maybeFireNegotiationNeeded()},n.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var i=t.getSenders().find((function(t){return t.track===e}));i&&t.removeTrack(i)}))},n.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},n.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},n.prototype._createIceGatherer=function(t,i){var s=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;n.state=i?"completed":"gathering",null!==s.transceivers[t].bufferedCandidateEvents&&s.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},n.prototype._gather=function(t,i){var s=this,n=this.transceivers[i].iceGatherer;if(!n.onlocalcandidate){var r=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,n.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),n.onlocalcandidate=function(e){if(!(s.usingBundle&&i>0)){var r=new Event("icecandidate");r.candidate={sdpMid:t,sdpMLineIndex:i};var a=e.candidate,o=!a||0===Object.keys(a).length;if(o)"new"!==n.state&&"gathering"!==n.state||(n.state="completed");else{"new"===n.state&&(n.state="gathering"),a.component=1,a.ufrag=n.getLocalParameters().usernameFragment;var c=w.writeCandidate(a);r.candidate=Object.assign(r.candidate,w.parseCandidate(c)),r.candidate.candidate=c,r.candidate.toJSON=function(){return{candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex,usernameFragment:r.candidate.usernameFragment}}}var d=w.getMediaSections(s._localDescription.sdp);d[r.candidate.sdpMLineIndex]+=o?"a=end-of-candidates\r\n":"a="+r.candidate.candidate+"\r\n",s._localDescription.sdp=w.getDescription(s._localDescription.sdp)+d.join("");var l=s.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==s.iceGatheringState&&(s.iceGatheringState="gathering",s._emitGatheringStateChange()),o||s._dispatchEvent("icecandidate",r),l&&(s._dispatchEvent("icecandidate",new Event("icecandidate")),s.iceGatheringState="complete",s._emitGatheringStateChange())}},e.setTimeout((function(){r.forEach((function(e){n.onlocalcandidate(e)}))}),0)}},n.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var s=new e.RTCDtlsTransport(i);return s.ondtlsstatechange=function(){t._updateConnectionState()},s.onerror=function(){Object.defineProperty(s,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:s}},n.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var s=this.transceivers[e].dtlsTransport;s&&(delete s.ondtlsstatechange,delete s.onerror,delete this.transceivers[e].dtlsTransport)},n.prototype._transceive=function(e,i,s){var n=D(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(n.encodings=e.sendEncodingParameters,n.rtcp={cname:w.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(n.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(n)),s&&e.rtpReceiver&&n.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?n.encodings=e.recvEncodingParameters:n.encodings=[{}],n.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(n.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(n.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(n))},n.prototype.setLocalDescription=function(e){var t,i,s=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(M("TypeError",'Unsupported type "'+e.type+'"'));if(!P("setLocalDescription",e.type,s.signalingState)||s._isClosed)return Promise.reject(M("InvalidStateError","Can not set local "+e.type+" in state "+s.signalingState));if("offer"===e.type)t=w.splitSections(e.sdp),i=t.shift(),t.forEach((function(e,t){var i=w.parseRtpParameters(e);s.transceivers[t].localCapabilities=i})),s.transceivers.forEach((function(e,t){s._gather(e.mid,t)}));else if("answer"===e.type){t=w.splitSections(s._remoteDescription.sdp),i=t.shift();var n=w.matchPrefix(i,"a=ice-lite").length>0;t.forEach((function(e,t){var r=s.transceivers[t],a=r.iceGatherer,o=r.iceTransport,c=r.dtlsTransport,d=r.localCapabilities,l=r.remoteCapabilities;if(!(w.isRejected(e)&&0===w.matchPrefix(e,"a=bundle-only").length)&&!r.rejected){var h=w.getIceParameters(e,i),u=w.getDtlsParameters(e,i);n&&(u.role="server"),s.usingBundle&&0!==t||(s._gather(r.mid,t),"new"===o.state&&o.start(a,h,n?"controlling":"controlled"),"new"===c.state&&c.start(u));var p=D(d,l);s._transceive(r,p.codecs.length>0,!1)}}))}return s._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?s._updateSignalingState("have-local-offer"):s._updateSignalingState("stable"),Promise.resolve()},n.prototype.setRemoteDescription=function(n){var r=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(M("TypeError",'Unsupported type "'+n.type+'"'));if(!P("setRemoteDescription",n.type,r.signalingState)||r._isClosed)return Promise.reject(M("InvalidStateError","Can not set remote "+n.type+" in state "+r.signalingState));var a={};r.remoteStreams.forEach((function(e){a[e.id]=e}));var o=[],c=w.splitSections(n.sdp),d=c.shift(),l=w.matchPrefix(d,"a=ice-lite").length>0,h=w.matchPrefix(d,"a=group:BUNDLE ").length>0;r.usingBundle=h;var u=w.matchPrefix(d,"a=ice-options:")[0];return r.canTrickleIceCandidates=!!u&&u.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(s,c){var u=w.splitLines(s),p=w.getKind(s),_=w.isRejected(s)&&0===w.matchPrefix(s,"a=bundle-only").length,m=u[0].substr(2).split(" ")[2],g=w.getDirection(s,d),f=w.parseMsid(s),S=w.getMid(s)||w.generateIdentifier();if(_||"application"===p&&("DTLS/SCTP"===m||"UDP/DTLS/SCTP"===m))r.transceivers[c]={mid:S,kind:p,protocol:m,rejected:!0};else{var v,y,T,I,b,E,C,R,k;!_&&r.transceivers[c]&&r.transceivers[c].rejected&&(r.transceivers[c]=r._createTransceiver(p,!0));var A,P,M=w.parseRtpParameters(s);_||(A=w.getIceParameters(s,d),(P=w.getDtlsParameters(s,d)).role="client"),C=w.parseRtpEncodingParameters(s);var L=w.parseRtcpParameters(s),O=w.matchPrefix(s,"a=end-of-candidates",d).length>0,x=w.matchPrefix(s,"a=candidate:").map((function(e){return w.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===n.type||"answer"===n.type)&&!_&&h&&c>0&&r.transceivers[c]&&(r._disposeIceAndDtlsTransports(c),r.transceivers[c].iceGatherer=r.transceivers[0].iceGatherer,r.transceivers[c].iceTransport=r.transceivers[0].iceTransport,r.transceivers[c].dtlsTransport=r.transceivers[0].dtlsTransport,r.transceivers[c].rtpSender&&r.transceivers[c].rtpSender.setTransport(r.transceivers[0].dtlsTransport),r.transceivers[c].rtpReceiver&&r.transceivers[c].rtpReceiver.setTransport(r.transceivers[0].dtlsTransport)),"offer"!==n.type||_){if("answer"===n.type&&!_){y=(v=r.transceivers[c]).iceGatherer,T=v.iceTransport,I=v.dtlsTransport,b=v.rtpReceiver,E=v.sendEncodingParameters,R=v.localCapabilities,r.transceivers[c].recvEncodingParameters=C,r.transceivers[c].remoteCapabilities=M,r.transceivers[c].rtcpParameters=L,x.length&&"new"===T.state&&(!l&&!O||h&&0!==c?x.forEach((function(e){N(v.iceTransport,e)})):T.setRemoteCandidates(x)),h&&0!==c||("new"===T.state&&T.start(y,A,"controlling"),"new"===I.state&&I.start(P)),!D(v.localCapabilities,v.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&v.sendEncodingParameters[0].rtx&&delete v.sendEncodingParameters[0].rtx,r._transceive(v,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!b||"sendrecv"!==g&&"sendonly"!==g?delete v.rtpReceiver:(k=b.track,f?(a[f.stream]||(a[f.stream]=new e.MediaStream),i(k,a[f.stream]),o.push([k,b,a[f.stream]])):(a.default||(a.default=new e.MediaStream),i(k,a.default),o.push([k,b,a.default])))}}else{(v=r.transceivers[c]||r._createTransceiver(p)).mid=S,v.iceGatherer||(v.iceGatherer=r._createIceGatherer(c,h)),x.length&&"new"===v.iceTransport.state&&(!O||h&&0!==c?x.forEach((function(e){N(v.iceTransport,e)})):v.iceTransport.setRemoteCandidates(x)),R=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(R.codecs=R.codecs.filter((function(e){return"rtx"!==e.name}))),E=v.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var V,U=!1;if("sendrecv"===g||"sendonly"===g){if(U=!v.rtpReceiver,b=v.rtpReceiver||new e.RTCRtpReceiver(v.dtlsTransport,p),U)k=b.track,f&&"-"===f.stream||(f?(a[f.stream]||(a[f.stream]=new e.MediaStream,Object.defineProperty(a[f.stream],"id",{get:function(){return f.stream}})),Object.defineProperty(k,"id",{get:function(){return f.track}}),V=a[f.stream]):(a.default||(a.default=new e.MediaStream),V=a.default)),V&&(i(k,V),v.associatedRemoteMediaStreams.push(V)),o.push([k,b,V])}else v.rtpReceiver&&v.rtpReceiver.track&&(v.associatedRemoteMediaStreams.forEach((function(t){var i=t.getTracks().find((function(e){return e.id===v.rtpReceiver.track.id}));i&&function(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(i,t)})),v.associatedRemoteMediaStreams=[]);v.localCapabilities=R,v.remoteCapabilities=M,v.rtpReceiver=b,v.rtcpParameters=L,v.sendEncodingParameters=E,v.recvEncodingParameters=C,r._transceive(r.transceivers[c],!1,U)}}})),void 0===r._dtlsRole&&(r._dtlsRole="offer"===n.type?"active":"passive"),r._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?r._updateSignalingState("have-remote-offer"):r._updateSignalingState("stable"),Object.keys(a).forEach((function(t){var i=a[t];if(i.getTracks().length){if(-1===r.remoteStreams.indexOf(i)){r.remoteStreams.push(i);var n=new Event("addstream");n.stream=i,e.setTimeout((function(){r._dispatchEvent("addstream",n)}))}o.forEach((function(e){var t=e[0],n=e[1];i.id===e[2].id&&s(r,t,n,[i])}))}})),o.forEach((function(e){e[2]||s(r,e[0],e[1],[])})),e.setTimeout((function(){r&&r.transceivers&&r.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},n.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},n.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},n.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},n.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},n.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},n.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(M("InvalidStateError","Can not call createOffer after close"));var s=i.transceivers.filter((function(e){return"audio"===e.kind})).length,n=i.transceivers.filter((function(e){return"video"===e.kind})).length,r=arguments[0];if(r){if(r.mandatory||r.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==r.offerToReceiveAudio&&(s=!0===r.offerToReceiveAudio?1:!1===r.offerToReceiveAudio?0:r.offerToReceiveAudio),void 0!==r.offerToReceiveVideo&&(n=!0===r.offerToReceiveVideo?1:!1===r.offerToReceiveVideo?0:r.offerToReceiveVideo)}for(i.transceivers.forEach((function(e){"audio"===e.kind?--s<0&&(e.wantReceive=!1):"video"===e.kind&&--n<0&&(e.wantReceive=!1)}));s>0||n>0;)s>0&&(i._createTransceiver("audio"),s--),n>0&&(i._createTransceiver("video"),n--);var a=w.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach((function(s,n){var r=s.track,a=s.kind,o=s.mid||w.generateIdentifier();s.mid=o,s.iceGatherer||(s.iceGatherer=i._createIceGatherer(n,i.usingBundle));var c=e.RTCRtpSender.getCapabilities(a);t<15019&&(c.codecs=c.codecs.filter((function(e){return"rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),s.remoteCapabilities&&s.remoteCapabilities.codecs&&s.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),c.headerExtensions.forEach((function(e){(s.remoteCapabilities&&s.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=s.sendEncodingParameters||[{ssrc:1001*(2*n+1)}];r&&t>=15019&&"video"===a&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),s.wantReceive&&(s.rtpReceiver=new e.RTCRtpReceiver(s.dtlsTransport,a)),s.localCapabilities=c,s.sendEncodingParameters=d})),"max-compat"!==i._config.bundlePolicy&&(a+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n",i.transceivers.forEach((function(e,t){a+=A(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),a+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,a+="a="+w.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(a+="a=end-of-candidates\r\n"))}));var o=new e.RTCSessionDescription({type:"offer",sdp:a});return Promise.resolve(o)},n.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(M("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(M("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var s=w.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(s+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var n=w.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach((function(e,r){if(!(r+1>n)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var a;if(e.stream)"audio"===e.kind?a=e.stream.getAudioTracks()[0]:"video"===e.kind&&(a=e.stream.getVideoTracks()[0]),a&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var o=D(e.localCapabilities,e.remoteCapabilities);!o.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=A(e,o,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var r=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(r)},n.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(s,n){if(!i._remoteDescription)return n(M("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var r=e.sdpMLineIndex;if(e.sdpMid)for(var a=0;a<i.transceivers.length;a++)if(i.transceivers[a].mid===e.sdpMid){r=a;break}var o=i.transceivers[r];if(!o)return n(M("OperationError","Can not add ICE candidate"));if(o.rejected)return s();var c=Object.keys(e.candidate).length>0?w.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return s();if(c.component&&1!==c.component)return s();if((0===r||r>0&&o.iceTransport!==i.transceivers[0].iceTransport)&&!N(o.iceTransport,c))return n(M("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=w.getMediaSections(i._remoteDescription.sdp))[r]+="a="+(c.type?d:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=w.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var l=0;l<i.transceivers.length&&(i.transceivers[l].rejected||(i.transceivers[l].iceTransport.addRemoteCandidate({}),(t=w.getMediaSections(i._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=w.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));l++);s()}))},n.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)})),!i)throw M("InvalidAccessError","Invalid selector.");return i.getStats()}var s=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&s.push(e[t].getStats())}))})),Promise.all(s).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var s=i.prototype.getStats;i.prototype.getStats=function(){return s.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(i){var s;e[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(s=e[i]).type]||s.type,t.set(i,e[i])})),t}))}}}));var r=["createOffer","createAnswer"];return r.forEach((function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(r=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),n};function O(e){const t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))}}function x(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function V(e,t){if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const i=new Event("enabled");i.enabled=e,this.dispatchEvent(i)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const i=L(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&c("RTCIceServer.url","RTCIceServer.urls");const s="string"==typeof t;return s&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?(i=!0,!0):t&&!i})),delete e.url,e.urls=s?t[0]:t,!!t.length}}))}(e.iceServers,t.version),o("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype}function U(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}var $=Object.freeze({__proto__:null,shimPeerConnection:V,shimReplaceTrack:U,shimGetUserMedia:O,shimGetDisplayMedia:x});function F(e,t){const i=e&&e.navigator,s=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,s){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,s)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},s&&s.prototype.getSettings){const t=s.prototype.getSettings;s.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(s&&s.prototype.applyConstraints){const t=s.prototype.applyConstraints;s.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function j(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function B(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=s[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,r]=arguments;return s.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(s){if("TypeError"!==s.name)throw s;e.forEach(((t,s)=>{e.set(s,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(n,r)}}function H(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function G(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),n(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function J(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){c("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function W(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function z(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const s=t.apply(this,arguments);if(i){const{sender:t}=s,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return s})}function q(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function K(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var X=Object.freeze({__proto__:null,shimOnTrack:j,shimPeerConnection:B,shimSenderGetStats:H,shimReceiverGetStats:G,shimRemoveStream:J,shimRTCDataChannel:W,shimAddTransceiver:z,shimGetParameters:q,shimCreateOffer:K,shimCreateAnswer:Q,shimGetUserMedia:F,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}});function Y(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function Z(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function ee(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,s=t.createAnswer,n=t.setLocalDescription,r=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const s=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[s]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=s.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,i){const s=n.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s};t.setLocalDescription=o,o=function(e,t,i){const s=r.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s},t.setRemoteDescription=o,o=function(e,t,i){const s=a.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s},t.addIceCandidate=o}function te(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(ie(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,s){t.mediaDevices.getUserMedia(e).then(i,s)}.bind(t))}function ie(e){return e&&void 0!==e.video?Object.assign({},e,{video:l(e.video)}):e}function se(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let s=e.iceServers[i];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,t.push(s)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ne(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function re(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}}function ae(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var oe=Object.freeze({__proto__:null,shimLocalStreamsAPI:Y,shimRemoteStreamsAPI:Z,shimCallbacksAPI:ee,shimGetUserMedia:te,shimConstraints:ie,shimRTCIceServerUrls:se,shimTrackEventTransceiver:ne,shimCreateOfferLegacy:re,shimAudioContext:ae});function ce(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),s=k.parseCandidate(e.candidate),n=Object.assign(i,s);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,n(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function de(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=k.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=k.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},s=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},n=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},r=function(e,i){let s=65536;"firefox"===t.browser&&57===t.version&&(s=65535);const n=k.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?s=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(s=2147483637),s},a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=s(arguments[0]),t=n(e),i=r(arguments[0],e);let a;a=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>a}),this._sctp=o}return a.apply(this,arguments)}}function le(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const s=arguments[0],n=s.length||s.size||s.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},n(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function he(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function ue(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function pe(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var _e=Object.freeze({__proto__:null,shimRTCIceCandidate:ce,shimMaxMessageSize:de,shimSendThrowTypeError:le,shimConnectionState:he,removeExtmapAllowMixed:ue,shimAddIceCandidateNullOrEmpty:pe});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const i=o,n=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=s(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=s(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=s(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=s(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),c={browserDetails:n,commonShim:_e,extractVersion:s,disableLog:r,disableWarnings:a};switch(n.browser){case"chrome":if(!E||!I||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),c;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),c;i("adapter.js shimming chrome."),c.browserShim=E,pe(e,n),_(e,n),m(e),I(e,n),g(e),T(e,n),f(e),S(e),v(e),b(e,n),ce(e),he(e),de(e,n),le(e),ue(e,n);break;case"firefox":if(!X||!B||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),c;i("adapter.js shimming firefox."),c.browserShim=X,pe(e,n),F(e,n),B(e,n),j(e),J(e),H(e),G(e),W(e),z(e),q(e),K(e),Q(e),ce(e),he(e),de(e,n),le(e);break;case"edge":if(!$||!V||!t.shimEdge)return i("MS edge shim is not included in this adapter release."),c;i("adapter.js shimming edge."),c.browserShim=$,O(e),x(e),V(e,n),U(e),de(e,n),le(e);break;case"safari":if(!oe||!t.shimSafari)return i("Safari shim is not included in this adapter release."),c;i("adapter.js shimming safari."),c.browserShim=oe,pe(e,n),se(e),re(e),ee(e),Y(e),Z(e),ne(e),te(e),ae(e),ce(e),de(e,n),le(e),ue(e,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});let me=(new Date).getTime(),ge=0;const fe=function(){return(new Date).getTime()+ge},Se=function(){const e=new Date;return e.setTime(fe()),e.toLocaleString()},ve=window.navigator&&window.navigator.userAgent||"",ye=/AppleWebKit\/([\d.]+)/i.exec(ve);ye&&parseFloat(ye.pop());const Te=/iPad/i.test(ve),Ie=navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/Macintosh/.test(ve),be=/iPhone/i.test(ve)&&!Te,Ee=/iPod/i.test(ve),Ce=be||Te||Ee||Ie,Re=/Android/i.test(ve);Re&&function(){const e=ve.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);t&&i&&parseFloat(e[1]+"."+e[2])}();Re&&/webkit/i.test(ve);const ke=/Firefox/i.test(ve),we=ke&&function(){const e=ve.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),Ae=/Edge\//i.test(ve),De=Ae&&function(){var e=ve.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),Pe=/Edg\//i.test(ve),Ne=Pe&&function(){const e=ve.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),Me=/SogouMobileBrowser\//i.test(ve),Le=Me&&function(){const e=ve.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),Oe=/MetaSr\s/i.test(ve),xe=Oe&&function(){const e=ve.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),Ve=/TBS\/\d+/i.test(ve),Ue=Ve&&function(){var e=ve.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),$e=/XWEB\/\d+/i.test(ve),Fe=$e&&function(){var e=ve.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}();/MSIE\s8\.0/.test(ve);/MSIE\/\d+/i.test(ve)&&function(){const e=/MSIE\s(\d+)\.\d/.exec(ve);let t=e&&parseFloat(e[1]);!t&&/Trident\/7.0/i.test(ve)&&/rv:11.0/.test(ve)&&(t=11)}();const je=/(micromessenger|webbrowser)/i.test(ve),Be=je&&function(){var e=ve.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return e[1]}(),He=!Ve&&/MQQBrowser\/\d+/i.test(ve)&&/COVC\/\d+/i.test(ve),Ge=!Ve&&/MQQBrowser\/\d+/i.test(ve)&&!/COVC\/\d+/i.test(ve),Je=(Ge||He)&&function(){const e=ve.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),We=!Ve&&/ QQBrowser\/\d+/i.test(ve),ze=We&&function(){const e=ve.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),qe=!Ve&&/QQBrowserLite\/\d+/i.test(ve),Ke=qe&&function(){const e=ve.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Qe=!Ve&&/MQBHD\/\d+/i.test(ve),Xe=Qe&&function(){const e=ve.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Ye=/Windows/i.test(ve),Ze=!Ce&&/MAC OS X/i.test(ve),et=!Re&&/Linux/i.test(ve);/MicroMessenger/i.test(ve);const tt=/UCBrowser/i.test(ve);/Electron/i.test(ve);const it=/MiuiBrowser/i.test(ve),st=it&&function(){const e=ve.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),nt=/HuaweiBrowser/i.test(ve),rt=/Huawei/i.test(ve),at=nt&&function(){const e=ve.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ot=/SamsungBrowser/i.test(ve),ct=ot&&function(){const e=ve.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),dt=/HeyTapBrowser/i.test(ve),lt=dt&&function(){const e=ve.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ht=/VivoBrowser/i.test(ve),ut=ht&&function(){const e=ve.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),pt=()=>{const e=ve.match(/Chrome\/(\d+)/);return e&&e[1]?Number(e[1]):null},_t=/Chrome/i.test(ve),mt=!Ae&&!Oe&&!Me&&!Ve&&!$e&&!Pe&&!We&&!it&&!nt&&!ot&&!dt&&!ht&&/Chrome/i.test(ve),gt=mt&&pt(),ft=mt&&function(){const e=ve.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),St=!_t&&!Ge&&!He&&!qe&&!Qe&&/Safari/i.test(ve),vt=function(){if(St){const e=ve.match(/Version\/([\d.]+)/);if(e&&e[1])return e[1]}return""}(),yt=/Android.*(wv|.0.0.0)/.test(ve),Tt=(()=>{if(Ie)return vt;if(Ce){const e=ve.match(/OS (\d+)_(\d+)/i);if(e&&e[1]){let t=e[1];return e[2]&&(t+=`.${e[2]}`),t}}return""})(),It="15.1"===vt,bt="15.1"===Tt,Et=(()=>{const e=Number(Tt.split(".")[0]);return 14===e||13===e})(),Ct="file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname,Rt=(()=>{let e;return()=>{if(ma(e))try{e=window.localStorage}catch(t){Oo.warn(t),e=!1}return e}})(),kt=new Map([[ke,["Firefox",we]],[Pe,["Edg",Ne]],[mt,["Chrome",ft]],[St,["Safari",vt]],[Ve,["TBS",Ue]],[$e,["XWEB",Fe]],[je&&be,["WeChat",Be]],[We,["QQ(Win)",ze]],[Ge,["QQ(Mobile)",Je]],[He,["QQ(Mobile X5)",Je]],[qe,["QQ(Mac)",Ke]],[Qe,["QQ(iPad)",Xe]],[it,["MI",st]],[nt,["HW",at]],[ot,["Samsung",ct]],[dt,["OPPO",lt]],[ht,["VIVO",ut]],[Ae,["EDGE",De]],[Me,["SogouMobile",Le]],[Oe,["Sogou",xe]]]);function wt(){let e="unknown",t="unknown";return kt.get(!0)&&(e=kt.get(!0)[0],t=kt.get(!0)[1]),{name:e,version:t}}const At="canvas",Dt="audio",Pt="video",Nt="screen",Mt="small",Lt="big",Ot="auxiliary",xt="aux",Vt="smallVideo",Ut="user",$t="environment",Ft="mute",jt="unmute",Bt="ended",Ht="playing",Gt="pause",Jt="error",Wt="loadeddata",zt="audioinput",qt="videoinput",Kt="detail",Qt="text",Xt="main",Yt="backup",Zt="banned",ei="kick",ti="user_time_out",ii="room_disband",si="sei-message",ni="PLAYING",ri="PAUSED",ai="STOPPED",oi="inactive",ci="sendonly",di="recvonly",li="add",hi="remove",ui="replace",pi="track",_i="wss://trtc.rtc.qq.com",mi="wss://webrtc.qq.com",gi="qcloud",fi="trtc",Si="webrtc";let vi="";const yi="jssdk_log",Ti="jssdk_event",Ii="jssdk_new_endreport",bi=e=>vi=e,Ei=1,Ci=2,Ri=20,ki=21,wi="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",Ai="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",Di=2,Pi=Xt,Ni=Ot,Mi="DISCONNECTED",Li="CONNECTING",Oi="RECONNECTING",xi="CONNECTED",Vi="new",Ui="connecting",$i="failed",Fi="closed",ji="disconnected",Bi="connected",Hi="completed",Gi="join",Ji="delta-join",Wi="rejoin",zi="leave",qi="delta-leave",Ki="publish",Qi="delta-publish",Xi="unpublish",Yi="subscribe",Zi="unsubscribe",es="uplink-connection",ts="uplink-reconnection",is="downlink-connection",ss="downlink-reconnection",ns="setLocalDescription",rs="setRemoteDescription",as="iceConnectionState",os="stream-initialize",cs="websocketConnectionState",ds="websocketReconnectionState",ls="update-stream",hs="recover-subscription",us="start-mix-transcode",ps="stop-mix-transcode",_s="player-error",ms="schedule",gs="load-worklet",fs="unsubscribe",Ss="subscribe_change",vs={MANUAL:"manual",PRESET_LAYOUT:"preset-layout"},ys={REMOTE:"$PLACE_HOLDER_REMOTE$"},Ts={IT_AUDIO_VIDEO:0,IT_PICTURE:2,IT_CANVAS:3,IT_PURE_AUDIO:4,IT_PURE_VIDEO:5},Is="string",bs="number",Es="boolean",Cs="array",Rs="object",ks={ADD:li,REMOVE:hi},ws={unknown:0,wifi:1,"4g":2,"3g":3,"2g":4,wired:5},As=-1,Ds=0,Ps=1,Ns=Lt,Ms=Mt,Ls="schedule.rtc.qq.com",Os="schedule.rtc.qcloud.com",xs="schedule.rtc.tencentcloud.com",Vs="schedule-ecdn.rtc.tencentcloud.com",Us="TRTC",$s="Client",Fs="LocalStream",js="RemoteStream",Bs="Stream",Hs="web.sdk.qcloud.com",Gs="web.sdk.tencent.cn",Js="web.sdk.cloud.tencent.cn",Ws=`https://${Hs}/trtc/webrtc/doc`,zs=`${Ws}/zh-cn/`,qs={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},Ks=Object.keys(qs),Qs=["normal leave","timeout leave","kick","role change"],Xs="ric",Ys="AVOID_REPEATED_CALL",Zs="INVALID_PARAMETER_REQUIRED",en="INVALID_PARAMETER_TYPE",tn="INVALID_PARAMETER_EMPTY",sn="INVALID_PARAMETER_INSTANCE",nn="INVALID_PARAMETER_RANGE",rn="API_CALL_TIMEOUT",an="SIGNAL_CHANNEL_RECONNECTION_FAILED",on="SIGNAL_CHANNEL_SETUP_FAILED",cn="ERROR_MESSAGE",dn="EXCHANGE_SDP_TIMEOUT",ln="DOWNLINK_RECONNECTION_FAILED",hn="EXCHANGE_SDP_FAILED",un="UPLINK_RECONNECTION_FAILED",pn="INVALID_PURE_AUDIO",_n="INVALID_STREAMID",mn="INVALID_USER_DEFINE_RECORDID",gn="INVALID_USER_DEFINE_PUSH_ARGS",fn="INVALID_PROXY",Sn="INVALID_JOIN",vn="INVALID_ROOMID_STRING",yn="INVALID_ROOMID_INTEGER",Tn="JOIN_ROOM_TIMEOUT",In="JOIN_ROOM_FAILED",bn="REJOIN_ROOM_FAILED",En="INVALID_DESTROY",Cn="INVALID_PUBLISH",Rn="INVALID_UNPUBLISH",kn="INVALID_AUDIENCE",wn="INVALID_INITIALIZE",An="INVALID_DUPLICATE_PUBLISHING",Dn="INVALID_REMOTE_STREAM",Pn="SUBSCRIBE_FAILED",Nn="INVALID_ROLE",Mn="INVALID_OPERATION_SWITCH_ROLE",Ln="SWITCH_ROLE_TIMEOUT",On="SWITCH_ROLE_FAILED",xn="CLIENT_BANNED",Vn="INVALID_OPERATION_START_PUBLISH_CDN",Un="INVALID_OPERATION_STOP_PUBLISH_CDN",$n="INVALID_STREAM_ID",Fn="START_PUBLISH_CDN_FAILED",jn="STOP_PUBLISH_CDN_FAILED",Bn="START_MIX_TRANSCODE",Hn="STOP_MIX_TRANSCODE",Gn="INVALID_AUDIO_VOLUME",Jn="ENABLE_SMALL_STREAM_PUBLISHED",Wn="DISABLE_SMALL_STREAM_PUBLISHED",zn="NOT_SUPPORTED_SMALL_STREAM",qn="INVALID_SMALL_STREAM_PROFILE",Kn="INVALID_PARAMETER_REMOTE_STREAM",Qn="INVALID_SWITCH_DEVICE",Xn="INVALID_SWITCH_DEVICE_PUBLISHING",Yn="INVALID_REPLACE_TRACK",Zn="INVALID_INITIALIZE_LOCAL_STREAM",er="INVALID_ADD_TRACK_REPETITIVE",tr="INVALID_ADD_TRACK_REMOVING",ir="INVALID_ADD_TRACK_PUBLISHING",sr="INVALID_STREAM_INITIALIZED",nr="INVALID_ADD_TRACK_NUMBER",rr="INVALID_REMOVE_AUDIO_TRACK",ar="INVALID_REMOVE_AUDIO_ADDING",or="INVALID_REMOVE_AUDIO_ON",cr="INVALID_REMOVE_TRACK_PUBLISHING",dr="INVALID_REMOVE_TRACK_NOT_PUBLISHING",lr="INVALID_REMOVE_TRACK_NUMBER",hr="INVALID_REPLACE_TRACK_NO_TRACK",ur="REPEAT_JOIN",pr="CLIENT_DESTROYED",_r="START_MIX_TRANSCODE_FAILED",mr="STOP_MIX_TRANSCODE_FAILED",gr="MIX_TRANSCODE_NOT_STARTED",fr="CANNOT_LESS_THAN_ZERO",Sr="MIX_PARAMS_VIDEO_FRAMERATE",vr="MIX_PARAMS_VIDEO_GOP",yr="MIX_PARAMS_AUDIO_BITRATE",Tr="MIX_PARAMS_USER_Z_ORDER",Ir="MIX_PARAMS_NOT_SELF",br="MIX_PARAMS_USER_STREAM",Er="INVALID_ELEMENT_ID",Cr="INVALID_ELEMENT_ID_TYPE",Rr="PLAY_FAILED",kr="INVALID_CREATE_STREAM_SOURCE",wr="INVALID_CREATE_STREAM_SCREEN",Ar="INVALID_CREATE_STREAM_AUDIO",Dr="INVALID_CREATE_STREAM_SCREEN_AUDIO",Pr="NOT_SUPPORTED_HTTP",Nr="NOT_SUPPORTED_WEBRTC",Mr="NOT_SUPPORTED_PROFILE",Lr="NOT_SUPPORTED_H264ENCODE",Or="NOT_SUPPORTED_H264DECODE",xr="NOT_SUPPORTED_TRACK",Vr="NOT_SUPPORTED_SWITCH_DEVICE",Ur="NOT_SUPPORTED_CAPTURE",$r="NOT_SUPPORTED_AUX",Fr="MICROPHONE_NOT_FOUND",jr="CAMERA_NOT_FOUND",Br="SIGNAL_RESPONSE_FAILED",Hr="CATCH_HANDLER_ERROR",Gr="API_NOT_EXIST",Jr="CONNECTION_CLOSED",Wr="SUBSCRIBE_ALL_FALSE",zr="SEI_NOT_SUPPORT",qr="SEI_DISABLED",Kr="SEI_EMPTY",Qr="SEI_OVERSIZE",Xr="SEI_BEFORE_PUBLISH",Yr="SEI_NOT_VIDEO",Zr="CALL_FREQUENCY_LIMIT",ea="CONNECTION_ABORTED",ta="API_CALL_ABORTED",ia="DUPLICATE_AUX",sa={AVOID_REPEATED_CALL:e=>`previous ${e.name}() is ongoing, please avoid repeated calls.`,INVALID_PARAMETER_REQUIRED:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' is a required param when calling ${i}(), received: ${s}.`,INVALID_PARAMETER_TYPE({key:e,rule:t,fnName:i,value:s}){const n=`${e||t.name}`;let r="";return r=Array.isArray(t.type)?t.type.join("|"):t.type,`'${n}' must be type of ${r} when calling ${i}(), received type: ${Ia(s)}.`},INVALID_PARAMETER_EMPTY:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' cannot be '${s}' when calling ${i}().`,INVALID_PARAMETER_INSTANCE:({key:e,rule:t,fnName:i,value:s})=>`'${`${e||t.name}`}' must be instanceof ${`${t.instanceOf.name||t.instanceOf}`} when calling ${i}(), received type: ${Ia(s)}.`,INVALID_PARAMETER_RANGE:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' must be one of ${t.values.join("|")} when calling ${i}(), received: ${s}.`,API_CALL_TIMEOUT:e=>`${e.commandDesc||e.command} timeout observed.`,SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:e=>`SignalChannel setup failure: (errorCode: ${e.errorCode}, errorMsg: ${e.errorMsg} }).`,ERROR_MESSAGE(e){let t=`${e.type} failed`;return e.message&&(t=`${t}: ${e.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:e=>`exchange sdp failed ${e.errMsg}.`,UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:e=>`'${e}' must be validate string when useStringRoomId is true.`,INVALID_ROOMID_INTEGER:e=>`'${e}' must be an integer between [1, 4294967294] when useStringRoomId is false.`,INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED:({error:e,code:t})=>`Failed to join room - ${e} code: ${t}`,REJOIN_ROOM_FAILED:e=>`reJoin room: ${e.roomId} failed, please check your network.`,INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:'no permission to publish() under live/audience, please call switchRole("anchor") firstly before publish().',INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING:e=>`duplicate ${e} stream publishing, please unpublish your prev ${e} stream and then re-publish.`,INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED:({message:e,stream:t})=>`failed to subscribe ${t.getUserId()} ${t.getType()} stream, reason: ${e}.`,INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:"role could only be set to a value as anchor or audience.",INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:e=>`switchRole failed, errCode: ${e.code} errMsg: ${e.message}.`,CLIENT_BANNED:e=>"client was banned because of "+e.message+".",INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() before client join the room or after client join the room and successfully publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED:e=>`startPublishCDNStream failed, errMsg: ${e.message}.`,STOP_PUBLISH_CDN_FAILED:e=>`stopPublishCDNStream failed, errMsg: ${e.message}.`,INVALID_STREAM_ID:e=>`'${e}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`,START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"the track to be removed is not being publishing.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK:e=>`cannot replace ${e.kind} track because stream has not ${e.kind} track`,START_MIX_TRANSCODE_FAILED:e=>`startMixTranscode failed, errMsg: ${e.message}.`,STOP_MIX_TRANSCODE_FAILED:e=>`stopMixTranscode failed, errMsg: ${e.message}.`,MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' cannot be less than 0 when calling ${i}().`,MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER:e=>`'${e}' is required and must be between 1 and 15.`,MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:e,fnName:t})=>`'${e}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:e,fnName:t,type:i})=>`the element corresponding to '${e}' must be instanceof HTMLDivElement when calling ${t}(), received: ${i}.`,PLAY_FAILED:e=>`${e.media} play failed，browser exception: ${e.error.toString()}`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK:e=>`${e}Track is not supported on your browser.`,NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream.",SIGNAL_RESPONSE_FAILED:e=>`${e.signalResponse} failed, response code is ${e.code} , errMsg: ${e.message}.`,CATCH_HANDLER_ERROR:({name:e,event:t})=>`an error was caught on ${e}.on('${t}', handler), please check your code on 'handler'.`,API_NOT_EXIST:({name:e})=>`experimental api ${e} does not exist.`,REPEAT_JOIN:e=>`[${e}] is calling client.join api or has already joined room, please avoid repeated join.`,CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED:({funName:e})=>`failed to call ${e}() because client was destroyed.`,SEI_NOT_SUPPORT:e=>"not support to sendSEIMessage"+(!1===e?" without using h264 codec":""),SEI_DISABLED:"SEI is disabled, to enable SEI: TRTC.createClient({ enableSEI: true })",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:e=>`buffer size(${e}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:e,name:t,timesInSecond:i,maxSizeInSecond:s})=>`api ${t} call ${e?"size":"times"} is over ${e?s+" bytes":i} in a second.`,CONNECTION_ABORTED:e=>"connection aborted due to: "+e,API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?`Subscribe ${e.stream.getUserId()} ${e.stream.getType()} stream aborted, reason: remote user ${e.stream.getUserId()} unpublished stream.`:`API aborted, reason: ${e.message}`,t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser."},na=(e,t)=>t?Ws+"/"+e+"/"+t:Ws+"/"+e+"/index.html",ra=()=>{if(!Rt())return!1;const e=localStorage.getItem("trtc_error_assistance");e&&!(e=>{const t=e.saveTime&&(new Date).getTime()-e.saveTime>=6048e5,i=!e.saveVersion||"4.15.1"!==e.saveVersion;return t||i})(JSON.parse(e))||(Oo.info("init debug info"),(()=>{const e=new XMLHttpRequest;if(e.open("GET","https://web.sdk.qcloud.com/trtc/webrtc/download/error-message/0.0.3/script.js",!1),e.send(null),4===e.readyState&&200===e.status){const t=document.createElement("script");t.type="text/javascript",t.text=e.responseText,document.body.appendChild(t),localStorage.setItem("trtc_error_assistance",JSON.stringify({message:e.responseText,saveTime:(new Date).getTime(),saveVersion:"4.15.1"})),document.body.removeChild(t)}})())};function aa(e){const{key:t,data:i,link:s,addDocLink:n=!0}=e;let r="",a="",o="";_a(sa[t])?r=sa[t](i):ga(sa[t])&&(r=sa[t]);const{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:d}=(()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};{let e=localStorage.getItem("trtc_error_assistance");if(e){e=JSON.parse(e);const t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);const i=window.TRTC_ERROR_INFO,s=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:s}}}return{}})();s?o=`${s.className}.html#${s.fnName}`:d&&d[t]&&(_a(d[t])?o=d[t](i):ga(d[t])&&(o=d[t]));let l=r;return Ra()&&(c&&c[t]&&(_a(c[t])?a=c[t](i):ga(c[t])&&(a=c[t])),a&&(l=n?a+"\n请查看文档: "+na("zh-cn",o)+"\n\n":a+"\n\n",l+=r)),n&&(l+=" \nRefer to: "+na("en",o)+"\n"),l}const oa=function(){return function(e){const t=window.location.search.match(new RegExp("(\\?|&)"+e+"=([^&]*)(&|$)"));return t?decodeURIComponent(t[2]):""}("trtc_env")},ca=e=>(e=Number(e))>0&&e<14e8,da=function(e,t){let i;i=vi||(ca(e)?"https://apisgp.my-imcloud.com":"https://yun.tim.qq.com");return`${i}/v5/AVQualityReportSvc/C2S?random=${Math.floor(Math.random()*2**31)}&sdkappid=${e}&cmdtype=${t}`};function la(){const e=navigator.userAgent,t=navigator.connection;let i=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";i=i.toLowerCase().replace("nettype/",""),"3gnet"===i&&(i="3g");const s=t&&t.type&&t.type.toLowerCase();let n=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===n&&(n="2g");let r=i||"unknown";if(s)switch(s){case"cellular":case"wimax":r=n||"unknown";break;case"wifi":r="wifi";break;case"ethernet":r="wired";break;case"none":case"other":case"unknown":r="unknown"}return r}const ha=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function ua(e,t=1,i=1){return e<=1?i:ua(e-1,i,t+i)}function pa(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*ua(t)}const _a=e=>"function"==typeof e,ma=e=>void 0===e,ga=e=>"string"==typeof e,fa=e=>"number"==typeof e,Sa=e=>"boolean"==typeof e,va=e=>"object"===Ia(e),ya=e=>"array"===Ia(e),Ta=e=>Ia(e)==="MediaStreamTrack".toLowerCase();function Ia(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}function ba(e){const t={};return t.urls=`turn:${e.url}`,ma(e.username)||ma(e.credential)||(t.username=e.username,t.credential=e.credential,t.credentialType="password",ma(e.credentialType)||(t.credentialType=e.credentialType)),t}function Ea(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}function Ca(e,t="big"){if(!ga(e))return 0;const i=e.split(".");return"big"===t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}const Ra=()=>{let e=navigator.language||navigator.userLanguage;return e=e.substr(0,2),"zh"===e},ka=(()=>{let e=!1,t=document.visibilityState;return()=>{document.visibilityState!==t&&Oo.info(`visibility change: ${document.visibilityState}`),e||(document.addEventListener("visibilitychange",(()=>{Oo.info("visibility change: "+document.visibilityState),t=document.visibilityState})),e=!0)}})();window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;const wa=()=>new window.AudioContext,Aa=(()=>{let e;return()=>{if(e)return e;e=new window.AudioContext;return e.onstatechange=()=>{Oo.info(`gain context state: ${e.state}`),"suspended"===e.state?(e.resume(),document.addEventListener("click",e.resume)):"interrupted"===e.state?e.resume():document.removeEventListener("click",e.resume)},e}})(),Da=!!window.AudioWorkletNode,Pa=(e,t)=>{const i=e.emit;return e.emit=(...s)=>{try{i.apply(e,s)}catch(n){const e=aa({key:Hr,data:{name:t,event:s[0]},addDocLink:!1});Oo.warn(e+"\n\n"+n.stack)}},e},Na=e=>+e<10?`0${e}`:e,Ma=e=>{const t=e.match(/^\d+\.\d+\.\d+/)[0];if(!t)return e;const i=t.split("."),s=Na(i[1])+Na(i[2]);i[1]-15>0&&(i[1]="15"),i[2]-15>0&&(i[2]="15");return i.join(".")+"."+s};function La(e){const{url:t,body:i,method:s,timeout:n}=e;let r=new XMLHttpRequest;return new Promise(((e,a)=>{r.onload=t=>{if(r.status>=200&&r.status<300&&r.responseText.length>0)try{let t=JSON.parse(r.response);e({data:t})}catch(i){e({data:r.response})}else r.status>0&&a({code:r.status,message:`request failed, readyState:${r.readyState} status:${r.status} loaded size:${t.loaded}`})};const o=e=>{a({code:r.readyState,message:`request ${e.type}, readyState:${r.readyState} status:${r.status} loaded size:${e.loaded}`})};r.onerror=o,r.onabort=o,r.ontimeout=o,r.timeout=n||5e3,r.open(s||"POST",t,!0),r.send(i)}))}var Oa={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function s(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,s,r,a){if("function"!=typeof s)throw new TypeError("The listener must be a function");var o=new n(s,r||e,a),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function o(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),o.prototype.eventNames=function(){var e,s,n=[];if(0===this._eventsCount)return n;for(s in e=this._events)t.call(e,s)&&n.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=i?i+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var n=0,r=s.length,a=new Array(r);n<r;n++)a[n]=s[n].fn;return a},o.prototype.listenerCount=function(e){var t=i?i+e:e,s=this._events[t];return s?s.fn?1:s.length:0},o.prototype.emit=function(e,t,s,n,r,a){var o=i?i+e:e;if(!this._events[o])return!1;var c,d,l=this._events[o],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,s),!0;case 4:return l.fn.call(l.context,t,s,n),!0;case 5:return l.fn.call(l.context,t,s,n,r),!0;case 6:return l.fn.call(l.context,t,s,n,r,a),!0}for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var u,p=l.length;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),h){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,s);break;case 4:l[d].fn.call(l[d].context,t,s,n);break;default:if(!c)for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l[d].fn.apply(l[d].context,c)}}return!0},o.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,s,n){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return a(this,r),this;var o=this._events[r];if(o.fn)o.fn!==t||n&&!o.once||s&&o.context!==s||a(this,r);else{for(var c=0,d=[],l=o.length;c<l;c++)(o[c].fn!==t||n&&!o[c].once||s&&o[c].context!==s)&&d.push(o[c]);d.length?this._events[r]=1===d.length?d[0]:d:a(this,r)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&a(this,t)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(Oa);var xa=Oa.exports;const Va=new xa,Ua=1,$a=2,Fa=3,ja=4,Ba=5,Ha=20,Ga=21,Ja=22,Wa=23,za=24,qa=27,Ka=28,Qa=29,Xa=30,Ya=33,Za=31,eo=32,to=100,io=101,so=102,no=103,ro=110,ao=111,oo=112,co=113,lo=114,ho=115,uo=116,po=120,_o=121,mo=122,go=123,fo=130,So=131,vo=132,yo=133,To=134,Io=135,bo=136,Eo=137,Co=200,Ro=201,ko=300,wo=301,Ao=302,Do=303;function Po({retryFunction:e,settings:t,onError:i,onRetrying:s,onRetryFailed:n,context:r}){return function(...a){const o=t.retries||5;let c=0,d=-1,l=0;const h=async(u,p)=>{const _=r||this;try{const t=await e.apply(_,a);c=0,u(t)}catch(m){const e=()=>{clearTimeout(d),c=0,l=2,p(m)},r=()=>{2!==l&&c<o?(c++,l=1,_a(s)&&s.call(_,c,e),d=setTimeout((()=>{d=-1,h(u,p)}),ma(t.timeout)?1e3:t.timeout)):(e(),_a(n)&&n.call(_,m))};_a(i)?i.call(_,m,r,p):r()}};return new Promise(h)}}class No{constructor(e){this.log=e.log,this.level=e.level,this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.forAllJoinedClients=e.forAllJoinedClients,this.uploaded=!1}}class Mo{constructor(e){this.id_=e.id,this.userId_=e.userId,this.sdkAppId_=e.sdkAppId,this.type_=e.type,this.isLocal_=!Sa(e.isLocal)||e.isLocal}setUserId(e){this.userId_=e}setSdkAppId(e){this.sdkAppId_=e}log(e,t){Oo.log({log:`[${this.isLocal_?"↑":"↓"}${this.id_}] ${this.type_?this.type_+" ":""}${t}`,level:e,forAllJoinedClients:ma(this.userId_),userId:this.userId_,sdkAppId:this.sdkAppId_})}info(e){this.log(qs.INFO,e)}debug(e){this.log(qs.DEBUG,e)}warn(e){this.log(qs.WARN,e)}error(e){this.log(qs.ERROR,e)}}const Lo=!(Ce||Re);var Oo=new class{constructor(){this.clients_=new Set,this.queue_=[],this.timeoutId_=-1,this.logLevel_=qs.DEBUG,this.logLevelToUpload_=qs.INFO,this.enableUploadLog_=!0,this.isAbleToUpload_=!1,this.startUpload(),this.checkURLParam(),Va.on(Xa,(({client:e})=>this.clients_.add(e))),Va.on(Ya,(({client:e})=>this.clients_.delete(e))),Va.on(Za,(e=>{e&&ha(e.config)&&Ks[e.config.logLevelToUpload]&&(this.logLevelToUpload_=e.config.logLevelToUpload)})),Va.on(ja,this.setIsAbleToUpload,this),Va.on(Ba,this.setIsAbleToUpload,this)}getIsAbleToUpload(){return this.isAbleToUpload_}setIsAbleToUpload(){this.isAbleToUpload_=!0,Va.off(ja,this.setIsAbleToUpload,this),Va.off(Ba,this.setIsAbleToUpload,this)}async startUpload(){try{await this.upload()}catch(e){}this.timeoutId_=setTimeout((()=>this.startUpload()),2e3)}stopUpload(){-1!==this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=-1)}getLogsToUpload(){const e={map:new Map,splicedQueue:[]};if(this.queue_[0].forAllJoinedClients&&0===this.clients_.size)return e;let t=0;for(;t<this.queue_.length&&50!==t;t++){const i=this.queue_[t];if(i.forAllJoinedClients)this.clients_.forEach((t=>{if(!t.getIsJoined())return;const s=t.getUserId(),n=t.getSDKAppId();if(e.map.has(s)){const{logs:t}=e.map.get(s);t.push(i)}else e.map.set(s,{userId:s,sdkAppId:n,logs:[i]})}));else if(e.map.has(i.userId)){const{logs:t}=e.map.get(i.userId);t.push(i)}else e.map.set(i.userId,{userId:i.userId,sdkAppId:i.sdkAppId,logs:[i]})}return e.map.size>0&&(e.splicedQueue=this.queue_.splice(0,t)),e}async upload(){if(0===this.queue_.length||!this.isAbleToUpload_)return;const{map:e,splicedQueue:t}=this.getLogsToUpload();if(0===e.size)return;try{const t=[...e.values()];for(let e=0;e<t.length;e++){const{userId:i,sdkAppId:s,logs:n}=t[e];await this.uploadLogWithRetry(JSON.stringify({timestamp:Se(),sdkAppId:String(s),userId:i,version:"4.15.1",log:n.map((e=>e.log)).join("\n")}),s),n.forEach((e=>e.uploaded=!0))}}catch(s){}const i=t.filter((e=>!e.uploaded));i.length>0&&(this.queue_=i.concat(this.queue_))}uploadLogWithRetry(e,t){return Po({retryFunction:()=>La({url:da(t,yi),body:e,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(e,t)=>{t()}})()}getPrefix(e){const t=new Date;return t.setTime(fe()),String.prototype.padStart?`[${t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${t.getMilliseconds().toString().padStart(3,"0")}] <${Ks[e]}>`:`[${t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${t.getMilliseconds()}] <${Ks[e]}>`}getLogLevel(){return this.logLevel_}setLogLevel(e){ma(Ks[e])||(this.logLevel_!==e&&this.info(`setLogLevel ${e}`),this.logLevel_=e)}enableUploadLog(){this.enableUploadLog_=!0}disableUploadLog(){this.enableUploadLog_=!1}log({log:e,level:t,forAllJoinedClients:i=!0,userId:s,sdkAppId:n}){if(e=`${this.getPrefix(t)} ${e}`,this.enableUploadLog_&&t>=this.logLevelToUpload_&&this.queue_.push(new No({log:e,level:t,userId:s,sdkAppId:n,forAllJoinedClients:i})),t<this.logLevel_)return;let r=Ks[t]?Ks[t].toLowerCase():"info";Lo?console[r]("%cTRTC%c%s","padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;","display: inline",e):console[r](e)}debug(e){this.log({log:e,level:qs.DEBUG})}info(e){this.log({log:e,level:qs.INFO})}warn(e){this.log({log:e,level:qs.WARN})}error(e){this.log({log:e,level:qs.ERROR})}createLogger(e){return new Mo(e)}checkURLParam(){const e=new URLSearchParams(location.search).get("logLevelToUpload");Ks[e]&&(this.logLevelToUpload_=e)}};let xo=!0;const Vo=1,Uo=5,$o=2,Fo=3,jo=4,Bo="DISCONNECTED",Ho="CONNECTING",Go="RECONNECTING",Jo="CONNECTED",Wo={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772},zo=[Wo.UPDATE_REMOTE_MUTE_STAT,Wo.UPLINK_NETWORK_STATS,Wo.USER_LIST_RES,Wo.MUTE_RESULT],qo={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res"},Ko="publish_change",Qo="publish_state_change",Xo="join",Yo="leave",Zo="quality_report",ec="mute_uplink",tc="publish",ic="unpublish",sc="subscribe",nc="unsubscribe",rc="subscribe_change",ac="start_publishing",oc="stop_publishing",cc="start_push_user_cdn",dc="stop_push_user_cdn",lc="start_mcu_mix",hc="stop_mcu_mix",uc="get_user_list",pc="change_role",_c="update_constraint_config",mc={INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098,DEVICE_NOT_FOUND:4099,INITIALIZE_FAILED:4100,SIGNAL_CHANNEL_SETUP_FAILED:16385,SIGNAL_CHANNEL_ERROR:16386,ICE_TRANSPORT_ERROR:16387,JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,SIGNAL_CHANNEL_RECONNECTION_FAILED:16390,UPLINK_RECONNECTION_FAILED:16391,DOWNLINK_RECONNECTION_FAILED:16392,REMOTE_STREAM_NOT_EXIST:16400,CLIENT_BANNED:16448,SERVER_TIMEOUT:16449,SUBSCRIPTION_TIMEOUT:16450,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,START_PUBLISH_CDN_FAILED:16453,STOP_PUBLISH_CDN_FAILED:16454,START_MIX_TRANSCODE_FAILED:16455,STOP_MIX_TRANSCODE_FAILED:16456,NOT_SUPPORTED_H264:16457,SWITCH_ROLE_FAILED:16458,API_CALL_TIMEOUT:16459,SCHEDULE_FAILED:16460,API_CALL_ABORTED:16461,UNKNOWN:65535};class gc extends Error{constructor({name:e="RtcError",message:t,code:i=mc.UNKNOWN,extraCode:s=0,constraint:n}){const r=`<${function(e){for(let t in mc)if(mc[t]===e)return t;return"UNKNOWN"}(i)} 0x${i.toString(16)}>`;super(t+""+(n?` constraint: ${n}`:"")+(null!=t&&t.includes(r)?"":" "+r)),this.code_=i,this.extraCode_=s,this.name=e,this.message_=t,n&&(this.constraint=n)}getCode(){return this.code_}getExtraCode(){return this.extraCode_}}const fc=32768,Sc=32769,vc=32770,yc=32771,Tc=32772,Ic=32773,bc=32774,Ec=32775,Cc=32777,Rc=32778,kc=32779,wc=32780,Ac=32781,Dc=32782,Pc=32783,Nc=32784,Mc=32785,Lc=32786,Oc=32787,xc=32788,Vc=32789,Uc=32790,$c=32791,Fc=32792,jc=32793,Bc=32794,Hc=32795,Gc=32796,Jc=32797,Wc=32798,zc=32799,qc=32800,Kc=32801,Qc=32802,Xc=32803,Yc=32804,Zc=new Map,ed=function(e,t){let i=Zc.get(e);i||(Zc.set(e,[]),i=Zc.get(e)),i.push(t)};var td=Object.prototype.hasOwnProperty;function id(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(ha(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(td.call(e,t))return!1;return!0}return!1}var sd=new class{constructor(){const{name:e,version:t}=wt();this.roomIdMap_=new Map,this.configs_={sdkAppId:"",userId:"",version:"4.15.1",env:gi,browserVersion:e+t,ua:navigator.userAgent}}setConfig({sdkAppId:e,env:t,userId:i,roomId:s}){e!==this.configs_.sdkAppId&&(this.configs_.sdkAppId=String(e)),this.configs_.env=t,this.configs_.userId=i,this.roomIdMap_.set(i,String(s))}logEvent(e){if(Ct)return;const t={...e,...this.configs_,userId:e.userId||this.configs_.userId};ma(t.code)&&(t.code="failed"===t.result?mc.UNKNOWN:0),this.sendRequest(da(this.configs_.sdkAppId,Ti),t)}logSuccessEvent(e){Ct||(this.logEvent({...e,result:"success",roomId:this.roomIdMap_.get(e.userId)}),this.configs_.env===gi&&this.uploadEventToKibana({...e,result:"success"}))}logFailedEvent(e){if(Ct)return;const{eventType:t,code:i,error:s,userId:n}=e,r={roomId:this.roomIdMap_.get(n),userId:n,eventType:t,result:"failed",code:i||(s instanceof gc?s.getExtraCode()||s.getCode():mc.UNKNOWN)};this.logEvent(r),this.configs_.env===gi&&this.uploadEventToKibana({...r,error:s})}uploadEventToKibana(e){let t=`stat-${e.eventType}-${e.result}`;"delta-join"!==e.eventType&&"delta-leave"!==e.eventType&&"delta-publish"!==e.eventType||(t=`${e.eventType}:${e.delta}`),this.uploadEvent({log:t,userId:e.userId}),"failed"===e.result&&(t=`stat-${e.eventType}-${e.result}-${e.code}`,this.uploadEvent({log:t,userId:e.userId,error:e.error}))}uploadEvent({log:e,userId:t,error:i}){const s={timestamp:Se(),sdkAppId:this.configs_.sdkAppId,userId:t||this.configs_.userId,version:this.configs_.version,log:e};i&&(s.errorInfo=i.message),this.sendRequest(da(this.configs_.sdkAppId,yi),s)}sendRequest(e,t){Oo.getIsAbleToUpload()?La({url:e,body:JSON.stringify(t)}).catch((()=>{})):setTimeout((()=>{this.sendRequest(e,t)}),1e3)}};class nd{constructor(e){this.client_=e.client,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.userSig_=e.userSig,this.url_=e.url,this.backupUrl_=e.backupUrl;const t=`?sdkAppId=${encodeURIComponent(this.sdkAppId_)}&userId=${encodeURIComponent(this.userId_)}&userSig=${encodeURIComponent(this.userSig_)}`;this.urlWithParam_=`${this.url_}${t}`,this.backupUrlWithParam_=`${this.backupUrl_}${t}`,this.isConnected_=!1,this.isConnecting_=!1,this.socketInUse_=null,this.socket_=null,this.backupSocket_=null,this.backupTimer_=-1,this.signalInfo_={},this.currentState_=Bo,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.lastMessageTime_=-1,this.seq_=0,this.log_=Oo.createLogger({id:"ws|"+this.userId_,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.emitter_=new xa}get isOnline(){return this.currentState_===Jo&&Date.now()-this.lastMessageTime_<12e3}connect(){return new Promise(((e,t)=>{this.log_.info(`connect to url: ${this.urlWithParam_}`),this.emitConnectionStateChanged(Ho),this.socket_=new WebSocket(this.urlWithParam_),this.bindSocket(this.socket_),this.backupTimer_=setTimeout((()=>{this.isConnected_||(this.log_.info("trying to connect to backupUrl"),this.tryConnectBackup())}),5e3),this.once(Fo,e),this.once(jo,t)}))}tryConnectBackup(){this.backupSocket_||(this.unbindAndCloseSocket(Xt),this.log_.debug(`try to connect to url: ${this.backupUrlWithParam_}`),this.backupSocket_=new WebSocket(this.backupUrlWithParam_),this.bindSocket(this.backupSocket_))}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}unbindAndCloseSocket(e){if(e===Xt){if(this.socket_){this.unbindSocket(this.socket_);try{this.socket_.close(1e3)}catch(t){}this.socket_=null}}else if(this.backupSocket_){this.unbindSocket(this.backupSocket_);try{this.backupSocket_.close(1e3)}catch(t){}this.backupSocket_=null}}clearBackupTimer(){-1!==this.backupTimer_&&(clearTimeout(this.backupTimer_),this.backupTimer_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1,this.clearBackupTimer(),e.target===this.socket_?(this.unbindAndCloseSocket(Yt),this.socketInUse_=this.socket_):(this.unbindAndCloseSocket(Xt),this.socketInUse_=this.backupSocket_);const t=e.target.url;this.log_.info(`websocket[${t}] is connected`),this.currentState_===Ho?this.addSignalEvent($c,"signal channel is connected"):this.currentState_===Go&&this.addSignalEvent(Hc,"signal channel reconnect success"),this.emitConnectionStateChanged(Jo),this.emitter_.emit(Fo)}onclose(e){const t=e.target.url,i=e.target===this.socketInUse_;this.log_.info(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),e.target===this.socketInUse_&&(this.isConnected_=!1,this.emitConnectionStateChanged(Bo),this.addSignalEvent(Uc,"signal channel is disconnected"),e.wasClean&&1e3===e.code||(this.log_.warn(`onclose code:${e.code} reason:${e.reason}`),this.log_.warn("close current websocket and schedule a reconnect timeout"),this.socketInUse_.onclose=()=>{},this.socketInUse_.close(4011),this.socket_=this.backupSocket_=this.socketInUse_=null,this.reconnect(Xt)))}onerror(e){const t=e.target.url;this.log_.error(`websocket[${t}] error observed`),this.isConnected_?e.target===this.socketInUse_&&(this.isConnected_=!1,this.unbindAndCloseSocket(Xt),this.unbindAndCloseSocket(Yt),this.socketInUse_=null,this.reconnect(Xt)):(this.isReconnecting_||sd.logFailedEvent({userId:this.client_.getUserId(),eventType:cs,code:mc.UNKNOWN}),e.target==this.socket_?(this.unbindAndCloseSocket(Xt),this.reconnect(Yt)):(this.unbindAndCloseSocket(Yt),this.reconnect(Xt))),this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){if(!this.isConnected_)return;this.lastMessageTime_=Date.now();const t=JSON.parse(e.data),{cmd:i,data:s}=t,n=Object.values(Wo),r=Object.keys(Wo)[n.indexOf(i)],a=qo[r];switch(zo.includes(i)||(this.log_.debug(`received msg: ${e.data}`),this.log_.info(`Received event: [ ${a||"unknown cmd: "+i} ]`)),i){case Wo.CHANNEL_SETUP_RESULT:if(0===t.code)this.signalInfo_.clientIp=s.clientIp,this.signalInfo_.signalIp=s.signalInnerIp,this.signalInfo_.tinyId=t.tinyId,s.svrTime&&function(e){me=e,ge=me-(new Date).getTime();const t=new Date;t.setTime(e),Oo.info("baseTime from server: "+t+" offset: "+ge)}(s.svrTime),this.log_.info("ChannelSetup Success"),sd.logSuccessEvent({userId:this.userId_,eventType:cs}),this.emitter_.emit(Vo,{signalInfo:this.signalInfo_});else{const e=new gc({code:mc.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:t.code,message:aa({key:on,data:{errorCode:t.code,errorMsg:t.message}})});this.log_.error(`${t.code}, ${t.message}`),this.close(),sd.logFailedEvent({userId:this.userId_,eventType:cs,error:e}),this.emitter_.emit(Uo,e)}break;case Wo.JOIN_ROOM_RESULT:0===t.code&&(this.signalInfo_.relayIp=s.relayOuterIp,this.signalInfo_.relayInnerIp=s.relayInnerIp,this.signalInfo_.relayPort=s.relayPort,this.log_.info(`signalIp:${this.signalInfo_.signalIp} clientIp:${this.signalInfo_.clientIp} relayIp: ${this.signalInfo_.relayIp}`)),this.emitter_.emit(a,{data:t});break;case Wo.CHANNEL_RECONNECT_RESULT:0===t.code?(this.log_.warn("reconnect success"),this.stopReconnection(),sd.logSuccessEvent({userId:this.userId_,eventType:ds}),this.client_.syncUserList(),this.client_.checkConnectionsToReconnect()):(this.log_.warn(`reconnect failed, ${t.code} ${t.message}`),this.client_.reJoin());break;default:this.emitter_.emit(a,{data:t})}}addSignalEvent(e,t){ed(this.userId_,{eventId:e,eventDesc:t,timestamp:fe(),userId:this.userId_,tinyId:this.signalInfo_.tinyId})}reconnect(e=Xt){if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.log_.info("signal channel is reconnecting, ignoring current reconnection");if(this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect signal channel for 30 times, but all failed. please check your network");const e=new gc({code:mc.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:aa({key:an})});return sd.logFailedEvent({userId:this.client_.getUserId(),eventType:ds,error:e}),this.addSignalEvent(Gc,"signal channel reconnect fail"),void this.emitter_.emit(jo,e)}this.isConnecting_=!0,this.reconnectionCount_++,this.currentState_!==Go&&(this.emitConnectionStateChanged(Go),this.addSignalEvent(Bc,"signal channel is reconnecting")),this.log_.warn(`reconnecting to ${e} signal channel [${this.reconnectionCount_}/30]`);const t=this.getReconnectionUrl(e);e===Xt?(this.socket_=new WebSocket(t),this.bindSocket(this.socket_)):(this.backupSocket_=new WebSocket(t),this.bindSocket(this.backupSocket_));const i=pa(this.reconnectionCount_);this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect ${e} signal channel timeout(${i/1e3}s), close and try again`),this.isConnecting_=!1,this.clearReconnectionTimer(),this.unbindAndCloseSocket(e),this.reconnect(e===Xt?Yt:Xt)}),i)}isConnected(){return this.isConnected_}get isReconnecting_(){return-1!==this.reconnectionTimer_}getReconnectionUrl(e){let t=e===Xt?this.urlWithParam_:this.backupUrlWithParam_;if(!id(this.signalInfo_)&&-1===t.indexOf("&rc=1")){const e=this.client_.getRoomId(),i=this.client_.getUseStringRoomId();t+=`&rc=1&relayInnerIp=${this.signalInfo_.relayInnerIp}&relayOuterIp=${this.signalInfo_.relayIp}&relayPort=${this.signalInfo_.relayPort}&roomId=${e}&useStringRoomId=${i}`}return t}send(e,t={}){if(this.isConnected_){const i={cmd:e,data:t,userId:this.userId_,tinyId:this.signalInfo_.tinyId,seq:++this.seq_};return this.socketInUse_.send(JSON.stringify(i)),i.seq}}sendWaitForResponse({command:e,data:t,timeout:i=5e3,responseCommand:s,commandDesc:n,enableLog:r=!0}){return new Promise(((a,o)=>{const c=setTimeout((()=>{this.off(s,d);const t=new gc({code:mc.API_CALL_TIMEOUT,message:aa({key:rn,data:{commandDesc:n,command:e}})});r&&this.log_.warn(t),o(t)}),i),d=e=>{e.data.seq===l&&(clearTimeout(c),this.off(s,d),a(e))};this.on(s,d);const l=this.send(e,t)}))}sendWaitForResponseWithRetry(...e){const{commandDesc:t,command:i,retries:s=0,retryTimeout:n=0}=e[0];return Po({retryFunction:this.sendWaitForResponse,onRetrying:e=>{this.log_.warn(`${t||i} timeout observed, retrying [${e}/${s}]`)},settings:{retries:s,timeout:n},context:this})(...e)}getCurrentState(){return this.currentState_}getSignalInfo(){return this.signalInfo_}stopReconnection(){this.isReconnecting_&&(this.reconnectionCount_=0,this.clearReconnectionTimer())}close(){this.log_.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this.isConnecting_=!1,this.isConnected_=!1,this.socketInUse_=null,this.unbindAndCloseSocket(Xt),this.unbindAndCloseSocket(Yt),this.emitConnectionStateChanged(Bo)}on(e,t,i){this.emitter_.on(e,t,i)}removeListener(e,t,i){this.emitter_.removeListener(e,t,i)}once(e,t,i){this.emitter_.once(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}emitConnectionStateChanged(e){e!==this.currentState_&&(this.emitter_.emit($o,{prevState:this.currentState_,state:e}),this.currentState_=e)}}var rd={},ad={},od={exports:{}},cd=od.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(cd).forEach((function(e){cd[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))})),function(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,s){var n=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:n&&!i[e.name]&&(i[e.name]={});var r=e.push?{}:n?i[e.name]:i;!function(e,i,s,n){if(n&&!s)i[n]=t(e[1]);else for(var r=0;r<s.length;r+=1)null!=e[r+1]&&(i[s[r]]=t(e[r+1]))}(s.match(e.reg),r,e.names,e.name),e.push&&i[e.push].push(r)},s=od.exports,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},r=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),a=r[r.length-1]);for(var o=0;o<(s[t]||[]).length;o+=1){var c=s[t][o];if(c.reg.test(n))return i(c,a,n)}})),t.media=r,t};var r=function(e,i){var s=i.split(/=(.+)/,2);return 2===s.length?e[s[0]]=t(s[1]):1===s.length&&i.length>1&&(e[s[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(r,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],s=e.split(" ").map(t),n=0;n<s.length;n+=3)i.push({component:s[n],ip:s[n+1],port:s[n+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(r,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,s=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),s=!0),{scid:i,paused:s}}))}))}}(ad);var dd=od.exports,ld=/%[sdv%]/g,hd=function(e){var t=1,i=arguments,s=i.length;return e.replace(ld,(function(e){if(t>=s)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},ud=function(e,t,i){var s=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var r=t.names[n];t.name?s.push(i[t.name][r]):s.push(i[t.names[n]])}else s.push(i[t.name]);return hd.apply(null,s)},pd=["v","o","s","i","u","e","p","c","b","t","r","z","a"],_d=["i","c","b","a"],md=ad,gd=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||pd,s=t.innerOrder||_d,n=[];return i.forEach((function(t){dd[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(ud(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(ud(t,i,e))}))}))})),e.media.forEach((function(e){n.push(ud("m",dd.m[0],e)),s.forEach((function(t){dd[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(ud(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(ud(t,i,e))}))}))}))})),n.join("\r\n")+"\r\n"};rd.write=gd,rd.parse=md.parse,rd.parseParams=md.parseParams,rd.parseFmtpConfig=md.parseFmtpConfig,rd.parsePayloads=md.parsePayloads,rd.parseRemoteCandidates=md.parseRemoteCandidates,rd.parseImageAttributes=md.parseImageAttributes,rd.parseSimulcastStreamList=md.parseSimulcastStreamList;const fd=function(e){return rd.parse(e)},Sd=function(e){return rd.write(e)};var vd,yd,Td,Id;const bd=(null===(vd=window)||void 0===vd?void 0:vd.requestIdleCallback)||function(e){let t=Date.now();return setTimeout((()=>{e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1e3)},Ed=(null===(yd=window)||void 0===yd?void 0:yd.cancelIdleCallback)||function(e){clearTimeout(e)};let Cd=(null===(Td=window)||void 0===Td?void 0:Td.cancelAnimationFrame)||(null===(Id=window)||void 0===Id?void 0:Id.mozCancelAnimationFrame);class Rd{static taskMap=new Map;static currentTaskID=1;static generateTaskID(){return this.currentTaskID++}static run(e="timeout",t,i){i="interval"===e?{delay:2e3,count:0,backgroundTask:!0,...i}:e===Xs?{delay:1e4,count:0,...i}:"raf"===e?{fps:60,delay:16.6,count:0,backgroundTask:!0,...i}:{delay:2e3,count:0,backgroundTask:!0,...i},va(t)&&(i={...i,...t}),_a(e)&&(t=e,e="timeout");let s={taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:e,callback:t,...i};return this.taskMap.set(s.taskID,s),this[e](s),s.taskID}static interval(e){return e.intervalID=setInterval((()=>{e.callback(),e.loopCount+=1,this.isBreakLoop(e)}),e.delay)}static timeout(e){const t=()=>{if(e.callback(),e.loopCount+=1,!this.isBreakLoop(e))return e.timeoutID=setTimeout(t,e.delay)};return e.timeoutID=setTimeout(t,e.delay)}static ric(e){let t,i=Ea();const s=()=>{if(t=Ea()-i,t>=e.delay&&(i=Ea()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.ricID=bd(s,{timeout:e.delay})};return e.ricID=bd(s,{timeout:e.delay})}static raf(e){e.delay=(1e3/e.fps).toFixed(2);let t,i=Ea();const s=()=>{if(document.hidden&&e.backgroundTask){if(t=Ea()-i,i=Ea(),e.callback(),e.loopCount+=1,this.isBreakLoop(e))return;return e.timeoutID=setTimeout(s,e.delay-Math.floor(t%e.delay))}if(t=Ea()-i,t>=e.delay&&(i=Ea()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.rafID=requestAnimationFrame(s)};if(e.rafID=requestAnimationFrame(s),e.backgroundTask){const t=()=>{if(document.hidden){let t=Ea()-i;t>=e.delay?s():e.timeoutID=setTimeout(s,e.delay-t)}};document.addEventListener("visibilitychange",t),e.onVisibilitychange=t,document.hidden&&t()}return e.taskID}static hasTask(e){return this.taskMap.has(e)}static clearTask(e){if(!this.taskMap.has(e))return!0;const{intervalID:t,timeoutID:i,rafID:s,ricID:n,onVisibilitychange:r}=this.taskMap.get(e);return t&&clearInterval(t),i&&clearTimeout(i),s&&Cd(s),n&&Ed(n),r&&document.removeEventListener("visibilitychange",r),this.taskMap.delete(e),!0}static isBreakLoop(e){return!this.taskMap.has(e.taskID)||0!==e.count&&e.loopCount>=e.count&&(this.clearTask(e.taskID),!0)}}var kd=new class{constructor(){this.prefix_="TRTC",this.queue_=new Map,this.checkStorage()}getRealKey(e){return`${this.prefix_}_${e}`}checkStorage(){if(!Rt())return;Object.keys(localStorage).filter((e=>{if(e.startsWith(this.prefix_)){const t=JSON.parse(localStorage.getItem(e));if(t&&t.expiresIn<Date.now())return!0}return!1})).forEach((e=>localStorage.removeItem(e)))}doFlush(){if(Rt())try{for(const[e,t]of this.queue_)localStorage.setItem(e,JSON.stringify(t))}catch(e){Oo.warn(e)}}getItem(e){if(!Rt())return null;try{const t=JSON.parse(localStorage.getItem(this.getRealKey(e)));return t&&t.expiresIn>=Date.now()?t.value:null}catch(t){Oo.warn(t)}}setItem(e,t,i=!1){if(Rt())try{const s={expiresIn:Date.now()+6048e5,value:t};i?localStorage.setItem(this.getRealKey(e),JSON.stringify(s)):(this.queue_.set(this.getRealKey(e),s),Rd.hasTask(this.intervalId_)||(this.intervalId_=Rd.run(Xs,this.doFlush.bind(this),{count:1})))}catch(s){Oo.warn(s)}}deleteItem(e){if(!Rt())return!1;try{return e=this.getRealKey(e),this.queue_.delete(e),localStorage.removeItem(e),!0}catch(t){return Oo.warn(t),!1}}clear(){if(Rt())try{localStorage.clear()}catch(e){Oo.warn(e)}}};let wd={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}};const Ad=function(){return!tt&&!Ae&&(!(Pe&&Ne<80)&&!(ke&&we<56))},Dd=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((e=>e in window)).length>0},Pd=async function(){if(wd.detail.isH264EncodeSupported&&wd.detail.isVp8EncodeSupported)return{isH264EncodeSupported:wd.detail.isH264EncodeSupported,isVp8EncodeSupported:wd.detail.isVp8EncodeSupported};let e="",t=!1,i=!1;try{const s=new RTCPeerConnection,n=document.createElement(At);n.getContext("2d");const r=n.captureStream(0);return s.addTrack(r.getVideoTracks()[0],r),e=await s.createOffer(),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),s.close(),wd.detail.isH264EncodeSupported=t,wd.detail.isVp8EncodeSupported=i,{isH264EncodeSupported:wd.detail.isH264EncodeSupported,isVp8EncodeSupported:wd.detail.isVp8EncodeSupported}}catch(s){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}};const Nd=async function(){if(wd.detail.isH264DecodeSupported&&wd.detail.isVp8DecodeSupported)return{isH264DecodeSupported:wd.detail.isH264DecodeSupported,isVp8DecodeSupported:wd.detail.isVp8DecodeSupported};let e="",t=!1,i=!1;try{const s=new RTCPeerConnection;return e=await s.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),s.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:i}}catch(s){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}},Md=((e,t)=>{let i=null;return function(...s){return i||(i=e.apply(t||this,s),i.then((e=>(i=null,e))).catch((e=>{throw i=null,e})),i)}})((async function(){if(!Ld())return wd;const e=Ad(),t=Dd(),i=function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter((e=>e in navigator.mediaDevices)).length===e.length}();let{isH264EncodeSupported:s,isVp8EncodeSupported:n}=await Pd(),{isH264DecodeSupported:r,isVp8DecodeSupported:a}=await Nd();if(!s||!n){const e=await Pd();s=e.isH264EncodeSupported,n=e.isVp8EncodeSupported}if(s&&r&&(dt||ht||yt)&&!Ve&&pt()<79){const{encode:e,decode:t}=await async function(){return new Promise((async e=>{const t={encode:!1,decode:!1};let i=null;try{const s=document.createElement("canvas"),n=s.getContext("2d");s.width=640,s.height=480;const r=setInterval((()=>{n.fillText("test",Math.floor(640*Math.random()),Math.floor(480*Math.random()))}),33);let a=-1,o=-1;i=()=>{clearInterval(a),clearInterval(r),clearTimeout(o),d.close(),l.close(),c.getTracks().forEach((e=>e.stop()))},o=setTimeout((()=>{i(),e(t)}),3e3);const c=s.captureStream(),d=new RTCPeerConnection({}),l=new RTCPeerConnection({offerToReceiveAudio:!0,offerToReceiveVideo:!0});d.addEventListener("icecandidate",(e=>l.addIceCandidate(e.candidate))),l.addEventListener("icecandidate",(e=>d.addIceCandidate(e.candidate))),d.addTrack(c.getVideoTracks()[0],c);const h=await d.createOffer();await d.setLocalDescription(h),await l.setRemoteDescription(h);const u=await l.createAnswer(),p=fd(u.sdp),_=p.media[0].rtp.findIndex((e=>"H264"===e.codec));p.media[0].rtp=[p.media[0].rtp[_]],p.media[0].fmtp=p.media[0].fmtp.filter((e=>e.payload===p.media[0].rtp[0].payload)),p.media[0].rtcpFb=p.media[0].rtcpFb.filter((e=>e.payload===p.media[0].rtp[0].payload)),u.sdp=Sd(p),await l.setLocalDescription(u),await d.setRemoteDescription(u),a=setInterval((async()=>{t.encode&&t.decode&&(i(),e(t));const s=await d.getStats(),n=await l.getStats();t.encode||s.forEach((e=>{"outbound-rtp"===e.type&&e.mediaType===Pt&&e.framesEncoded>0&&(t.encode=!0)})),t.decode||n.forEach((e=>{"inbound-rtp"===e.type&&e.mediaType===Pt&&e.framesDecoded>0&&(t.decode=!0)}))}),500)}catch(s){i(),Oo.warn(s),e(t)}}))}();s=e,r=t}return wd.result=e&&t&&i&&(s||n)&&(r||a),wd.detail.isBrowserSupported=e,wd.detail.isWebRTCSupported=t,wd.detail.isMediaDevicesSupported=i,wd.detail.isH264EncodeSupported=s,wd.detail.isVp8EncodeSupported=n,wd.detail.isH264DecodeSupported=r,wd.detail.isVp8DecodeSupported=a,Ld()&&(Oo.warn(aa({key:Nr})),Oo.info(`${navigator.userAgent} ${JSON.stringify(wd.detail)}`)),kd.setItem("checkResult",{ua:navigator.userAgent,checkResult:wd},!0),wd}));function Ld(){return Object.keys(wd.detail).findIndex((e=>!wd.detail[e]))>=0}function Od(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)}function xd(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function Vd(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function Ud(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function $d(){return"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype}function Fd(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function jd(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&Vd()}function Bd(){return!!ma(navigator.mediaDevices)&&(Oo.error(sa.NOT_SUPPORTED_MEDIA),!0)}function Hd(){return"http:"===location.protocol&&!Ct&&(Oo.warn(aa({key:Pr})),!0)}const Gd="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&pt()>=86;function Jd(e){return!("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state)&&!(Sa(e.selected)&&!e.selected)}let Wd=new Map([[Re,"Android"],[Ce,"iOS"],[Ye,"Windows"],[Ze,"MacOS"],[et,"Linux"]]);function zd(){let e="unknown";return Wd.get(!0)&&(e=Wd.get(!0)),e}function qd(){let e="";if(screen.width){e+=(screen.width?screen.width*window.devicePixelRatio:"")+" * "+(screen.height?screen.height*window.devicePixelRatio:"")}return e}function Kd(){let e=!1;return(navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(e=!0),e}function Qd(){let e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function Xd(){return!(je||Ce||gt&&gt<63)&&!(!Ad()||!("captureStream"in HTMLCanvasElement.prototype))}function Yd(){const e={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return ma(window.AudioDecoder)||(e.AudioDecoder=!0),ma(window.AudioEncoder)||(e.AudioEncoder=!0),ma(window.VideoDecoder)||(e.VideoDecoder=!0),ma(window.VideoEncoder)||(e.VideoEncoder=!0),ma(window.ImageDecoder)||(e.ImageDecoder=!0),e}const Zd=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,el=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype;!function(){Hd();const e=kd.getItem("checkResult");e&&e.ua===navigator.userAgent&&(wd=e.checkResult),Md()}();const tl={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:si},il={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:si,ERROR:"error"},sl="player-state-changed",nl="screen-sharing-stopped",rl="connection-state-changed",al="device-auto-recovered",ol="error",cl="player-state-changed";class dl{constructor(e){const t=e.getUserId();this.log_=Oo.createLogger({id:t,userId:t,sdkAppId:e.getSDKAppId()}),this.prevReportTime_=0,this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_="",this.prevDecoderImplementationMap_=new Map}get statInterval(){return 0===this.prevReportTime_?2:(Date.now()-this.prevReportTime_)/1e3}async getSenderStats(e){const t={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},i=e.getPeerConnection(),s=e.getSSRC();if(i)try{(await i.getStats()).forEach((i=>{if("outbound-rtp"===i.type)if(i.mediaType===Pt){if(!ke&&ma(i.trackId))return;i.ssrc!==s.video||ma(i.encoderImplementation)||this.prevEncoderImplementation_===i.encoderImplementation||(this.log_.info(`encoderImplementation change to ${i.encoderImplementation}`),this.prevEncoderImplementation_=i.encoderImplementation),i.ssrc!==s.video||ma(i.qualityLimitationReason)||this.prevQualityLimitationReason_===i.qualityLimitationReason||(this.log_.info(`qualityLimitationReason change to ${i.qualityLimitationReason}`),this.prevQualityLimitationReason_=i.qualityLimitationReason);let e=Pt;i.ssrc===s.small?e=Mt:i.ssrc===s.auxiliary&&(e=Ot),t[e].bytesSent=i.bytesSent,t[e].packetsSent=i.packetsSent,t[e].framesEncoded=i.framesEncoded}else i.mediaType===Dt&&(t.audio.bytesSent=i.bytesSent,t.audio.packetsSent=i.packetsSent);else if("candidate-pair"===i.type)Jd(i)&&fa(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime));else if("track"===i.type){if(!ma(i.frameWidth)){let s=Mt;i.trackIdentifier===e.getVideoTrackId(Pt)?s=Pt:i.trackIdentifier===e.getVideoTrackId(Ot)&&(s=Ot),t[s].frameWidth=i.frameWidth,t[s].frameHeight=i.frameHeight,t[s].framesSent=i.framesSent}if(ma(i.audioLevel)){if(St){var n;t.audio.audioLevel=(null===(n=e.getLocalStream())||void 0===n?void 0:n.getInternalAudioLevel())||0}}else t.audio.audioLevel=i.audioLevel||0}else"media-source"===i.type&&(i.kind===Dt?(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0):i.kind===Pt&&(i.trackIdentifier===e.getVideoTrackId(Pt)?t.video.fpsCapture=i.framesPerSecond:i.trackIdentifier===e.getVideoTrackId(Ot)?t.auxiliary.fpsCapture=i.framesPerSecond:t.small.fpsCapture=i.framesPerSecond))}))}catch(n){this.log_.warn("failed to getStats on sender connection "+n)}return t}async getReceiverStats(e){const t={tinyId:e.getTinyId(),userId:e.getUserId(),rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0}},i=e.getPeerConnection();if(i)try{const s=e.getSSRC(),n=e.getTrackState();(await i.getStats()).forEach((i=>{if("inbound-rtp"===i.type){if(i.mediaType===Dt&&i.ssrc===s.audio&&n.audio)t.audio.packetsReceived=i.packetsReceived,t.audio.bytesReceived=i.bytesReceived,t.audio.packetsLost=i.packetsLost,t.audio.jitter=i.jitter,t.hasAudio=!0;else if(i.mediaType===Pt){if(ke&&0===i.bytesReceived)return;i.ssrc===s.video&&n.video&&(t.video.packetsReceived=i.packetsReceived,t.video.bytesReceived=i.bytesReceived,t.video.packetsLost=i.packetsLost,t.video.framesReceived=i.framesReceived,t.video.framesDecoded=i.framesDecoded,t.video.fpsDecoded=i.framesPerSecond,t.hasVideo=!0,!i.decoderImplementation||this.prevDecoderImplementationMap_.has(t.userId)&&this.prevDecoderImplementationMap_.get(t.userId)===i.decoderImplementation||(this.log_.info(`${t.userId} decoderImplementation change to ${i.decoderImplementation}`),this.prevDecoderImplementationMap_.set(t.userId,i.decoderImplementation))),i.ssrc===s.auxiliary&&n.auxiliary&&(t.auxiliary.packetsReceived=i.packetsReceived,t.auxiliary.bytesReceived=i.bytesReceived,t.auxiliary.packetsLost=i.packetsLost,t.auxiliary.framesReceived=i.framesReceived,t.auxiliary.framesDecoded=i.framesDecoded,t.auxiliary.fpsDecoded=i.framesPerSecond,t.hasAuxiliary=!0)}}else"track"===i.type?(ma(i.frameWidth)||(i.trackIdentifier===e.getMainStreamVideoTrackId()&&(t.video.frameWidth=i.frameWidth,t.video.frameHeight=i.frameHeight),i.trackIdentifier===e.getAuxStreamVideoTrackId()&&(t.auxiliary.frameWidth=i.frameWidth,t.auxiliary.frameHeight=i.frameHeight)),ma(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0)):"candidate-pair"===i.type&&Jd(i)&&fa(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime))}))}catch(s){this.log_.warn("failed to getStats on receiver connection "+s)}return t}async getStats(e,t){let i={};e&&(i=await this.getSenderStats(e));const s=[];for(let[n,r]of t){const e=await this.getReceiverStats(r);s.push(e)}return{senderStats:i,receiverStats:s}}getDifferenceValue(e,t){if(id(e))return t;const i=t-e;return i<0?0:i}prepareReport({stats:e,report:t,freezeMap:i}){if(!id(e.senderStats)){let i;i={uint32_audio_level:1e8*e.senderStats.audio.audioLevel,uint32_audio_energy:1e6*e.senderStats.audio.totalAudioEnergy,uint32_audio_codec_bitrate:e.senderStats.audio.bytesSent,audioLevel:e.senderStats.audio.audioLevel};let s=[],n={uint32_video_stream_type:2,uint32_video_codec_fps:e.senderStats.video.framesSent,uint32_video_capture_fps:e.senderStats.video.fpsCapture,uint32_video_width:e.senderStats.video.frameWidth,uint32_video_height:e.senderStats.video.frameHeight,uint32_video_codec_bitrate:e.senderStats.video.bytesSent,uint32_video_enc_fps:e.senderStats.video.framesEncoded};if(s.push(n),e.senderStats.small.bytesSent){let t={uint32_video_stream_type:3,uint32_video_codec_fps:e.senderStats.small.framesSent||0,uint32_video_capture_fps:e.senderStats.small.fpsCapture||0,uint32_video_width:e.senderStats.small.frameWidth||0,uint32_video_height:e.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:e.senderStats.small.bytesSent,uint32_video_enc_fps:e.senderStats.small.framesEncoded||0};s.push(t)}if(e.senderStats.auxiliary.bytesSent){let t={uint32_video_stream_type:7,uint32_video_codec_fps:e.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:e.senderStats.auxiliary.fpsCapture||0,uint32_video_width:e.senderStats.auxiliary.frameWidth||0,uint32_video_height:e.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:e.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:e.senderStats.auxiliary.framesEncoded||0};s.push(t)}let r={uint32_bitrate:0,uint32_rtt:e.senderStats.rtt};t.msg_up_stream_info={msg_audio_status:i,msg_video_status:s,msg_network_status:r}}const s=this.statInterval;t.msg_down_stream_info=[],e.receiverStats.forEach((e=>{const s={};if(s.msg_user_info={str_identifier:e.userId,uint64_tinyid:e.tinyId},s.msg_network_status={uint32_rtt:e.rtt},s.msg_video_status={},e.hasAudio){const t={uint32_audio_codec_bitrate:e.audio.bytesReceived,uint32_audio_total_bitrate:e.audio.bytesReceived,uint32_audio_level:1e8*e.audio.audioLevel,uint32_audio_energy:1e6*e.audio.totalAudioEnergy,uint32_audio_receive:e.audio.packetsReceived,uint32_audio_origin_lost:e.audio.packetsLost,audioLevel:e.audio.audioLevel};s.msg_audio_status=t}if(s.msg_video_status=[],e.hasVideo){const t=i.get(e.userId+"_"+Pi),n=t?t.duration:0,r={uint32_video_stream_type:2,uint32_video_receive_fps:e.video.framesReceived,uint32_video_width:e.video.frameWidth,uint32_video_height:e.video.frameHeight,uint32_video_codec_bitrate:e.video.bytesReceived,uint32_video_receive:e.video.packetsReceived,uint32_video_origin_lost:e.video.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.video.framesDecoded};s.msg_video_status.push(r)}if(e.hasAuxiliary){const t=i.get(e.userId+"_"+Ni),n=t?t.duration:0,r={uint32_video_stream_type:7,uint32_video_receive_fps:e.auxiliary.framesReceived,uint32_video_width:e.auxiliary.frameWidth,uint32_video_height:e.auxiliary.frameHeight,uint32_video_codec_bitrate:e.auxiliary.bytesReceived,uint32_video_receive:e.auxiliary.packetsReceived+e.auxiliary.packetsLost,uint32_video_origin_lost:e.auxiliary.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.auxiliary.framesDecoded};s.msg_video_status.push(r)}t.msg_down_stream_info.push(s)}));const n=this.prevReport_;if(this.prevReport_=JSON.parse(JSON.stringify(t)),t.msg_up_stream_info.msg_audio_status&&n.msg_up_stream_info.msg_audio_status){const e=n.msg_up_stream_info.msg_audio_status,i=t.msg_up_stream_info.msg_audio_status,r=this.getDifferenceValue(e.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*r/s),t.msg_up_stream_info.msg_network_status.uint32_bitrate+=i.uint32_audio_codec_bitrate}const r=n.msg_up_stream_info.msg_video_status;t.msg_up_stream_info.msg_video_status.forEach((e=>{const i=r.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!i||0===i.uint32_video_codec_bitrate)return e.uint32_video_codec_bitrate=0,e.uint32_video_enc_fps=0,void(e.uint32_video_codec_fps=0);let n=i.uint32_video_codec_bitrate,a=i.uint32_video_enc_fps,o=i.uint32_video_codec_fps;const c=this.getDifferenceValue(n,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*c/s),t.msg_up_stream_info.msg_network_status.uint32_bitrate+=e.uint32_video_codec_bitrate,e.uint32_video_enc_fps=Math.round(this.getDifferenceValue(a,e.uint32_video_enc_fps)/s),e.uint32_video_codec_fps=Math.round(this.getDifferenceValue(o,e.uint32_video_codec_fps)/s)}));const a=t.msg_down_stream_info,o=n.msg_down_stream_info;return a.forEach((e=>{const t=o.find((t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid));if(t){if(e.msg_audio_status&&t.msg_audio_status){const i=e.msg_audio_status,n=t.msg_audio_status;i.uint32_audio_origin_lost=this.getDifferenceValue(n.uint32_audio_origin_lost,i.uint32_audio_origin_lost),i.uint32_audio_receive=this.getDifferenceValue(n.uint32_audio_receive,i.uint32_audio_receive),i.uint32_audio_receive+=i.uint32_audio_origin_lost;const r=this.getDifferenceValue(n.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*r/s),i.uint32_audio_total_bitrate=Math.round(8*r/s)}if(e.msg_video_status&&t.msg_video_status){const i=e.msg_video_status,n=t.msg_video_status;i.forEach((e=>{const t=n.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!t)return e.uint32_video_receive=0,e.uint32_video_origin_lost=0,e.uint32_video_codec_bitrate=0,e.uint32_video_receive_fps=0,void(e.uint32_video_dec_fps=0);let i=t.uint32_video_receive,r=t.uint32_video_origin_lost,a=t.uint32_video_codec_bitrate,o=t.uint32_video_receive_fps,c=t.uint32_video_dec_fps;e.uint32_video_origin_lost=this.getDifferenceValue(r,e.uint32_video_origin_lost),e.uint32_video_receive=this.getDifferenceValue(i,e.uint32_video_receive)+e.uint32_video_origin_lost;const d=this.getDifferenceValue(a,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*d/s);const l=this.getDifferenceValue(o,e.uint32_video_receive_fps);e.uint32_video_receive_fps=Math.round(l/s),e.uint32_video_dec_fps=Math.round(this.getDifferenceValue(c,e.uint32_video_dec_fps)/s)}))}}})),t}async getStatsReport({uplinkConnection:e,downlinkConnections:t,freezeMap:i}){const s={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:""},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0,uint32_jitter:0}}]},n=await this.getStats(e,t);return"{}"===JSON.stringify(this.prevReport_)&&(this.prevReport_=JSON.parse(JSON.stringify(s))),this.prepareReport({stats:n,report:s,freezeMap:i,uplinkConnection:e,downlinkConnections:t}),this.prevReportTime_=Date.now(),s}reset(){this.prevReportTime_=0,this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_="",this.prevDecoderImplementationMap_=new Map}}class ll{constructor({signalChannel:e,connections:t,client:i}){this.client_=i,this.signalChannel_=e,this.connections_=t,this.client_=i,this.log_=Oo.createLogger({id:"q|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),this.uplinkConnection_=null,this.uplinkNetworkQuality_=0,this.uplinkRTT_=0,this.uplinkLoss_=0,this.downlinkNetworkQuality_=0,this.downlinkRTT_=0,this.downlinkLoss_=0,this.downlinkPrevStatMap_=new Map,this.downlinkLossAndRTTMap_=new Map,this.interval_=-1,this.emitter_=new xa,this.initialize()}get uplinkNetworkQuality(){return this.uplinkNetworkQuality_}set uplinkNetworkQuality(e){e!==this.uplinkNetworkQuality_&&this.log_.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this.uplinkRTT_}, loss: ${this.uplinkLoss_}`),this.uplinkNetworkQuality_=e}get downlinkNetworkQuality(){return this.downlinkNetworkQuality_}set downlinkNetworkQuality(e){if(e!==this.downlinkNetworkQuality_){const{rtt:t,loss:i}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.log_.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${t}, loss: ${i}`)}this.downlinkNetworkQuality_=e}initialize(){this.signalChannel_.on(qo.UPLINK_NETWORK_STATS,(e=>{this.handleUplinkNetworkQuality(e)})),this.signalChannel_.on($o,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){if(!this.uplinkConnection_)return this.uplinkNetworkQuality=0,this.uplinkLoss_=0,void(this.uplinkRTT_=0);const t=this.uplinkConnection_.getPeerConnection();if(t&&this.isPeerConnectionDisconnected(t))return this.uplinkNetworkQuality=6,this.uplinkLoss_=0,void(this.uplinkRTT_=0);if(0===e.data.code){const t=e.data.data,i=t.expectAudPkg+t.expectVidPkg,s=t.recvAudPkg+t.recvVidPkg,n=i-s,r=t.delay;if(r&&this.updateDelay(r),0===i&&0===s)return;this.uplinkLoss_=n<=0?0:Math.round(n/i*100),this.uplinkRTT_=t.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this.uplinkLoss_,this.uplinkRTT_)}}async handleDownlinkNetworkQuality(){if(!this.connections_||0===this.connections_.size)return void(this.downlinkNetworkQuality=0);const e=[...this.connections_.values()],t=e.filter((e=>e.getPeerConnection()&&e.getPeerConnection().connectionState===Bi));if(e.filter((e=>e.getPeerConnection()&&this.isPeerConnectionDisconnected(e.getPeerConnection()))).length===e.length)return void(this.downlinkNetworkQuality=6);for(let n=0;n<t.length;n++){const e=t[n].getPeerConnection(),{rtt:i,totalPacketsLost:s,totalPacketsReceived:r}=await this.getStat(e);if(!this.downlinkPrevStatMap_.has(e)){this.downlinkPrevStatMap_.set(e,{totalPacketsLost:s,totalPacketsReceived:r});continue}let a=0;const o=this.downlinkPrevStatMap_.get(e),c=s-o.totalPacketsLost,d=r-o.totalPacketsReceived;a=c<=0||d<0?0:Math.round(c/(c+d)*100),this.downlinkPrevStatMap_.set(e,{totalPacketsLost:s,totalPacketsReceived:r}),this.downlinkLossAndRTTMap_.set(e,{rtt:i,loss:a,userId:t[n].getUserId()})}if([...this.downlinkPrevStatMap_.keys()].forEach((e=>{this.isPeerConnectionDisconnected(e)&&(this.downlinkPrevStatMap_.delete(e),this.downlinkLossAndRTTMap_.delete(e))})),0===this.downlinkLossAndRTTMap_.size)return;const{rtt:i,loss:s}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.downlinkRTT_=i,this.downlinkLoss_=s,this.downlinkNetworkQuality=this.getNetworkQuality(s,i)}async getStat(e){const t={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!xd())return t;const i=e.getReceivers();try{for(let e=0;e<i.length;e++){const s=i[e];(await s.getStats()).forEach((e=>{"candidate-pair"===e.type&&fa(e.currentRoundTripTime)&&(t.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"!==e.type||e.mediaType!==Dt&&e.mediaType!==Pt||(t.totalPacketsLost+=e.packetsLost,t.totalPacketsReceived+=e.packetsReceived)}))}return t}catch(s){return t}}getAverageLossAndRTT(e){const t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach((e=>{t.rtt+=e.rtt,t.loss+=e.loss})),Object.keys(t).forEach((i=>{t[i]=Math.round(t[i]/e.length)}))),t}getNetworkQuality(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}handleSignalConnectionStateChange(e){e.state===Bo?(this.uplinkRTT_=0,this.uplinkLoss_=0,this.uplinkNetworkQuality=6):e.state===Jo&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e===Mi?(this.uplinkLoss_=0,this.uplinkRTT_=0,this.uplinkNetworkQuality=6):e===xi&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!(!e||e.connectionState!==ji&&e.connectionState!==$i&&e.connectionState!==Fi)}setUplinkConnection(e){this.uplinkConnection_=e,this.uplinkConnection_?this.uplinkConnection_.on(tl.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this.uplinkRTT_=0,this.uplinkLoss_=0)}start(){-1===this.interval_?(this.log_.info("start network quality calculating"),this.interval_=Rd.run(Xs,(()=>{this.handleDownlinkNetworkQuality(),Va.emit(ko,{client:this.client_,uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_,downlinkLossAndRTTMap:this.downlinkLossAndRTTMap_}),this.emitter_.emit(il.NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_})}),{delay:2e3})):this.log_.info("network quality calculating is already started")}stop(){this.log_.info("stop network quality calculating"),-1!==this.interval_&&(Rd.clearTask(this.interval_),this.interval_=-1),this.downlinkLossAndRTTMap_.clear(),this.downlinkPrevStatMap_.clear()}on(e,t){this.emitter_.on(e,t)}updateDelay(e){e.forEach((({srcTinyId:e,videoDelay:t,audioDelay:i})=>{const s=this.connections_.get(e);s&&s.setDelay({videoDelay:t,audioDelay:i})}))}}class hl{constructor(e){this.log_=Oo.createLogger({id:e.client.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.localStream_=null,this.prevDevices_=[],this.initialize()}initialize(){navigator.mediaDevices&&(this.onDeviceChange=this.onDeviceChange.bind(this),navigator.mediaDevices.addEventListener("devicechange",this.onDeviceChange))}destroy(){navigator.mediaDevices&&navigator.mediaDevices.removeEventListener("devicechange",this.onDeviceChange)}async onDeviceChange(){if(!this.localStream_||!this.localStream_.getMediaStream()||this.localStream_.getScreen())return;const e=await ou.getDevices(),t=e.filter((e=>this.prevDevices_.findIndex((({deviceId:t})=>e.deviceId===t))<0)),i=this.prevDevices_.filter((t=>e.findIndex((({deviceId:e})=>t.deviceId===e))<0));t.length>0&&this.handleDeviceAdded(this.prevDevices_,t),i.length>0&&this.handleDeviceRemoved(e,i),this.prevDevices_=e}async setLocalStream(e){e&&(this.prevDevices_=await ou.getDevices()),this.localStream_=e}handleDeviceAdded(e,t){var i,s;if(!this.localStream_)return;this.log_.warn(`devicesAdded: ${JSON.stringify(t)}`),this.localStream_.updateDeviceIdInUse();const n=t.filter((({kind:e})=>e===qt)),r=t.filter((({kind:e})=>e===zt)),a=e.filter((({kind:e})=>e===qt)),o=e.filter((({kind:e})=>e===zt)),c=n.length>0&&0===a.length&&"live"!==(null===(i=this.localStream_.getVideoTrack())||void 0===i?void 0:i.readyState),d=r.length>0&&0===o.length&&"live"!==(null===(s=this.localStream_.getAudioTrack())||void 0===s?void 0:s.readyState);if(d&&c)return this.log_.info("new microphone and camera detected, but there was no device before."),void this.localStream_.recoverCapture({audio:!0,video:!0,cameraId:n[0].deviceId,microphoneId:r[0].deviceId});c&&(this.log_.info("new camera detected, but there was no camera before."),this.localStream_.recoverCapture({audio:!1,video:!0,cameraId:n[0].deviceId})),d&&(this.log_.info("new microphone detected, but there was no microphone before."),this.localStream_.recoverCapture({audio:!0,video:!1,microphoneId:r[0].deviceId}))}handleDeviceRemoved(e,t){if(!this.localStream_)return;this.log_.warn(`devicesRemoved: ${JSON.stringify(t)}`),this.localStream_.updateDeviceIdInUse();let i=!1,s=!1;const n=this.localStream_.getCameraId(),r=this.localStream_.getMicrophoneId();if("default"===r){const t=this.localStream_.getMicrophoneGroupId(),i=e.filter((e=>"default"===e.deviceId&&e.kind===zt))[0];i&&i.groupId!==t&&(s=!0)}if(t.forEach((({deviceId:e})=>{n.length>0&&e===n?i=!0:r.length>0&&e===r&&(s=!0)})),i&&s)return this.log_.warn(`current camera and microphone in use is lost, cameraId: ${n}, microphoneId: ${r}`),void((this.localStream_.getAudio()||this.localStream_.getVideo())&&this.localStream_.recoverCapture({video:!0,audio:!0}));i&&(this.log_.warn(`current camera in use is lost, deviceId: ${n}`),this.localStream_.getVideo()&&this.localStream_.recoverCapture({video:!0,audio:!1})),s&&(this.log_.warn(`current microphone in use is lost, deviceId: ${r}`),this.localStream_.getAudio()&&this.localStream_.recoverCapture({video:!1,audio:!0}))}}let ul,pl,_l=new Blob(["class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=Math.max(rms,this.volume*0.95);this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);"],{type:"application/javascript"}),ml=!1;class gl{constructor(e){this.context_=e.context,this.addModuleToContext()}async addModuleToContext(){try{await this.context_.audioWorklet.addModule(URL.createObjectURL(_l)),Oo.info("worklet addModule success"),Va.emit(Ao),ml=!0}catch(e){Oo.info(`worklet addModule catch error. ${e.message}`),Va.emit(Do)}}get initWorkletSuccess(){return ml}}let fl=0;class Sl{constructor(e){const{track:t,log:i,stream:s}=e;this.volume_=0,this.log_=i,this.track_=t,this.stream_=s,ul||(ul=wa()),this.audioCtx_=ul,this.destination_=this.audioCtx_.destination;const n=new MediaStream;n.addTrack(this.track_),this.streamSource_=this.audioCtx_.createMediaStreamSource(n),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.interval_=200,Va.on(wo,this.resume,this),Va.on(eo,this.handleAudioLevelInterval,this),Da?(Va.on(Ao,this.initAudioWorklet,this),Va.on(Do,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor(),fl+=1}preload(){pl?pl.initWorkletSuccess&&this.initAudioWorklet():pl=new gl({context:ul})}initAudioWorklet(){if(!this.audioWorkletNode_)try{this.audioWorkletNode_=new AudioWorkletNode(this.audioCtx_,"volume-meter"),this.audioWorkletNode_.port.onmessage=e=>{this.volume_=e.data.volume||0},this.streamSource_.connect(this.audioWorkletNode_).connect(this.destination_),this.handleAudioLevelInterval({interval:this.interval_}),sd.logSuccessEvent({userId:this.stream_.getUserId(),eventType:gs})}catch(e){sd.logFailedEvent({userId:this.stream_.getUserId(),eventType:gs}),this.initScriptProcessor()}}initScriptProcessor(){if(!this.scriptProcessorNode_)try{this.scriptProcessorNode_=this.audioCtx_.createScriptProcessor(2048,1,1),this.scriptProcessorNode_.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);let i=0;for(let s=0;s<t.length;++s)i+=t[s]*t[s];this.volume_=Math.sqrt(i/t.length)||0},this.streamSource_.connect(this.scriptProcessorNode_),this.scriptProcessorNode_.connect(this.destination_)}catch(e){this.log_.error("volumeMeter init script processor error: "+e)}}destroy(){var e;(this.streamSource_&&this.streamSource_.disconnect(),this.scriptProcessorNode_&&(this.scriptProcessorNode_.onaudioprocess=null,this.scriptProcessorNode_.disconnect()),this.audioWorkletNode_&&(this.audioWorkletNode_.port.postMessage({name:"stop"}),this.audioWorkletNode_.port.onmessage=null,this.audioWorkletNode_.disconnect()),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.audioCtx_=null,Va.off(wo,this.resume,this),Va.off(eo,this.handleAudioLevelInterval,this),Va.off(Ao,this.initAudioWorklet,this),Va.off(Do,this.initScriptProcessor,this),fl>0&&(fl-=1),0===fl)&&(null===(e=ul)||void 0===e||e.close(),ul=null,pl=null)}resume(){var e;null===(e=ul)||void 0===e||e.resume()}getInternalAudioLevel(){return this.volume_}getCalculatedVolume(){return this.volume_.toFixed(2)}handleAudioLevelInterval({interval:e}){var t;this.interval_=e,null===(t=this.audioWorkletNode_)||void 0===t||t.port.postMessage({name:"setIntervalTime",intervalTime:e})}}class vl{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,e.gainedTrack&&(this.gainedTrack_=e.gainedTrack),this.div_=e.div,this.muted_=e.muted,this.outputDeviceId_=e.outputDeviceId,this.volume_=e.volume,this.pausedRetryCount_=5,this.emitter_=new xa,this.initializeElement(),this.state_="NONE",this.volumeMeter_=new Sl({stream:this.stream_,track:this.gainedTrack_||this.track_,log:this.log_})}get isPlaying(){return this.state_===ni}initializeElement(){if(this.isAudioElementInit()){const e=new MediaStream;e.addTrack(this.gainedTrack_||this.track_);const t=document.createElement(Dt);t.srcObject=e,t.muted=this.muted_,t.setAttribute("id",`audio_${this.stream_.getId()}`),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_.appendChild(t),this.element_=t}this.handleEvents()}setMuted(e){this.element_&&(this.element_.muted=e,this.muted_=e)}async play(){this.outputDeviceId_&&this.element_&&await this.element_.setSinkId(this.outputDeviceId_),this.setVolume(this.volume_);try{this.element_&&await this.element_.play()}catch(e){const t=aa({key:Rr,data:{media:"Audio",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new gc({code:mc.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_&&(this.element_.addEventListener(Ht,this.handleElementEvent),this.element_.addEventListener(Bt,this.handleElementEvent),this.element_.addEventListener(Gt,this.handleElementEvent),this.element_.addEventListener(Jt,this.handleElementEvent)),this.track_.addEventListener(Bt,this.handleTrackEvent),this.track_.addEventListener(Ft,this.handleTrackEvent),this.track_.addEventListener(jt,this.handleTrackEvent),this.track_.readyState===Bt&&this.handleTrackEvent({type:Bt}),this.track_.muted&&this.handleTrackEvent({type:Ft})}async handleElementEvent(e){switch(e.type){case Ht:this.log_.info("audio player is playing"),this.state_=ni,Va.emit(no,{stream:this.stream_}),this.emitter_.emit(cl,{state:this.state_,reason:Ht});break;case Bt:this.log_.info("audio player is ended"),this.state_!==ai&&(this.state_=ai,this.emitter_.emit(cl,{state:this.state_,reason:Bt}));break;case Gt:{this.log_.info("audio player is paused"),this.state_=ri,this.emitter_.emit(cl,{state:this.state_,reason:Gt});const e=this.div_&&document.getElementById(this.div_.id);e||this.log_.warn(`audio player has been remove, element ID: ${this.div_.id}`);const t=pt();this.pausedRetryCount_>0&&(fa(t)&&t<=70||!e)&&(this.resume(),this.pausedRetryCount_--),Ce&&(this.interval_=Rd.run((()=>{this.element_&&this.state_===ri&&this.resume()}),{delay:3e3}));break}case Jt:if(this.element_&&this.element_.error){const e=`${zd()}/${wt().name}/${wt().version}`,t=await ou.getSpeakers();let i=t[0].label;const s=t.find((e=>e.deviceId===this.outputDeviceId_));s&&(i=s.label),this.log_.error(`audio player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e} speaker: ${i}`),sd.uploadEvent(`stat-${this.stream_.getType()}-audio-${_s}-${this.element_.error.code}-${e}-${i}`,this.element_.error)}}}handleTrackEvent(e){const t=e.type;switch(t){case Bt:this.log_.info("audio player track is ended"),this.state_!==ai&&(this.state_=ai,this.emitter_.emit(cl,{state:this.state_,reason:Bt})),Va.emit(Eo,{stream:this.stream_,type:t});break;case Ft:this.log_.info("audio track is unable to provide media output"),this.stream_.isRemote()||ka(),this.state_!==ri&&(this.state_=ri,this.emitter_.emit(cl,{state:this.state_,reason:Ft})),Va.emit(bo,{stream:this.stream_,type:t});break;case jt:this.log_.info("audio track is able to provide media output"),this.state_===ri&&(this.state_=ni,this.emitter_.emit(cl,{state:this.state_,reason:jt}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(Ht,this.handleElementEvent),this.element_.removeEventListener(Bt,this.handleElementEvent),this.element_.removeEventListener(Gt,this.handleElementEvent),this.element_.removeEventListener(Jt,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(Bt,this.handleTrackEvent),this.track_.removeEventListener(Ft,this.handleTrackEvent),this.track_.removeEventListener(jt,this.handleTrackEvent))}async setSinkId(e){this.outputDeviceId_!==e&&(this.element_&&await this.element_.setSinkId(e),this.outputDeviceId_=e)}setVolume(e){this.element_&&(this.log_.info(`audioElement setVolume to : ${e}`),this.element_.volume=e)}getAudioLevel(){return this.volumeMeter_.getCalculatedVolume()}getInternalAudioLevel(){return this.volumeMeter_.getInternalAudioLevel()}stop(){this.unbindEvents(),this.element_&&(this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null),this.volumeMeter_&&(this.volumeMeter_.destroy(),this.volumeMeter_=null),this.interval_>0&&Rd.clearTask(this.interval_)}async resume(){try{this.volumeMeter_&&this.volumeMeter_.resume(),this.element_&&await this.element_.play()}catch(e){const t=aa({key:Rr,data:{media:"Audio",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new gc({code:mc.PLAY_NOT_ALLOWED,message:t})}}on(e,t){this.emitter_.on(e,t)}isAudioElementInit(){return!("15.2"===Tt||"15.3"===Tt||"15.4"===Tt)||"local"!==this.stream_.getType()||!this.muted_||(this.log_.info("audioElement is muted."),!1)}}const yl="trtc_autoplay_wrapper";let Tl=!1;const Il=()=>!!document.querySelector(`.${yl}`),bl=`${Ws}/${Ra()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,El=`<br><a href='${bl}' target='_blank'>${Ra()?"其他方案？":"Any other solution?"}</a>`,Cl=""+(Ra()?`浏览器自动播放策略：在用户与页面产生交互（点击、触摸）之前，浏览器禁止播放有声媒体。该弹窗用于帮助用户恢复音视频播放。${El}`:`Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ${El}`);class Rl{constructor(){if(this.dialogNode_=null,this.bodyPosition_="",this.content="音视频播放被浏览器拦截，请点击“恢复播放”。",Ra()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!Tl){const e=document.createElement("style");e.innerHTML=`.trtc_autoplay_mask{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.trtc_autoplay_mask div:not(.trtc_autoplay_action_wrapper){display:block !important;}.${yl}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${yl} a{color:#2473E8;}.trtc_autoplay_header{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.trtc_autoplay_content{margin:8px 0;}.trtc_autoplay_action_wrapper{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.trtc_autoplay_collapse{margin-right:auto;cursor:pointer}.trtc_autoplay_question{height:100%;line-height:16px;cursor:pointer;}.trtc_autoplay_action_confirm{margin-left:8px;color:#fff;background:#2473E8;padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.trtc_autoplay_action_confirm:hover{opacity:0.9;}.trtc_autoplay_collapse,.trtc_autoplay_action_confirm,.trtc_autoplay_content,.trtc_autoplay_question{font-size:14px;}@media screen and (max-width:750px){.${yl}{width:80vw;}}`,document.head.appendChild(e),Tl=!0}this.showDetail_=!1,this.isCollapseClicked_=!1,this.isQuestionClicked_=!1,this.addDiaLog()}createDiaLog(){const e=document.createElement("template");e.innerHTML=`<div class="trtc_autoplay_mask"><div class='${yl}'><div class='trtc_autoplay_header'>${location.host}</div><div class='trtc_autoplay_content'>${this.content}</div><div class='trtc_autoplay_detail' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${Cl}</div><div class='trtc_autoplay_action_wrapper'></div></div></div>`.trim();const t=document.createElement("button");t.className="trtc_autoplay_action_confirm",t.innerText=Ra()?"恢复播放":"Resume",t.onclick=this.onConfirm.bind(this);const i=document.createElement("div");i.className="trtc_autoplay_question",i.innerHTML='<?xml version="1.0" encoding="UTF-8"?>\n    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>\n    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>\n    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>\n    </svg>\n    ',i.onclick=this.onQuestionClick.bind(this);const s=document.createElement("div");s.className="trtc_autoplay_collapse",s.innerText=""+(Ra()?"详情 >":"Detail >"),s.onclick=this.onCollapseClick.bind(this);const n=e.content.firstChild,r=n.querySelector(".trtc_autoplay_action_wrapper");return r.appendChild(s),r.appendChild(i),r.appendChild(t),n}addDiaLog(){Il()||(this.dialogNode_=this.createDiaLog(),document.body.appendChild(this.dialogNode_),this.dialogNode_.onclick=this.onConfirm.bind(this),this.dialogNode_.querySelector(`.${yl}`).onclick=e=>e.stopPropagation(),this.bodyPosition_=document.body.style.position,document.body.style.position="fixed",Oo.info("show autoplay dialog"),sd.uploadEvent({log:"dialog-show"}))}deleteDiaLog(){this.dialogNode_&&(document.body.removeChild(this.dialogNode_),document.body.style.position=this.bodyPosition_,this.dialogNode_=null)}onConfirm(){Oo.warn("confirm clicked, try resume stream"),Va.emit(wo),this.deleteDiaLog()}onCollapseClick(){const e=this.dialogNode_.querySelector(".trtc_autoplay_detail");e.style.visibility=""+(this.showDetail_?"hidden":"visible"),e.style.height=`${this.showDetail_?0:"fit-content"}`,this.showDetail_=!this.showDetail_,this.isCollapseClicked_||sd.uploadEvent({log:"dialog-1"}),this.isCollapseClicked_=!0}onQuestionClick(){window.open(bl,"_blank"),this.isQuestionClicked_||sd.uploadEvent({log:"dialog-2"}),this.isQuestionClicked_=!0}}class kl{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,this.div_=e.div,this.muted_=e.muted,this.objectFit_=e.objectFit,this.mirror_=e.mirror,this.emitter_=new xa,this.initializeElement(),this.state_="NONE",this.pausedRetryCount_=5}get isPlaying(){return this.state_===ni}initializeElement(){const e=new MediaStream;e.addTrack(this.track_);const t=document.createElement(Pt);t.srcObject=e,t.muted=!0;let i=`width: 100%; height: 100%; object-fit: ${this.objectFit_};`;this.mirror_&&(i+="transform: scaleX(-1);"),t.setAttribute("id",`video_${this.stream_.getId()}`),t.setAttribute("style",i),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_&&this.div_.appendChild(t),this.element_=t,this.handleEvents()}setRect({width:e,height:t}){this.element_&&(this.element_.style.width=e+"px",this.element_.style.height=t+"px")}setMirror(e){this.element_&&(this.element_.style.transform=e?"scaleX(-1)":"",this.mirror_=e)}setObjectFit(e){this.element_&&(this.element_.style.objectFit=`${e}`,this.objectFit_=e)}async play(){try{await this.element_.play()}catch(e){const t=aa({key:Rr,data:{media:"Video",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new gc({code:mc.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_.addEventListener(Ht,this.handleElementEvent),this.element_.addEventListener(Bt,this.handleElementEvent),this.element_.addEventListener(Gt,this.handleElementEvent),this.element_.addEventListener(Jt,this.handleElementEvent),this.element_.addEventListener(Wt,this.handleElementEvent),this.track_.addEventListener(Bt,this.handleTrackEvent),this.track_.addEventListener(Ft,this.handleTrackEvent),this.track_.addEventListener(jt,this.handleTrackEvent),this.track_.readyState===Bt&&this.handleTrackEvent({type:Bt}),this.track_.muted&&this.handleTrackEvent({type:Ft})}handleElementEvent(e){switch(e.type){case Ht:this.log_.info("video player is playing"),this.state_=ni,Va.emit(so,{stream:this.stream_}),this.emitter_.emit(cl,{state:this.state_,reason:Ht}),this.interval_&&(Rd.clearTask(this.interval_),this.interval_=null);break;case Bt:this.log_.info("video player is ended"),this.state_!==ai&&(this.state_=ai,this.emitter_.emit(cl,{state:this.state_,reason:Bt}));break;case Gt:this.log_.info("video player is paused"),this.div_&&!document.getElementById(this.div_.id)&&this.log_.warn(`video player has been remove, element ID: ${this.div_.id}`),this.state_=ri,this.emitter_.emit(cl,{state:this.state_,reason:Gt}),this.pausedRetryCount_>0&&!Il()&&(this.log_.info("video player auto resume when video paused"),this.resume(),this.pausedRetryCount_--),Ce&&(this.interval_=Rd.run((()=>{this.element_&&this.state_===ri&&this.resume()}),{delay:3e3}));break;case Jt:if(this.element_&&this.element_.error){const e=`${zd()}/${wt().name}/${wt().version}`;this.log_.error(`video player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e}`),sd.uploadEvent(`stat-${this.stream_.getType()}-video-${_s}-${this.element_.error.code}-${e}`,this.element_.error)}break;case Wt:Va.emit(yo,{stream:this.stream_})}}handleTrackEvent(e){const t=e.type;switch(t){case Bt:this.log_.info("video track is ended"),Va.emit(Io,{stream:this.stream_,type:t}),this.state_!==ai&&(this.state_=ai,this.emitter_.emit(cl,{state:this.state_,reason:Bt}));break;case Ft:this.log_.info("video track is unable to provide media output"),this.stream_.isRemote()||ka(),Va.emit(fo,{stream:this.stream_,type:t}),this.state_!==ri&&(this.state_=ri,this.emitter_.emit(cl,{state:this.state_,reason:Ft}));break;case jt:this.log_.info("video track is able to provide media output"),Va.emit(So,{stream:this.stream_}),this.state_===ri&&(this.state_=ni,this.emitter_.emit(cl,{state:this.state_,reason:jt}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(Ht,this.handleElementEvent),this.element_.removeEventListener(Bt,this.handleElementEvent),this.element_.removeEventListener(Gt,this.handleElementEvent),this.element_.removeEventListener(Jt,this.handleElementEvent),this.element_.removeEventListener(Wt,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(Bt,this.handleTrackEvent),this.track_.removeEventListener(Ft,this.handleTrackEvent),this.track_.removeEventListener(jt,this.handleTrackEvent))}stop(){this.unbindEvents(),this.div_&&this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null,this.interval_&&Rd.clearTask(this.interval_)}resume(){return this.play()}getVideoFrame(){const e=document.createElement("canvas");e.width=this.element_.videoWidth,e.height=this.element_.videoHeight;return e.getContext("2d").drawImage(this.element_,0,0),e.toDataURL("image/png")}on(e,t){this.emitter_.on(e,t)}getElement(){return this.element_?this.element_:null}}class wl{constructor(e,t,i){this.isUplink_=i,this.connection_=e,this.log_=t,this.seiMessageList_=[],this.seiPayloadType_=243,this.mainVideoSenderOrReceiver_=null,this.mainVideoAbortController_=null,this.abortMap_=new Map,this.onSEIMessage=null}get isRunning(){return!!this.mainVideoAbortController_}start(e){this.mainVideoSenderOrReceiver_=e;const t=e.createEncodedStreams(),i=t.readable,s=t.writable,n=new TransformStream({transform:this.isUplink_?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this.mainVideoAbortController_=new AbortController,i.pipeThrough(n).pipeTo(s,{signal:this.mainVideoAbortController_.signal}).catch((()=>{}))}restart(e){this.stop(),this.start(e)}stop(){var e;null===(e=this.mainVideoAbortController_)||void 0===e||e.abort(),this.mainVideoAbortController_=null}destroy(){this.stop(),this.abortMap_.forEach((e=>e.abort())),this.abortMap_.clear(),this.log_=null,this.onSEIMessage=null,this.mainVideoSenderOrReceiver_=null,this.connection_=null}handleEncodedStreams(){try{const e=this.connection_.getPeerConnection();this.clearUnusedSenderOrReceiver(e),this.isUplink_?e.getSenders().forEach(((e,t)=>{if(1===t){if(e===this.mainVideoSenderOrReceiver_)return;this.isRunning?this.restart(e):this.start(e)}else{if(this.abortMap_.has(e))return;this.pipeSenderOrReceiver(e)}})):e.getReceivers().forEach(((e,t)=>{var i;this.abortMap_.has(e)||e===this.mainVideoSenderOrReceiver_||(1===t&&(null===(i=e.track)||void 0===i?void 0:i.kind)===Pt?this.isRunning?this.restart(e):this.start(e):this.pipeSenderOrReceiver(e))}))}catch(e){this.log_.warn(e)}}pipeSenderOrReceiver(e){const{readable:t,writable:i}=e.createEncodedStreams(),s=new AbortController;this.abortMap_.set(e,s),t.pipeTo(i,{signal:s.signal}).catch((()=>{}))}clearUnusedSenderOrReceiver(e){this.abortMap_.forEach(((t,i)=>{(this.isUplink_?e.getSenders():e.getReceivers()).find((e=>e===i))||(t.abort(),this.abortMap_.delete(i))}))}push(e,t){t&&t.seiPayloadType&&(this.seiPayloadType_=t.seiPayloadType),this.seiMessageList_.push(e)}hasSEI(e){const t=new DataView(e);return 1===t.getInt32(0)&&6===t.getInt8(4)}isEmptyFrame(e){return"empty"===e.type||0===e.data.byteLength}getNaluCount(e){let t=0,i=0;const s=new DataView(e);for(let n=0;n<e.byteLength;n++)switch(s.getUint8(n)){case 0:t++;break;case 1:2!==t&&3!==t||i++,t=0;break;default:t=0}return i}encodeVideoFrame(e,t){try{if(this.connection_.isH264&&this.seiMessageList_.length>0&&!this.isEmptyFrame(e)){const t=9-this.getNaluCount(e.data);if(t<=0)return;const i=this.seiMessageList_.splice(0,t).reverse().map(this.encodeSEINalu.bind(this)),s=i.reduce(((e,t)=>e+t.dataView.byteLength),0),n=new ArrayBuffer(s+e.data.byteLength),r=new DataView(n),a=new DataView(e.data);let o=0;for(let e=0;e<i.length;e++)for(let t=0;t<i[e].dataView.byteLength;t++)r.setInt8(o++,i[e].dataView.getInt8(t));for(let c=0;c<e.data.byteLength;c++)r.setInt8(o++,a.getInt8(c));e.data=n,this.log_.debug(`${i.length} sei sent`)}}catch(i){this.log_.warn(i)}t.enqueue(e)}decodeVideoFrame(e,t){try{if(this.connection_.isH264&&!this.isEmptyFrame(e)&&this.hasSEI(e.data)){const t=[],i=new DataView(e.data);let s=0,n=-1,r=-1;for(let a=0;a<e.data.byteLength;a++){const o=i.getUint8(a);if(0===o)s++;else if(1===o){if(2===s||3===s){const o=a-s;-1===n?n=o:-1===r&&(r=o,t.push(new Al(new DataView(i.buffer.slice(n,r)))),n=o,r=-1);if(!(6===i.getUint8(a+1))){e.data=new DataView(i.buffer.slice(o)).buffer;break}}s=0}else s=0}this.log_.debug(`${t.length} sei received`),_a(this.onSEIMessage)&&t.reverse().forEach((e=>{this.onSEIMessage({seiPayloadType:e.seiPayloadType,data:e.seiPayload.buffer})}))}}catch(i){this.log_.warn(i)}t.enqueue(e)}encodeSEINalu(e){const t=e.byteLength,i=parseInt(t/255),s=t%255,n=[];n.push(0,0,0,1,6,this.seiPayloadType_);for(let a=0;a<i;a++)n.push(255);n.push(s);const r=new DataView(e);return n.push(...new Uint8Array(r.buffer)),n.push(128),new Al(new DataView(new Uint8Array(n).buffer),!0)}}class Al{constructor(e,t=!1){this.dataView=e,this.isSEI&&(t?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-2,i=[];let s=0;for(let r=e;r<=t;r++){const e=this.dataView.getInt8(r);switch(e){case 0:case 1:case 2:case 3:2===s&&(i.push(3),s=0),0==e?s++:s=0,i.push(e);break;default:s=0,i.push(e)}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));const n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n}removePreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-1,i=[];let s=0;for(let r=e;r<=t;r++)switch(this.dataView.getInt8(r)){case 0:s++,i.push(this.dataView.getInt8(r));break;case 3:2!==s&&i.push(this.dataView.getInt8(r)),s=0;break;default:i.push(this.dataView.getInt8(r)),s=0}const n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n}get isSEI(){return 6===this.dataView.getUint8(4)}get seiPayloadStartIndex(){let e=6;for(let t=6;t<this.dataView.buffer.byteLength&&(e++,255===this.dataView.getUint8(t));t++);return e}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let e=0,t=6;for(let n=6;n<this.dataView.buffer.byteLength;n++){const i=this.dataView.getUint8(n);if(t++,255!==i){e+=i;break}e+=255}const i=new ArrayBuffer(e),s=new DataView(i);for(let n=0;n<i.byteLength;n++,t++)s.setInt8(n,this.dataView.getInt8(t));return s}}class Dl{constructor(e){this.userId_=e.userId,this.tinyId_=e.tinyId,this.client_=e.client,this.sdpSemantics_=e.client.getSdpSemantics(),this.isUplink_=e.isUplink,this.log_=Oo.createLogger({id:"n|"+this.userId_,userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId(),isLocal:this.isUplink_}),this.signalChannel_=e.signalChannel,this.peerConnection_=null,this.isErrorObserved_=!1,this.emitter_=new xa,this.currentState_=Mi,this.waitForPeerConnectionConnectedPromise_=null,this.isReconnecting_=!1,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.isFirstConnection_=!0,this.delay_={audioDelay:0,videoDelay:0},this.enableSEI_=e.enableSEI,this.enableSEI_&&Gd&&(this.sei_=new wl(this,this.log_,this.isUplink_))}initialize(){const e={encodedInsertableStreams:this.enableSEI_&&Gd,iceServers:this.client_.getIceServers(),iceTransportPolicy:this.client_.getIceTransportPolicy(),sdpSemantics:this.sdpSemantics_,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this.peerConnection_=new RTCPeerConnection(e),this.peerConnection_.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(){this.log_.info("closing connection"),this.closePeerConnection(),this.sei_&&(this.sei_.destroy(),this.sei_=null)}closePeerConnection(e=!1){this.peerConnection_&&(this.peerConnection_.onconnectionstatechange=()=>{},this.peerConnection_.close(),this.peerConnection_=null,e&&this.emitConnectionStateChangedEvent(Mi))}getDTLSTransportState(){if(!this.peerConnection_)return"unknown";let e=null;if(this.isUplink_){if(!Vd()||0===this.peerConnection_.getSenders().length)return"unknown";e=this.peerConnection_.getSenders()[0].transport}else{if(!xd()||0===this.peerConnection_.getReceivers().length)return"unknown";e=this.peerConnection_.getReceivers()[0].transport}return e?e.state:"unknown"}onConnectionStateChange(e){const t=this.peerConnection_.iceConnectionState,i=this.getDTLSTransportState();if(this.log_.info("onConnectionStateChange() connectionState: "+e.target.connectionState),this.log_.info(`ICE Transport state: ${t}, DTLS Transport state: ${i}`),e.target.connectionState===Ui&&this.emitConnectionStateChangedEvent(Li),e.target.connectionState===$i||e.target.connectionState===Fi){const s=`${this.isUplink_?"uplink":"downlink"} ICE/DTLS Transport connection ${e.target.connectionState}. ICE Transport state: ${t}, DTLS Transport state: ${i}`,n=new gc({message:s,code:mc.ICE_TRANSPORT_ERROR});sd.logFailedEvent({userId:this.client_.getUserId(),eventType:as,error:n}),this.emitConnectionStateChangedEvent(Mi),this.isErrorObserved_||this.emitter_.emit(tl.ERROR,n)}e.target.connectionState!==Bi&&e.target.connectionState!==Hi||(this.logSelectedCandidate(),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:as}),this.emitConnectionStateChangedEvent(xi))}emitConnectionStateChangedEvent(e){e!==this.currentState_&&(this.currentState_===Oi&&e===Li||(Va.emit(Co,{client:this.client_,connection:this,prevState:this.currentState_,state:e}),this.emitter_.emit(tl.CONNECTION_STATE_CHANGED,{prevState:this.currentState_,state:e}),this.currentState_=e))}hitTest(e){return(0===e||"0"===e)&&this.isUplink_||e===this.tinyId_}addEventInternal(e,t){const i=this.client_.getUserId();let s={eventId:e,eventDesc:t,timestamp:fe(),userId:i,tinyId:this.client_.getTinyId()};this.isUplink_||(s.remoteUserId=this.userId_,s.remoteTinyId=this.tinyId_),ed(i,s)}getPeerConnection(){return this.peerConnection_}getClient(){return this.client_}getUserId(){return this.userId_}getTinyId(){return this.tinyId_}async logSelectedCandidate(){if(!this.peerConnection_)return;const e=await this.peerConnection_.getStats();for(let[t,i]of e)if(Jd(i)){const t=e.get(i.localCandidateId),s=e.get(i.remoteCandidateId);t&&this.log_.info(`local candidate: ${t.candidateType} ${t.protocol}:${t.ip||t.address}:${t.port} ${t.networkType||""} ${"relay"===t.candidateType?"relayProtocol:"+t.relayProtocol:""}`),s&&this.log_.info(`remote candidate: ${s.candidateType} ${s.protocol}:${s.ip||s.address}:${s.port}`);break}}getCurrentState(){return this.currentState_}waitForPeerConnectionConnected(){return this.waitForPeerConnectionConnectedPromise_||(this.waitForPeerConnectionConnectedPromise_=new Promise(((e,t)=>{if(this.currentState_===xi)return e();let i=-1;const s=t=>{t.state===xi&&(clearTimeout(i),a(),e())},n=({client:e})=>{e===this.client_&&(clearTimeout(i),a(),t(new gc({code:mc.API_CALL_ABORTED,message:aa({key:ea,data:"leave room"})})))},r=({client:e,stream:s})=>{!this.isUplink_&&e===this.client_&&s.getConnection()===this&&!this.peerConnection_&&(clearTimeout(i),a(),t(new gc({code:mc.API_CALL_ABORTED,message:aa({key:ea,data:"unsubscribe stream"})})))},a=()=>{Va.off(Ja,n,this),Va.off(lo,r,this),this.emitter_.off(tl.CONNECTION_STATE_CHANGED,s,this)};i=setTimeout((()=>{a();let e=new gc({code:mc.API_CALL_TIMEOUT,message:"connection timeout"});t(e)}),1e4),Va.on(Ja,n,this),this.emitter_.on(tl.CONNECTION_STATE_CHANGED,s,this),this.isUplink_||Va.on(lo,r,this)})),this.waitForPeerConnectionConnectedPromise_=this.waitForPeerConnectionConnectedPromise_.then((e=>(this.waitForPeerConnectionConnectedPromise_=null,e))).catch((e=>{throw this.waitForPeerConnectionConnectedPromise_=null,e}))),this.waitForPeerConnectionConnectedPromise_}getReconnectionCount(){return this.reconnectionCount_}startReconnection(){this.isReconnecting_=!0,this.emitConnectionStateChangedEvent(Oi),this.reconnect(),this.addEventInternal(this.isUplink_?Jc:qc,(this.isUplink_?"uplink":"downlink")+"-connection is reconnecting")}stopReconnection(){this.log_.info("stop reconnection"),this.isReconnecting_=!1,this.reconnectionCount_=0,this.clearReconnectionTimer(),this.signalChannel_.off(Fo,this.reconnect,this)}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}setDelay({audioDelay:e,videoDelay:t}){this.delay_={audioDelay:e,videoDelay:t}}getDelay(){return this.delay_}get isH264(){var e,t;return!(null===(e=this.peerConnection_)||void 0===e||null===(t=e.remoteDescription)||void 0===t||!t.sdp.includes("H264"))}}var Pl=new class{constructor(){this.set_=new Set,Va.on(Ua,this.add,this),Va.on(ja,this.add,this),Va.on(Ba,this.delete,this),Va.on(Ja,this.delete,this)}add({client:e,roomId:t}){if("rtc"===e.getMode())return;const i=this.getKey(e.getUserId(),t||e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.add(i)}delete({client:e}){if("rtc"===e.getMode())return;const t=this.getKey(e.getUserId(),e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.delete(t)}getKey(e,t,i,s){return`${i}_${t}_${e}_${s}`}isJoined({userId:e,roomId:t,sdkAppId:i,client:s}){return"rtc"!==s.getMode()&&this.set_.has(this.getKey(e,t,i,s.getUseStringRoomId()))}};function Nl(e,t,i,s){if(this.useStringRoomId_){if(!(ga(e)&&/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e)))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:vn,data:t,link:{className:s,fnName:i}})})}else{if(!(fa(e)&&/^[1-9]\d*$/.test(String(e))&&e<4294967295))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:yn,data:t,link:{className:s,fnName:i}})})}}function Ml(e,t,i,s){if(!/^[A-Za-z\d_-]*$/.test(e))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:$n,data:t,link:{className:s,fnName:i}})})}var Ll,Ol,xl={TRTC:{createClient:{name:"clientConfig",required:!0,type:Rs,properties:{sdkAppId:{required:!0,type:bs,allowEmpty:!1},userId:{required:!0,type:Is,allowEmpty:!1},userSig:{required:!0,type:Is,allowEmpty:!1},mode:{required:!0,type:Is,values:["rtc","live"]},useStringRoomId:{type:Es},autoSubscribe:{type:Es},enableAutoPlayDialog:{type:Es},streamId:{type:Is},userDefineRecordId:{type:Is},pureAudioPushMode:{type:bs,values:[1,2]},enableSEI:{type:Es}}},createStream:{name:"streamConfig",required:!0,type:Rs,properties:{userId:{type:Is},audio:{type:Es},video:{type:Es},screen:{type:Es},screenAudio:{type:Es},microphoneId:{type:Is},cameraId:{type:Is},facingMode:{type:[Is,Rs]},audioSource:{instanceOf:window.MediaStreamTrack},videoSource:{instanceOf:window.MediaStreamTrack}},validate(e){if(!ma(e.screen)&&e.screen&&ma(e.audio)&&(e.audio=!1),!(ma(e.audio)&&ma(e.video)||ma(e.audioSource)&&ma(e.videoSource)))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:kr})});if(!ma(e.screen)&&!0===e.screen&&!0===e.video)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:wr})});if(e.audio&&e.screenAudio)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Ar})});if(!0!==e.screen&&!0===e.screenAudio)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Dr})});if(!ma(e.screen)&&!0===e.screen&&!this.isScreenShareSupported())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Ur})})}}},CLIENT:{join:{name:"options",required:!0,properties:{roomId:{required:!0,type:[bs,Is],allowEmpty:!1,validate:Nl},role:{type:[Is],values:["anchor","audience"]},privateMapKey:{type:[Is]}},validate(e){if(this.isJoined_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Sn})});if(this.checkDestroy(),Pl.isJoined({userId:this.userId_,roomId:e.roomId,sdkAppId:this.sdkAppId_,client:this}))throw new gc({code:mc.INVALID_OPERATION,message:aa({key:ur,data:this.userId_})})}},publish:[{name:"stream",required:!0,instanceOf:Fs,validate(e){if(!this.isJoined_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Cn})});if("live"===this.mode_&&"audience"===this.role_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:kn})});if(!e.getIsReadyToPublish())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:wn})});if(this.notPublishWithoutH264Supported_)throw new gc({code:mc.NOT_SUPPORTED_H264,message:aa({key:Lr})})}},{name:"options",type:Rs,defaultValue:{isAuxiliary:!1},properties:{isAuxiliary:{type:Es,defaultValue:!1,validate(e=!1){if(e&&!$d())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:$r})});if(this.uplinkConnection_&&(e&&this.uplinkConnection_.isAuxStreamPublished||!e&&this.uplinkConnection_.isMainStreamPublished))throw new gc({code:mc.INVALID_OPERATION,message:aa({key:An,data:e?Ot:"local"})});const t=this.localScreenStream_||[...this.connections_.values()].findIndex((e=>e.getTrackState().auxiliary))>=0;if(!this.enableMultiAuxStream_&&e&&t)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:ia})})}}}}],unpublish:{name:"stream",required:!0,instanceOf:Fs,validate(e){if(e!==this.localStream_&&e!==this.localAuxStream_){if(this.localStream_||this.localAuxStream_)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Rn})});this.log_.warn("Client currently has no published stream, please call publish() first.")}}},subscribe:[{name:"stream",required:!0,instanceOf:js,validate(e){if(!e.getConnection())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Dn})});if(this.notSubscribeWithoutH264Supported_)throw new gc({code:mc.NOT_SUPPORTED_H264,message:aa({key:Or})})}},{name:"options",type:Rs,properties:{audio:{type:Es},video:{type:Es}},validate({audio:e,video:t}){if(!(ma(e)||ma(t)||e||t))throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Wr})})}}],unsubscribe:{name:"stream",required:!0,instanceOf:js,validate(e){if(!e.getConnection())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Dn})})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(){if("live"!==this.mode_)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Nn})});if(!this.isJoined_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Mn})})}},startPublishCDNStream:{name:"options",required:!1,properties:{streamId:{type:Is,validate:Ml},streamType:{type:Is,values:["main","auxiliary"]},appId:{type:bs,allowEmpty:!1},bizId:{type:bs,allowEmpty:!1},url:{type:Is,allowEmpty:!1}},validate(){if(this.isDestroyed_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:pr,data:{funName:"startPublishCDNStream"}})})}},startMixTranscode:{name:"config",required:!0,type:Rs,properties:{mode:{type:Is,values:["preset-layout","manual"]},streamId:{type:Is,validate:Ml},videoWidth:{type:bs,notLessThanZero:!0},videoHeight:{type:bs,notLessThanZero:!0},videoBitrate:{type:bs,notLessThanZero:!0,allowEmpty:!1},videoFramerate:{type:bs,validate(e,t,i,s){if(e<=0||e>30)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Sr,link:{className:s,fnName:i}})})}},videoGop:{type:bs,validate(e,t,i,s){if(e<1||e>8)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:vr,link:{className:s,fnName:i}})})}},audioSampleRate:{type:bs,notLessThanZero:!0},audioBitrate:{type:bs,validate(e,t,i,s){if(e<32||e>192)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:yr,link:{className:s,fnName:i}})})}},audioChannels:{type:bs,values:[1,2]},backgroundColor:{type:bs},backgroundImage:{type:Is},mixUsers:{required:!0,type:Cs,arrayItem:{require:!0,type:Rs,properties:{userId:{required:!0,type:Is},roomId:{type:[Is,bs],validate:Nl},pureAudio:{type:Es},width:{type:bs,notLessThanZero:!0},height:{type:bs,notLessThanZero:!0},locationX:{type:bs,notLessThanZero:!0},locationY:{type:bs,notLessThanZero:!0},zOrder:{type:bs},streamType:{type:Is,values:["main","auxiliary"]},renderMode:{type:bs,values:[0,1,2,4]}}}}},validate(e,t,i,s,n){let r=0,a=0;const o=e.mixUsers,c=[];if(o.forEach(((e,t)=>{if(c.push(e.userId),!e.pureAudio){if(!e.zOrder||e.zOrder<1||e>15)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Tr,data:`config.mixUsers[${t}].zOrder`,link:{className:s,fnName:i}})});e.width+e.locationX>r&&(r=e.width+e.locationX),e.height+e.locationY>a&&(a=e.height+e.locationY)}})),c.indexOf(this.getUserId())<0)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Ir,link:{className:s,fnName:i}})});if(e.videoWidth<r||e.videoHeight<a)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:br,link:{className:s,fnName:i}})})}},sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(e){if(!Gd)throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:zr})});if(!this.enableSEI_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:qr})});if(e.byteLength>1e3)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Qr,data:e.byteLength})});if(0===e.byteLength)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Kr})});if(!this.uplinkConnection_||!this.localStream_)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Xr})});if(!this.localStream_.hasVideo())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Yr})});const t=this.uplinkConnection_.isH264;if(!t)throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:zr,data:t})})}},{name:"options",type:Rs,properties:{seiPayloadType:{type:bs,values:[5,243]}}}]},LOCAL_STREAM:{switchDevice:[{name:"type",required:!0,type:Is,values:[Dt,Pt]},{name:"deviceId",required:!0,type:Is,validate(){if(this.screen_&&!this.audio_||this.audioSource_||this.videoSource_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Qn})});if(this.publishState_===Ds)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Xn})});if(!Fd())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:Vr})})}}],setAudioCaptureVolume:{name:"volume",type:bs}},STREAM:{play:[{name:"elementId",required:!0,type:[Is,"HTMLDivElement"],validate(e,t,i){if(ga(e)){const s=document.getElementById(e);if(!s)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Er,data:{key:t,fnName:i}})});if(!(s instanceof HTMLDivElement))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Cr,data:{key:t,fnName:i,type:Ia(s)}})})}}},{name:"options",type:Rs,properties:{objectFit:{type:Is,values:["contain","cover","fill"]},muted:{type:Es},mirror:{type:Es}}}],addTrack:{name:pi,instanceOf:MediaStreamTrack,validate(e){if(this.isAddingTrack_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:er})});if(this.isRemovingTrack_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:tr})});if(this.publishState_===Ds)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:ir})});const t=this.getMediaStream();if(!t)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:sr})});if(e.kind===Dt&&t.getAudioTracks().length>0||e.kind===Pt&&t.getVideoTracks().length>0)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:nr})});if(!Ud()&&!Vd())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:xr,data:li})})}},removeTrack:{name:pi,instanceOf:MediaStreamTrack,validate(e){if(this.isAddingTrack_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:ar})});if(this.isRemovingTrack_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:or})});if(this.publishState_===Ds)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:cr})});const t=this.getMediaStream();if(!t)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:sr})});if(-1===t.getTracks().indexOf(e))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:dr})});if(!Ud()){if(1===t.getTracks().length)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:lr})});if(e.kind===Dt)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:rr})});if(!Vd())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:xr,data:hi})})}}},replaceTrack:{name:pi,instanceOf:MediaStreamTrack,validate(e){const t=this.getMediaStream();if(!t)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Zn})});if(this.publishState_===Ds)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Yn})});if(e.kind===Dt&&t.getAudioTracks().length<=0||e.kind===Pt&&t.getVideoTracks().length<=0)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:hr,data:e})});if(!Fd())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:xr,data:ui})})}}}};function Vl(...e){return function(t,i,s){const n=s.value;return s.value=function(...t){return $l.call(this,e,t,i,this.name_),n.apply(this,t)},s}}function Ul(...e){return function(t,i,s){const n=s.value;return s.value=async function(...t){return $l.call(this,e,t,i,this.name_),n.apply(this,t)},s}}function $l(e,t,i,s){try{for(let n=0;n<e.length;n++)Fl.call(this,{rule:e[n],value:t[n],key:e[n].name,fnName:i,className:s})}catch(n){throw Oo.error(n),n}}function Fl({rule:e,value:t,key:i,fnName:s,className:n}){if(ma(t)){if(e.required)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Zs,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(ma(e.defaultValue))return;t=e.defaultValue}if(Array.isArray(e.type)){if(!e.type.map((e=>e.toLowerCase())).includes(Ia(t)))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:en,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}else if(!ma(e.type)&&Ia(t)!==e.type)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:en,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(!1===e.allowEmpty){const r=fa(t)&&(0===t||Number.isNaN(t)),a=ga(t)&&""===t.trim();if(r||a)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:tn,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}if(e.notLessThanZero&&fa(t)&&t<0)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:fr,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(ga(e.instanceOf)){if(!t||t.name_!==e.instanceOf)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:sn,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}else if(_a(e.instanceOf)&&!(t instanceof e.instanceOf))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:sn,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(e.values&&!e.values.includes(t))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:nn,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});const{properties:r}=e;ha(r)&&va(t)&&Object.keys(r).forEach((e=>{Fl.call(this,{rule:r[e],value:t&&t[e],key:`${i}.${e}`,fnName:s,className:n})}));const{arrayItem:a}=e;ha(a)&&ya(t)&&t.forEach(((e,t)=>{Fl.call(this,{rule:a,value:e,key:`${i}[${t}]`,fnName:s,className:n})})),_a(e.validate)&&e.validate.call(this,t,i,s,n,this)}let jl=(Ll=Ul(...xl.STREAM.play),Ol=class{constructor(e){this.name_=Bs,this.userId_=e.userId,this.isRemote_=e.isRemote,this.type_=e.type,this.log_=Oo.createLogger({id:`s${e.seq?e.seq:""}|${this.userId_}`,userId:ma(e.client)?void 0:e.client.getUserId(),sdkAppId:ma(e.client)?void 0:e.client.getSDKAppId(),isLocal:!this.isRemote_,type:this.isRemote_?this.type_:""}),this.client_=null,ma(e.client)||(this.client_=e.client),this.mediaStream_=null,this.div_=null,this.isPlaying_=!1,this.connection_=null,this.audioPlayer_=null,this.videoPlayer_=null,this.muted_=!1,this.objectFit_="cover",this.mirror_=!1,this.id_="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),this.audioOutputDeviceId_=0,this.audioVolume_=1,this.emitter_=Pa(new xa,this.name_),this.connectionState_=Mi,this.installEvents(),ma(e.mirror)||this.log_.warn(`TRTC.createStream "mirror" option was deprecated since v4.12.1，please use localStream.play to set up preview mirror. refer to ${Ws}/en/LocalStream.html#play. TRTC.createStream 接口的 mirror 选项从 v4.12.1 开始被废弃，请使用 localStream.play 设置本地流预览镜像，参考文档：${Ws}/zh-cn/LocalStream.html#play。`)}installEvents(){Va.on(wo,this.restartPlayback,this)}uninstallEvents(){Va.off(wo,this.restartPlayback,this)}getType(){return this.type_}getLogger(){return this.log_}get isSubscribed(){return this.type_===Pi&&this.connection_.isMainStreamSubscribed||this.type_===Ni&&this.connection_.isAuxStreamSubscribed}get isMainVideoSubscribed(){const e=this.getSubscribedState();return this.type_===Pi&&e&&e.video}get isMainAudioSubscribed(){const e=this.getSubscribedState();return this.type_===Pi&&e&&e.audio}get isAuxVideoSubscribed(){const e=this.getSubscribedState();return this.type_===Ni&&e&&e.auxiliary}get isSmallVideoSubscribed(){const e=this.getSubscribedState();return this.type_===Pi&&e&&e.smallVideo}emitConnectionStateChanged(e){e.state!==this.connectionState_&&(e.state!==Mi&&this.isRemote_&&!this.isSubscribed||(this.emitter_.emit(rl,e),this.connectionState_=e.state))}setConnection(e){this.connection_!==e&&(e instanceof Dl?(null!==this.connection_&&this.connection_.off(tl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),e.on(tl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this)):null===e&&this.connection_.off(tl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),this.connection_=e)}getConnection(){return this.connection_}async play(e,t){if(this.log_.info(`stream ${this.isPlaying_?"update":"start to"} play with elementId: ${e} and options: ${JSON.stringify(t)}.`),this.isPlaying_){if(t&&!ma(t.muted)&&(this.muted_=t.muted),t&&!ma(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:t&&!ma(t.mirror)&&(this.mirror_=t.mirror),this.audioPlayer_&&this.audioPlayer_.setMuted(this.muted_),this.videoPlayer_&&(this.videoPlayer_.setObjectFit(this.objectFit_),this.videoPlayer_.setMirror(this.mirror_)),this.elementId_!==e){let t=e;ga(e)&&(t=document.getElementById(e)),t.appendChild(this.div_),this.elementId_=e}return}this.isPlaying_=!0;const i=document.createElement("div");i.setAttribute("id",`player_${this.id_}`),i.setAttribute("style","width: 100%; height: 100%; position: relative; background-color: black; overflow: hidden;");let s=e;ga(e)&&(s=document.getElementById(e)),s.appendChild(i),this.elementId_=e,this.div_=i,this.isRemote_||(this.muted_=!0),t&&!ma(t.muted)&&(this.muted_=t.muted),this.isScreenShare()&&(this.objectFit_="contain"),t&&!ma(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:(this.isRemote_||(this.mirror_=!0),t&&!ma(t.mirror)&&(this.mirror_=t.mirror)),Va.emit(vo,{stream:this}),await Promise.all([this.playAudio(),this.playVideo()]),Va.emit(to,{stream:this})}async playAudio(){if(!this.hasAudio()||this.isRemote_&&!this.isMainAudioSubscribed)return;const e=this.getAudioTrack();if(!this.audioPlayer_&&e){var t;this.log_.info("create AudioPlayer and play"),this.audioPlayer_=new vl({stream:this,track:e,gainedTrack:null===(t=this.gain_)||void 0===t?void 0:t.audioTrack,div:this.div_,muted:this.muted_,outputDeviceId:this.audioOutputDeviceId_,volume:this.audioVolume_}),this.audioPlayer_.on(cl,(e=>{const t={type:Dt,state:e.state,reason:e.reason};Va.emit(io,{stream:this,...t}),this.emitter_.emit(sl,t)}));try{await this.audioPlayer_.play()}catch(i){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Rl,this.emitter_.emit(ol,i),i}}}async playVideo(){if(!this.hasVideo()||this.isRemote_&&!this.isMainVideoSubscribed&&!this.isAuxVideoSubscribed&&!this.isSmallVideoSubscribed)return;const e=this.getVideoTrack();if(!this.videoPlayer_&&e){Va.emit(To,{stream:this}),this.log_.info("create VideoPlayer and play"),this.videoPlayer_=new kl({stream:this,track:e,div:this.div_,muted:this.muted_,objectFit:this.objectFit_,mirror:this.mirror_}),this.videoPlayer_.on(cl,(e=>{const t={type:Pt,state:e.state,reason:e.reason};Va.emit(io,{stream:this,...t}),this.emitter_.emit(sl,t)}));try{await this.videoPlayer_.play()}catch(t){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Rl,this.emitter_.emit(ol,t),t}}}stopAudio(){this.audioPlayer_&&(this.log_.info("stop AudioPlayer"),this.audioPlayer_.stop(),this.audioPlayer_=null)}stopVideo(){this.videoPlayer_&&(this.log_.info("stop VideoPlayer"),this.videoPlayer_.stop(),this.videoPlayer_=null)}restartPlayback(){this.audioPlayer_&&!this.audioPlayer_.isPlaying&&this.restartAudio(),this.videoPlayer_&&!this.videoPlayer_.isPlaying&&this.restartVideo()}restartAudio(){this.isPlaying_&&(this.stopAudio(),this.playAudio().catch((e=>{})))}restartVideo(){this.isPlaying_&&(this.stopVideo(),this.playVideo().catch((e=>{})))}stop(){this.isPlaying_&&(this.isPlaying_=!1,this.stopAudio(),this.stopVideo(),this.div_.parentNode.removeChild(this.div_))}async resume(){this.isPlaying_&&(this.log_.info("resume"),this.audioPlayer_&&await this.audioPlayer_.resume(),this.videoPlayer_&&await this.videoPlayer_.resume())}close(){this.log_.info("close stream"),this.isPlaying_&&this.stop(),this.isRemote_||(this.mediaStream_&&(this.mediaStream_.preventEvent=1,this.mediaStream_.getTracks().forEach((e=>{e.stop()})),this.mediaStream_=null),this.uninstallEvents())}muteAudio(){return this.addRemoteEvent(!0,Dt),this.doEnableTrack(Dt,!1)}muteVideo(){return this.addRemoteEvent(!0,Pt),this.doEnableTrack(Pt,!1)}unmuteAudio(){return this.addRemoteEvent(!1,Dt),this.doEnableTrack(Dt,!0)}unmuteVideo(){return this.addRemoteEvent(!1,Pt),this.doEnableTrack(Pt,!0)}addRemoteEvent(e,t){if(this.isRemote_&&this.client_){const i=this.client_.getUserId();let s,n=`${e?Ft:jt} remote ${t}`;s=t===Dt?e?Mc:Oc:e?Nc:Lc,ed(i,{eventId:s,eventDesc:n,timestamp:(new Date).getTime(),userId:i,tinyId:this.client_.getTinyId(),remoteUserId:this.userId_,remoteTinyId:this.connection_.getTinyId()})}}doEnableTrack(e,t){let i=!1;return e===Dt?this.mediaStream_.getAudioTracks().forEach((e=>{i=!0,e.enabled=t})):this.mediaStream_.getVideoTracks().forEach((e=>{i=!0,e.enabled=t})),i}getId(){return this.id_}getUserId(){return this.userId_}getTinyId(){return this.connection_?this.connection_.getTinyId():""}isPlaying(){return this.isPlaying_}async setAudioOutput(e){this.audioOutputDeviceId_=e,this.audioPlayer_&&await this.audioPlayer_.setSinkId(e)}setAudioVolume(e){this.audioVolume_=e,this.log_.info(`setAudioVolume to ${e}`),this.audioPlayer_&&this.audioPlayer_.setVolume(e)}getAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getAudioLevel()),e}getInternalAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getInternalAudioLevel()),e}hasAudio(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===Pi&&e.audio}return!!this.getAudioTrack()}hasVideo(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===Ni?e.auxiliary:e.video}return!!this.getVideoTrack()}getSubscribedState(){return this.isRemote_&&this.connection_?this.connection_.getSubscribeState():null}getAudioTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getAudioTracks();t.length>0&&(e=t[0])}return e}getVideoTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getVideoTracks();t.length>0&&(e=t[0])}return e}getVideoFrame(){return this.videoPlayer_?this.videoPlayer_.getVideoFrame():null}getMediaStream(){return this.mediaStream_}setMediaStream(e){e!==this.mediaStream_&&(this.mediaStream_&&this.mediaStream_.getTracks().forEach((e=>e.stop())),this.mediaStream_=e)}updateVideoPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play video"),this.playVideo().catch((e=>{}))):(this.log_.info("playing state updated, stop video"),this.stopVideo()))}updateAudioPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play audio"),this.playAudio().catch((e=>{}))):(this.log_.info("playing state updated, stop audio"),this.stopAudio()))}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}isRemote(){return this.isRemote_}isScreenShare(){return!this.isRemote_&&this.screen_||this.isRemote_&&this.getType()===Ot}getDiv(){return this.div_}getObjectFit(){return this.objectFit_}getMuted(){return this.muted_}getClient(){return this.client_}},e(Ol.prototype,"play",[Ll],Object.getOwnPropertyDescriptor(Ol.prototype,"play"),Ol.prototype),Ol);class Bl extends jl{constructor(e){const t={isRemote:!0,type:e.type};super({...e,...t}),this.name_=js,this.isStreamAddedEventEmitted_=!1,this.isAbleToCallSubscription_=!0}installEvents(){super.installEvents(),Va.on(co,this.handleStreamSubscribed,this),Va.on(lo,this.handleStreamUnsubscribed,this)}uninstallEvents(){super.uninstallEvents(),Va.off(co,this.handleStreamSubscribed,this),Va.off(lo,this.handleStreamUnsubscribed,this)}handleStreamSubscribed(e){e.client===this.client_&&e.stream===this&&this.connection_.getCurrentState()===xi&&this.emitConnectionStateChanged({prevState:Mi,state:xi})}handleStreamUnsubscribed(e){e.client===this.client_&&e.stream===this&&this.emitConnectionStateChanged({prevState:xi,state:Mi})}getType(){return super.getType()}getIsAbleToCallSubscription(){return this.isAbleToCallSubscription_}setIsAbleToCallSubscription(e){this.isAbleToCallSubscription_=e}setIsStreamAddedEventEmitted(e){this.isStreamAddedEventEmitted_=e}getIsStreamAddedEventEmitted(){return this.isStreamAddedEventEmitted_}getAudioTrack(){if(!this.connection_)return null;return this.connection_.getTrackState().audio?super.getAudioTrack():null}getVideoTrack(){if(!this.connection_)return null;const e=this.connection_.getTrackState();return(this.type_!==Pi||e.video)&&(this.type_!==Ni||e.auxiliary)?super.getVideoTrack():null}close(){super.close()}}class Hl{constructor(e){this.client_=e.client,this.subscribedStreams_=new Map,this.unsubscribedStreams_=new Map,this.subscriptedOptions_=new Map,this.autoRecoveryFlags_=new Map}get isEnabled(){return"webrtc"!==this.client_.getEnv()}async recover(e){const t=e.getUserId(),i=e.getType();if(!this.hasAutoRecoveryFlag(t,i))return;const s=this.getUnsubscribedStream(t,i)?"unsubscribe":"subscribe";try{Oo.warn(`recover() try to recover subscription [${s}][${t}][${i}]`),"subscribe"===s?await this.recoverSubscription(t,e):await this.recoverUnsubscription(t,e),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:hs}),Oo.warn(`recover() recover successfully [${s}][${t}][${i}]`)}catch(n){Oo.error(`recover() recover failed [${s}][${t}][${i}]`,n),sd.logFailedEvent({userId:this.client_.getUserId(),eventType:hs,error:n})}this.deleteAutoRecoveryFlag(t,i)}async recoverSubscription(e,t){const i=this.getOptions(e,t.getType()),s=this.getSubscribedStream(e,t.getType());if(!i||!s)return;const{isAudioMuted:n,isVideoMuted:r}=this.getStreamMuteState(s);this.mergeStream(s,t),this.recoverPlayingState(s),n&&s.doEnableTrack(Dt,!1),r&&s.doEnableTrack(Pt,!1)}async recoverUnsubscription(e,t){const i=this.getUnsubscribedStream(e,t.getType());i&&this.mergeStream(i,t)}getStreamMuteState(e){const t={isAudioMuted:!1,isVideoMuted:!1},i=e.getMediaStream();return i&&(t.isAudioMuted=i.getAudioTracks().map((e=>e.enabled)).includes(!1),t.isVideoMuted=i.getVideoTracks().map((e=>e.enabled)).includes(!1)),t}recoverPlayingState(e){const t=e.isPlaying(),i=e.getDiv();if(t&&i){const t=i.parentNode;e.stop(),e.play(t,{objectFit:e.getObjectFit(),muted:e.getMuted()})}}mergeStream(e,t){const i=t.getConnection(),s=t.getMediaStream();e.setConnection(i),i.setRemoteStream(s.id,e),e.setMediaStream(s),e.updateAudioPlayingState(t.hasAudio()),e.updateVideoPlayingState(t.hasVideo())}addSubscriptionRecord(e,t,i){const s=t.getType();if(this.subscribedStreams_.has(e))this.subscribedStreams_.get(e).set(s,t);else{const i=new Map;i.set(t.getType(),t),this.subscribedStreams_.set(e,i)}if(this.subscriptedOptions_.has(e))this.subscriptedOptions_.get(e).set(s,i);else{const s=new Map;s.set(t.getType(),i),this.subscriptedOptions_.set(e,s)}this.deleteUnsubscriptionRecord(e,s)}addUnsubscriptionRecord(e,t){if(this.unsubscribedStreams_.has(e))this.unsubscribedStreams_.get(e).set(t.getType(),t);else{const i=new Map;i.set(t.getType(),t),this.unsubscribedStreams_.set(e,i)}this.deleteSubscriptionRecord(e,t.getType())}getSubscribedStream(e,t){return this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).has(t)?this.subscribedStreams_.get(e).get(t):null}getOptions(e,t){return this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).has(t)?this.subscriptedOptions_.get(e).get(t):null}getUnsubscribedStream(e,t){return this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).has(t)?this.unsubscribedStreams_.get(e).get(t):null}deleteSubscriptionRecord(e,t){this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).delete(t),this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).delete(t)}deleteUnsubscriptionRecord(e,t){this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).delete(t)}markAllStream(){for(const[e,t]of[...this.subscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i);for(const[e,t]of[...this.unsubscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i)}setAutoRecoveryFlag(e,t){if(Oo.info(`setAutoRecoveryFlag() mark [${e}][${t}]`),this.autoRecoveryFlags_.has(e))this.autoRecoveryFlags_.get(e).set(t);else{const i=new Map;i.set(t),this.autoRecoveryFlags_.set(e,i)}}hasAutoRecoveryFlag(e,t){return!!this.isEnabled&&(this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).has(t))}deleteAutoRecoveryFlag(e,t){this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).delete(t)}delete(e){this.unsubscribedStreams_.delete(e),this.subscribedStreams_.delete(e),this.subscriptedOptions_.delete(e),this.autoRecoveryFlags_.delete(e)}}class Gl{constructor(e){this.player_=e,this.canvas_=document.createElement(At),this.canvasCtx_=this.canvas_.getContext("2d")}setCanvasRect(e,t){this.canvas_.width=e,this.canvas_.height=t}drawVideoToCanvas(){const e=this.player_.getElement(),t=e.videoHeight,i=e.videoWidth,s=i*this.canvas_.height/(t*this.canvas_.width);if(s>1.05||s<.95){let e=i*t/(this.canvas_.width*this.canvas_.height);this.setCanvasRect(i/Math.sqrt(e),t/Math.sqrt(e))}this.canvasCtx_.drawImage(e,0,0,this.canvas_.width,this.canvas_.height)}generateVideoTrackFromCanvasCapture(e){return this.canvas_.captureStream(e).getVideoTracks()[0]}generateStreamFromTrack(e){const t=new MediaStream;return t.addTrack(e),t}destroy(){this.player_.stop(),this.canvas_.width=0,this.canvas_.height=0,this.canvas_=null,this.canvasCtx_=null}get canvas(){return this.canvas_}get canvasCtx(){return this.canvasCtx_}get canDrawVideoToCanvas(){if(this.player_){const e=this.player_.getElement();if(e)return e.readyState===e.HAVE_ENOUGH_DATA}return!1}}let Jl=new Blob(['let t,e,a,i;onmessage=function(n){const{action:h,data:s}=n.data;switch(h){case"render":a=s.canvas,t=a.width,e=a.height,i=a.getContext("2d"),function(t,e){const n=new TransformStream({async transform(t,e){const n=t.displayWidth,h=t.displayHeight,s=n*a.height/(h*a.width);if(s>1.05||s<.95){const t=n*h/(a.width*a.height);a.width=n/Math.sqrt(t),a.height=h/Math.sqrt(t)}i.drawImage(t,0,0,a.width,a.height);const o=new VideoFrame(a,{timestamp:t.timestamp});t.close(),e.enqueue(o)}});t.pipeThrough(n).pipeTo(e)}(s.readable,s.writable)}}'],{type:"application/javascript"});class Wl{constructor(e){const{videoTrack:t}=e;this.width=void 0,this.height=void 0,this.canvas=document.createElement("canvas"),this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:t}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(Jl)),Oo.info("init worker processor success")}catch(e){Oo.warn(`init worker processor failed. ${e.error}`)}}setCanvasRect(e,t){this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generatorVideoTrack(){const e=new MediaStream([this.smallGenerator]);return null==e?void 0:e.getTracks()[0]}destroy(){this.worker.terminate()}}class zl{constructor(e){this.localStream_=e,this.player_=null,this.processor_=null,this.initOffscreenSuccess_=!1}async initialize(){var e;if(function(){var e,t,i;return(null===(e=window)||void 0===e?void 0:e.OffscreenCanvas)&&(null===(t=window)||void 0===t?void 0:t.MediaStreamTrackProcessor)&&(null===(i=window)||void 0===i?void 0:i.MediaStreamTrackGenerator)}()&&(null===(e=navigator)||void 0===e?void 0:e.hardwareConcurrency)>=6)try{await this.initOffscreen(),this.initOffscreenSuccess_=!0,Oo.info("Initialize VideoGenerator successfully!")}catch(t){this.initCanvas()}else this.initCanvas()}generateSmallVideoTrack(e){const{height:t,width:i,frameRate:s}=e,n=this.getSmallVideoProfile(i,t);let r;return this.initOffscreenSuccess_?(this.processor_.setCanvasRect(n.width,n.height),r=this.processor_.generatorVideoTrack()):(this.processor_.setCanvasRect(n.width,n.height),this.player_.setRect({width:n.width,height:n.height}),r=this.processor_.generateVideoTrackFromCanvasCapture(s),this.interval_=Rd.run("raf",this.render.bind(this),{fps:s})),r}render(){this.processor_.canDrawVideoToCanvas&&this.processor_.drawVideoToCanvas()}destroy(){Rd.clearTask(this.interval_),this.processor_&&this.processor_.destroy()}initOffscreen(){this.processor_=new Wl({videoTrack:this.localStream_.getVideoTrack()})}initCanvas(){this.player_=new kl({stream:this.localStream_,track:this.localStream_.getVideoTrack(),muted:!0,objectFit:"cover",mirror:!1}),this.player_.play().then((()=>{Oo.info("VideoGenerator: play local video success")})).catch((()=>{Oo.error("VideoGenerator: Failed to play local video")})),this.processor_=new Gl(this.player_)}getSmallVideoProfile(e,t){const i=this.localStream_.getVideoTrack();let s,n=this.localStream_.getVideoProfile();if(Zd){const e=i.getSettings();e&&e.width&&e.height&&(n.width=e.width,n.height=e.height)}const r=n.width*n.height,a=e*t;Oo.info(`big stream resolution: ${n.width}*${n.height} small stream resolution: ${e}*${t} `),s=r>a?r/a:r/19200;return{width:parseInt(n.width/Math.sqrt(s)),height:parseInt(n.height/Math.sqrt(s))}}}function ql(e={retries:5,timeout:2e3}){return function(t,i,s){const n=Po({retryFunction:s.value,settings:e,onError:e.onError,onRetrying:e.onRetrying,onRetryFailed:e.onRetryFailed});return s.value=function(...e){return n.apply(this,e)},s}}const Kl=new Map;const Ql=Po({retryFunction:async function(e){if(Bd())return;const t=await async function(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression};if(e.audio)if(id(e.microphoneId)){t={sampleRate:e.sampleRate,channelCount:e.channelCount,...t};const i=(await ou.getMicrophones()).filter((({deviceId:e})=>e.length>0));i.length>0&&(t.deviceId={exact:i[0].deviceId})}else t={deviceId:e.useExact?{exact:e.microphoneId}:e.microphoneId,sampleRate:e.sampleRate,channelCount:e.channelCount,...t};else t=!1;let i={},s={ideal:e.width,max:e.width},n={ideal:e.height,max:e.height};ke&&Ze&&e.width*e.height<101376&&(s=e.width,n=e.height);i=!ma(e.facingMode)&&e.video?{facingMode:e.facingMode,width:s,height:n,frameRate:e.frameRate}:!id(e.cameraId)&&e.video?{deviceId:e.useExact?{exact:e.cameraId}:e.cameraId,width:s,height:n,frameRate:e.frameRate}:!!e.video&&(!!ma(e.width)||{width:s,height:n,frameRate:e.frameRate});return{audio:t,video:i}}(e);let i,s;Oo.info("getUserMedia with constraints: "+JSON.stringify(t)),t.audio&&(i=await ou.getMicrophones(),Oo.info(`microphones: ${JSON.stringify(i)}`)),t.video&&(s=await ou.getCameras(),Oo.info(`cameras: ${JSON.stringify(s)}`));try{return await navigator.mediaDevices.getUserMedia(t)}catch(n){if("NotFoundError"===n.name){if(s&&0===s.length)throw new gc({code:mc.DEVICE_NOT_FOUND,message:aa({key:jr})});if(i&&0===i.length)throw new gc({code:mc.DEVICE_NOT_FOUND,message:aa({key:Fr})})}throw new gc({code:mc.INITIALIZE_FAILED,name:n.name,message:n.message,constraint:n.constraint})}},settings:{retries:3,timeout:500},onError:(e,t,i)=>{"NotReadableError"===e.name?t():i(e)},onRetrying:e=>{Oo.warn(`getUserMedia NotReadableError observed, retrying [${e}/3]`)}});function Xl(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return ma(e.microphoneId)||(t.deviceId=e.microphoneId),{audio:t,video:!1}}function Yl(e){let t={},i={width:St?{max:e.width}:{ideal:e.width,max:e.width},height:St?{max:e.height}:{ideal:e.height,max:e.height},frameRate:e.frameRate};return t.video=i,ma(e.audioConstraints)||(t.audio=e.audioConstraints),t}const Zl=new Map([["120p",{width:160,height:120,frameRate:15,bitrate:200}],["120p_2",{width:160,height:120,frameRate:15,bitrate:100}],["180p",{width:320,height:180,frameRate:15,bitrate:350}],["180p_2",{width:320,height:180,frameRate:15,bitrate:150}],["240p",{width:320,height:240,frameRate:15,bitrate:400}],["240p_2",{width:320,height:240,frameRate:15,bitrate:200}],["360p",{width:640,height:360,frameRate:15,bitrate:800}],["360p_2",{width:640,height:360,frameRate:15,bitrate:400}],["480p",{width:640,height:480,frameRate:15,bitrate:900}],["480p_2",{width:640,height:480,frameRate:15,bitrate:500}],["720p",{width:1280,height:720,frameRate:15,bitrate:1500}],["1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}],["1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}],["4K",{width:3840,height:2160,frameRate:30,bitrate:9e3}]]),eh=new Map([["480p",{width:640,height:480,frameRate:5,bitrate:900}],["480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}],["720p",{width:1280,height:720,frameRate:5,bitrate:1200}],["720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}],["1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}],["1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3}]]),th=new Map([["standard",{sampleRate:48e3,channelCount:1,bitrate:40}],["standard-stereo",{sampleRate:48e3,channelCount:2,bitrate:64}],["high",{sampleRate:48e3,channelCount:1,bitrate:128}],["high-stereo",{sampleRate:48e3,channelCount:2,bitrate:192}]]);var ih,sh,nh,rh,ah,oh,ch;let dh=(ih=Ul(...xl.LOCAL_STREAM.switchDevice),sh=Ul(xl.STREAM.addTrack),nh=Ul(xl.STREAM.removeTrack),rh=Ul(xl.STREAM.replaceTrack),ah=ql({retries:10,timeout:3e3,onRetryFailed(e){sd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:ls,error:e}),this.emitter_.emit(ol,new gc({code:mc.DEVICE_AUTO_RECOVER_FAILED,message:e.message}))}}),oh=Vl(xl.LOCAL_STREAM.setAudioCaptureVolume),e((ch=class extends jl{constructor(e){super({...e,isRemote:!1,type:"local"}),this.name_=Fs,this.client_=null,this.video_=e.video,this.audio_=e.audio,this.cameraId_=e.cameraId,this.cameraGroupId_="",this.facingMode_=e.facingMode,this.microphoneId_=e.microphoneId,this.microphoneGroupId_="",this.videoSource_=e.videoSource,this.audioSource_=e.audioSource,this.screen_=e.screen,this.screenAudio_=e.screenAudio,this.audioProfile_={echoCancellation:!!ma(e.echoCancellation)||e.echoCancellation,autoGainControl:!!ma(e.autoGainControl)||e.autoGainControl,noiseSuppression:!!ma(e.noiseSuppression)||e.noiseSuppression,sampleRate:48e3,channelCount:1,bitrate:40},this.videoProfile_=Zl.get("480p_2"),this.screenProfile_=eh.get("1080p"),this.videoSetting_=null,this.muteState_={video:!1,audio:!1,auxVideo:!1},this.beautyStatus_=!1,this.prevAudioRecoverTime_=0,this.prevVideoRecoverTime_=0,this.isAudioRecovering_=!1,this.isVideoRecovering_=!1,this.initState(),this.canvas_=null,this.canvasInterval_=null,this.canvasTrack_=null,this.gain_={audioTrack:null,source:null,gainNode:null},this.captureVolume_=100,this.log_.info("stream created: "+this.id_)}initState(){this.isAddingTrack_=!1,this.isRemovingTrack_=!1,this.setIsReadyToPublish(!1),this.setPublishState(As)}installEvents(){super.installEvents(),Va.on(Io,this.onVideoTrackStopped,this),Va.on(fo,this.onVideoTrackStopped,this),Va.on(Eo,this.onAudioTrackStopped,this),Va.on(bo,this.onAudioTrackStopped,this)}uninstallEvents(){super.uninstallEvents(),Va.off(Io,this.onVideoTrackStopped,this),Va.off(fo,this.onVideoTrackStopped,this),Va.off(Eo,this.onAudioTrackStopped,this),Va.off(bo,this.onAudioTrackStopped,this)}initialize(){return new Promise(((e,t)=>{if(Hd())t(new gc({code:mc.INVALID_OPERATION,message:aa({key:Pr})}));else{if(ma(this.audio_)){const t=new MediaStream;return ma(this.audioSource_)||(t.addTrack(this.audioSource_),this.updateAudioPlayingState(!0)),ma(this.videoSource_)||(t.addTrack(this.videoSource_),this.updateVideoPlayingState(!0)),this.setMediaStream(t),sd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:os,kind:"custom"}),this.setIsReadyToPublish(!0),e()}this.screen_?(this.log_.info("initialize stream audio: "+this.audio_+" screenAudio: "+this.screenAudio_+" screen: "+this.screen_),async function(e){if(Bd())return;let t=null;if(mt&&gt<74||St){const i=Yl(e);Oo.info("getDisplayMedia with constraints: "+JSON.stringify(i));let s=await navigator.mediaDevices.getDisplayMedia(i);if(e.screenAudio)return Oo.warn("Your browser not support capture system audio"),s;if(e.audio){const i=Xl(e);return Oo.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),s.addTrack(t.getAudioTracks()[0]),s}return s}if(e.screenAudio){e.audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100};const t=Yl(e);return Oo.info("getDisplayMedia with constraints: "+JSON.stringify(t)),await navigator.mediaDevices.getDisplayMedia(t)}{const i=Yl(e);Oo.info("getDisplayMedia with constraints: "+JSON.stringify(i));let s=await navigator.mediaDevices.getDisplayMedia(i);if(e.audio){const i=Xl(e);return Oo.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),s.addTrack(t.getAudioTracks()[0]),s}return s}}({audio:this.audio_,screenAudio:this.screenAudio_,microphoneId:this.microphoneId_,width:this.screenProfile_.width,height:this.screenProfile_.height,frameRate:this.screenProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation}).then((t=>{this.setMediaStream(t),this.updateAudioPlayingState(this.audio_||this.screenAudio_),this.updateVideoPlayingState(!0);const i=this.getVideoTrack();return this.listenForScreenSharingStopped(i),this.setVideoContentHint(Kt),this.updateDeviceIdInUse(),this.setIsReadyToPublish(!0),this.log_.info(JSON.stringify(i.getSettings())),sd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:os,kind:"getDisplayMedia"}),e()})).catch((e=>{sd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:os,kind:"getDisplayMedia",error:e}),this.log_.error("getDisplayMedia error observed "+e),t(e instanceof gc?e:new gc({code:mc.INITIALIZE_FAILED,name:e.name,message:e.message}))}))):(Va.emit(_o,{stream:this,audio:this.audio_,video:this.video_}),this.log_.info("initialize stream audio: "+this.audio_+" video: "+this.video_),Ql({audio:this.audio_,video:this.video_,facingMode:this.facingMode_,cameraId:this.cameraId_,microphoneId:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation}).then((t=>(Va.emit(mo,{stream:this,audio:this.audio_,video:this.video_}),this.setMediaStream(t),t.getTracks().forEach((e=>{e.kind===Pt&&Zd&&(this.videoSetting_=e.getSettings()),el&&this.log_.info(`${e.kind} capabilities: ${JSON.stringify(e.getCapabilities())}`)})),this.updateAudioPlayingState(this.audio_),this.updateVideoPlayingState(this.video_),this.updateDeviceIdInUse(),this.log_.info("gotStream hasAudio: "+this.hasAudio()+" hasVideo: "+this.hasVideo()),this.setIsReadyToPublish(!0),sd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:os,kind:"getUserMedia"}),e()))).catch((e=>{Va.emit(go,{stream:this,audio:this.audio_,video:this.video_,error:e}),sd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:os,kind:"getUserMedia",error:e}),this.log_.error("getUserMedia error observed "+e),t(e)})))}}))}listenForScreenSharingStopped(e){e.addEventListener("ended",(e=>{this.log_.info("screen sharing was stopped because the video track is ended"),this.emitter_.emit(nl)}))}muteAudio(){const e=super.muteAudio();return e&&(this.log_.info("localStream mute audio"),this.sendMutedFlag(Dt,!0)),e}muteVideo(){const e=super.muteVideo();return e&&(this.log_.info("localStream mute video"),this.sendMutedFlag(Pt,!0)),e}unmuteAudio(){const e=super.unmuteAudio();return e&&(this.log_.info("localStream unmute audio"),this.sendMutedFlag(Dt,!1)),e}unmuteVideo(){const e=super.unmuteVideo();return e&&(this.log_.info("localStream unmute video"),this.sendMutedFlag(Pt,!1)),e}sendMutedFlag(e,t){this.setMuteState(e,t);const i=this.getConnection();if(i){i.sendMutedFlag(this.muteState_,this);const s=i.getUserId(),n=i.getTinyId();let r,a=`${t?Ft:jt} local ${e} track`;r=e===Dt?t?Tc:bc:t?Ic:Ec,ed(s,{eventId:r,eventDesc:a,timestamp:fe(),userId:s,tinyId:n})}}setMuteState(e,t){this.muteState_[e]=t,this.log_.info(`set ${e} muted state: [${t?"mute":"unmute"}]`)}setAudioProfile(e){let t;"object"==typeof e?t=e:(t=th.get(e),void 0===t&&(t=th.get("standard"))),this.log_.info("setAudioProfile: "+JSON.stringify(t)),this.audioProfile_={...this.audioProfile_,...t}}async setVideoProfile(e){if(this.connection_&&!jd())throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:Mr})});let t;ha(e)?t={...this.videoProfile_,...e}:ga(e)&&(t=Zl.get(e),ma(t)&&(t=Zl.get("480p_2"))),t&&t.width*t.height>921600&&Et&&(t.width=1280,t.height=720,this.log_.warn("reset to 1280 * 720 on iOS 13~14")),this.log_.info("setVideoProfile "+JSON.stringify(t));const i=this.getVideoTrack();i&&await i.applyConstraints(t);const s=this.videoProfile_.bitrate!==t.bitrate;this.videoProfile_=t,s&&this.connection_&&(await this.connection_.setBandwidth({bandwidth:t.bitrate,type:Pt,videoType:Lt}),this.connection_.sendMediaSettings(this))}getVideoBitrate(){return this.screen_?this.screenProfile_.bitrate:this.videoProfile_.bitrate}getAudioBitrate(){return this.audioProfile_.bitrate}setScreenProfile(e){let t=e;ga(e)&&(t=eh.get(e)||eh.get("1080p")),this.log_.info("setScreenProfile "+JSON.stringify(e)),this.screenProfile_=t}getVideoProfile(){return this.screen_?this.screenProfile_:this.videoProfile_}getAudioProfile(){return this.audioProfile_}setVideoContentHint(e){const t=this.getVideoTrack();t&&"contentHint"in t&&(this.log_.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.log_.warn("Invalid video track contentHint: "+e))}async switchDevice(e,t){if(!this.mediaStream_||this.microphoneId_===t||this.cameraId_===t||this.facingMode_===t)return;const i=e===Dt,s=e===Pt;if(this.setIsReadyToPublish(!1),this.log_.info("switchDevice "+e+" to: "+t),i){const e=this.getAudioTrack(),t=this.getMicrophoneTrackMixed();e&&e.stop(),t&&t.stop()}if(s){const e=this.getVideoTrack();if(e&&e.stop(),rt){const e=this.getAudioTrack();e&&(this.log_.info("stop audio track first in huawei env"),e.stop())}}try{const e=await Ql({audio:i||rt,video:s,facingMode:t===Ut||t===$t?t:void 0,cameraId:s?t:this.cameraId_,microphoneId:i?t:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,useExact:!0});let n=null;if(i){const t=e.getAudioTracks()[0];if(t&&this.isAudioTrackMixed()){const e=this.getAudioTrack(),i=ou.AudioMixerPlugin.getAudioTrackMap();n=ou.AudioMixerPlugin.mix({targetTrack:t,sourceList:i.get(e.id).sourceList,trackList:i.get(e.id).trackList})}else n=t}else{n=e.getVideoTracks()[0],n&&this.isVideoTrackBeautified()&&(n=await this.generateBeautyTrack(n));const t=e.getAudioTracks()[0];t&&rt&&await this.replaceTrack(t)}await this.replaceTrack(n),this.updateDeviceIdInUse();const r=this.getConnection();if(r){const e=r.getUserId(),t=r.getTinyId();let s=wc,n="switch camera";i&&(s=Ac,n="switch microphone"),ed(e,{eventId:s,eventDesc:n,timestamp:fe(),userId:e,tinyId:t})}this.log_.info(`switch ${i?"microphone":"camera"} success `),i&&(this.audio_=!0),s&&(this.video_=!0,t!==$t&&t!==Ut||(this.facingMode_=t)),this.setIsReadyToPublish(!0)}catch(n){throw this.log_.error(n),i?this.recoverCapture({audio:!0,video:!1,microphoneId:this.microphoneId_}):this.recoverCapture({audio:!1,video:!0,cameraId:this.cameraId_,facingMode:this.facingMode_}),n}}async addTrack(e){try{if(e.kind===Pt&&Zd){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}this.isAddingTrack_=!0,this.keepMuteState(e),this.mediaStream_.addTrack(e);const t=this.getConnection();if(t){let i=null;e.kind===Pt&&(bt||It)&&Ta(e)&&(i=this.getCanvasTrack()),await t.addTrack(i||e,this)}e.kind===Dt?(this.audio_=!0,this.updateAudioPlayingState(!0)):(this.video_=!0,this.updateVideoPlayingState(!0)),this.isAddingTrack_=!1}catch(t){throw this.mediaStream_.removeTrack(e),this.isAddingTrack_=!1,t}}async removeTrack(e){try{this.isRemovingTrack_=!0;const t=this.getConnection();t&&(e.kind===Pt&&(bt||It)&&this.canvasTrack_?(await t.removeTrack(this.canvasTrack_,this),this.clearCanvas()):await t.removeTrack(e,this)),this.mediaStream_.removeTrack(e),e.kind===Dt?(this.audio_=!1,this.updateAudioPlayingState(!1)):(this.video_=!1,this.updateVideoPlayingState(!1)),this.isRemovingTrack_=!1}catch(t){throw this.isRemovingTrack_=!1,t}}async replaceTrack(e){if(e.kind===Pt&&Zd){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}this.keepMuteState(e);const t=this.mediaStream_;if(e.kind===Dt){if(t.removeTrack(t.getAudioTracks()[0]),t.addTrack(e),super.restartAudio(),this.gain_.gainNode)return void this.reconnectGainNode(e)}else t.removeTrack(t.getVideoTracks()[0]),t.addTrack(e),super.restartVideo();const i=this.getConnection();if(i){if(e.kind===Pt&&(bt||It)&&this.canvasTrack_)return;await i.replaceTrack(e,this)}}async recoverCapture(e){if(!this.mediaStream_)return;this.log_.warn("recoverCapture() trying "+JSON.stringify(e));let t=this.audio_&&e.audio,i=this.video_&&e.video;try{const r=await ou.getCameras(),a=await ou.getMicrophones();if(i&&0===r.length&&(i=!1,this.log_.warn("recoverCapture() video flag is true, but no camera detected, set video to false")),t&&0===a.length&&(t=!1,this.log_.warn("recoverCapture() audio flag is true, but no microphone detected, set audio to false")),!1===t&&!1===i)return void this.log_.warn("recoverCapture() both audio and video are false, aborted");const o=e&&r.findIndex((({deviceId:t})=>t===e.cameraId))>=0,c=e&&a.findIndex((({deviceId:t})=>t===e.microphoneId))>=0,d=(await Ql({audio:t,video:i,cameraId:o?e.cameraId:void 0,microphoneId:c?e.microphoneId:void 0,facingMode:this.facingMode_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount})).getTracks();for(let e=0;e<d.length;e++){const t=d[e];if(t.kind===Dt&&this.isAudioTrackMixed()){const e=this.getAudioTrack(),i=ou.AudioMixerPlugin.getAudioTrackMap().get(e.id);if(!i.hasMicrophone){t.stop();continue}const s=ou.AudioMixerPlugin.mix({targetTrack:t,sourceList:i.sourceList,trackList:i.trackList});await this.replaceTrack(s)}else if(t.kind===Pt&&this.isVideoTrackBeautified()){const e=await this.generateBeautyTrack(t);await this.replaceTrack(e)}else{var s,n;if(t.kind===Dt)null===(s=this.getAudioTrack())||void 0===s||s.stop();if(t.kind===Pt)null===(n=this.getVideoTrack())||void 0===n||n.stop();await this.replaceTrack(t)}}this.updateDeviceIdInUse(),sd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:ls}),this.log_.warn("recoverCapture() successfully"),this.emitter_.emit(al,{isCamera:e.video,isMicrophone:e.audio,cameraId:this.cameraId_,microphoneId:this.microphoneId_})}catch(r){throw this.log_.warn("recoverCapture() failed, "+r),r}}updateDeviceIdInUse(){if(!this.mediaStream_)return this.cameraId_="",this.cameraGroupId_="",this.microphoneId_="",void(this.microphoneGroupId_="");if(Zd){this.mediaStream_.getTracks().forEach((e=>{if(e.kind===Dt&&this.isAudioTrackMixed()){const e=this.getMicrophoneTrackMixed();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.microphoneId_=t,this.microphoneGroupId_=i)}return}if(e.kind===Pt&&this.isVideoTrackBeautified()){const e=this.getBeautyOriginTrack();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.cameraId_=t,this.cameraGroupId_=i)}return}const{deviceId:t,groupId:i}=e.getSettings();t&&(e.kind===Dt?(this.microphoneId_=t,this.microphoneGroupId_=i):e.kind!==Pt||this.screen_||(this.cameraId_=t,this.cameraGroupId_=i))}))}const e=this.mediaStream_.getAudioTracks(),t=this.mediaStream_.getVideoTracks();e&&0===e.length&&(this.microphoneId_="",this.microphoneGroupId_=""),t&&0===t.length&&(this.cameraId_="",this.cameraGroupId_="")}isAudioTrackMixed(){if(ou.AudioMixerPlugin){const e=ou.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id))return!0}return!1}getMicrophoneTrackMixed(){if(ou.AudioMixerPlugin){const e=ou.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id)){const i=e.get(t.id);return i.hasMicrophone?i.microphoneTrack:null}}return null}isVideoTrackBeautified(){if(ou.beautyTrackMap){const e=ou.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id))return!0}return!1}getBeautyOriginTrack(){if(ou.beautyTrackMap){const e=ou.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id)){const i=e.get(t.id);if(i.originTrack)return i.originTrack}}return null}async generateBeautyTrack(e){let t=null;const i=this.getVideoTrack(),s=ou.beautyTrackMap.get(i.id),n=s.param;if(s.type)switch(s.type){case"beauty":t=s.pluginInstance.generateBeautyTrack(e);break;case"virtual":t=await s.pluginInstance.generateVirtualTrack({videoTrack:e,type:n.type,img:n.img});break;case"mixed":t=await s.pluginInstance.generateMixedTrack({videoTrack:e,type:n.type,img:n.img})}else t=s.pluginInstance.generateBeautyTrack(e);return s.pluginInstance.deleteSource(i.id),this.log_.info(`regenerate beauty track, track id = ${e.id}`),t}getScreen(){return this.screen_}hasScreenTrack(){if(this.screen_)return!0;const e=this.getVideoTrack();return!!e&&(e.contentHint===Kt||e.contentHint===Qt)}getVideo(){return this.video_}getAudio(){return this.audio_}getCameraId(){return this.cameraId_}getMicrophoneId(){return this.microphoneId_}getMicrophoneGroupId(){return this.microphoneGroupId_}getIsReadyToPublish(){return this.isReadyToPublish_}setIsReadyToPublish(e){this.isReadyToPublish_=e}setPublishState(e){this.publishState_=e}setBeautyStatus(e){this.beautyStatus_=!!e}getBeautyStatus(){return this.beautyStatus_}syncMuteState(){const e=this.getAudioTrack(),t=this.getVideoTrack();if(e){const t=!e.enabled;this.setMuteState(Dt,t)}if(t){const e=!t.enabled;this.setMuteState(Pt,e)}this.connection_&&this.connection_.sendMutedFlag(this.muteState_,this)}keepMuteState(e){e instanceof MediaStreamTrack&&this.muteState_[e.kind]&&(e.enabled=!1,this.log_.warn(`prev ${e.kind} track is muted, keep mute state`))}async onVideoTrackStopped({stream:e,type:t}){if(e!==this||!this.video_||!this.cameraId_||this.isVideoRecovering_||(Ze&&St||Ce&&Number(Tt)>=15.1)&&t===Ft)return;if(Date.now()-this.prevVideoRecoverTime_<2e3)return void setTimeout((()=>this.onVideoTrackStopped({stream:e,type:t})),2e3);const i=this.getVideoTrack();if(i&&this.publishState_===Ps){const e=i.getSettings().deviceId;if((await ou.getCameras()).findIndex((t=>t.deviceId===e))<0)return}t===Ft?setTimeout((()=>{const e=this.getVideoTrack();null!=e&&e.muted&&"visible"===document.visibilityState&&this.recoverVideoCapture(t)}),1e3):this.recoverVideoCapture(t)}async onAudioTrackStopped({stream:e,type:t}){if(e!==this||!this.audio_||!this.microphoneId_||this.isAudioRecovering_||(Ze&&St||Ce&&Number(Tt)>=15.1)&&t===Ft)return;if(Date.now()-this.prevAudioRecoverTime_<2e3)return void setTimeout((()=>this.onAudioTrackStopped({stream:e,type:t})),2e3);const i=this.getAudioTrack();if(i&&this.publishState_===Ps){const{groupId:e,deviceId:t}=i.getSettings();if((await ou.getMicrophones()).findIndex((i=>i.deviceId===t&&(ma(e)||e===i.groupId)))<0)return}t===Ft?setTimeout((()=>{const e=this.getAudioTrack();null!=e&&e.muted&&"visible"===document.visibilityState&&this.recoverAudioCapture(t)}),1e3):this.recoverAudioCapture(t)}recoverAudioCapture(e){this.prevAudioRecoverTime_=Date.now(),sd.uploadEvent({log:`stat-local-audio-${e}`,userId:this.userId_}),this.isAudioRecovering_=!0,this.recoverCapture({audio:!0,video:!1,microphoneId:this.microphoneId_}).then((()=>{this.isAudioRecovering_=!1})).catch((()=>{this.isAudioRecovering_=!1}))}recoverVideoCapture(e){this.isVideoRecovering_||(this.prevVideoRecoverTime_=Date.now(),sd.uploadEvent({log:`stat-local-video-${e}`,userId:this.userId_}),this.isVideoRecovering_=!0,this.recoverCapture({audio:!1,video:!0,cameraId:this.cameraId_}).then((()=>{this.isVideoRecovering_=!1})).catch((()=>{this.isVideoRecovering_=!1})))}setAudioVolume(e){super.setAudioVolume(e)}clearCanvas(){this.canvasInterval_&&(Rd.clearTask(this.canvasInterval_),this.canvasInterval_=null,this.canvas_=null,this.canvasTrack_=null)}getCanvasTrack(){if(this.canvasTrack_)return this.canvasTrack_;this.log_.info("gen canvas track");const e=this.getVideoTrack(),{width:t,height:i,frameRate:s}=e.getSettings();this.canvas_=document.createElement("canvas");const n=this.canvas_.getContext("2d");this.canvas_.width=t,this.canvas_.height=i,this.canvasInterval_=Rd.run("raf",(()=>{if(this.hasVideo()){const e=this.getVideoTrack().getSettings();e.width===this.canvas_.width&&e.height===this.canvas_.height||(this.canvas_.width=e.width,this.canvas_.height=e.height)}this.videoPlayer_&&this.videoPlayer_.element_&&n.drawImage(this.videoPlayer_.element_,0,0,this.canvas_.width,this.canvas_.height)}),{fps:Math.max(15,s)});const r=this.canvas_.captureStream();return this.canvasTrack_=r.getVideoTracks()[0],this.canvasTrack_}setClient(e,t){e&&(this.log_.setUserId(e.getUserId()),this.log_.setSdkAppId(e.getSDKAppId()),t||this.syncMuteState()),this.client_=e}setAudioCaptureVolume(e=100){if(!this.hasAudio()||e<0||!Fd())return!1;if(this.captureVolume_===e)return!0;this.captureVolume_=e,this.log_.info("setCaptureVolume "+e),e/=100;const t=Aa();if(this.gain_.gainNode)this.gain_.gainNode.gain.value=e;else{var i;const s=new MediaStream;s.addTrack(this.getAudioTrack());const n=t.createMediaStreamDestination(),r=t.createMediaStreamSource(s),a=t.createGain();a.gain.value=e,r.connect(a),a.connect(n);const o=n.stream.getAudioTracks()[0],c=e=>this.log_.info(`gained audio track ${e}`);o.onmute=()=>c("muted"),o.onunmute=()=>c("unmuted"),o.onended=()=>c("ended"),this.gain_={source:r,audioTrack:o,gainNode:a},null===(i=this.connection_)||void 0===i||i.replaceTrack(o),super.restartAudio()}return!0}getGainedTrack(){return this.gain_.audioTrack}reconnectGainNode(e){this.log_.warn("reconnect gain node");const t=new MediaStream;t.addTrack(e);const i=Aa().createMediaStreamSource(t);i.connect(this.gain_.gainNode),this.gain_.source.disconnect(),this.gain_.source=i}close(){this.setIsReadyToPublish(!1);const{audioTrack:e,source:t,gainNode:i}=this.gain_;i&&(t.disconnect(),i.disconnect(),e.onmute=null,e.onunmute=null,e.onended=null,e.stop(),this.gain_={source:null,gainNode:null,audioTrack:null}),super.close()}}).prototype,"switchDevice",[ih],Object.getOwnPropertyDescriptor(ch.prototype,"switchDevice"),ch.prototype),e(ch.prototype,"addTrack",[sh],Object.getOwnPropertyDescriptor(ch.prototype,"addTrack"),ch.prototype),e(ch.prototype,"removeTrack",[nh],Object.getOwnPropertyDescriptor(ch.prototype,"removeTrack"),ch.prototype),e(ch.prototype,"replaceTrack",[rh],Object.getOwnPropertyDescriptor(ch.prototype,"replaceTrack"),ch.prototype),e(ch.prototype,"recoverCapture",[ah],Object.getOwnPropertyDescriptor(ch.prototype,"recoverCapture"),ch.prototype),e(ch.prototype,"setAudioCaptureVolume",[oh],Object.getOwnPropertyDescriptor(ch.prototype,"setAudioCaptureVolume"),ch.prototype),ch);var lh,hh;const uh={voiceActivityDetection:!1};let ph=(lh=ql({retries:1,timeout:0,onRetrying(e){this.log_.warn(`connection timeout, retrying [${e}]`)},onError(e,t,i){e.message.includes("timeout")?(this.reset(),this.initialize(),t()):i(e)}}),hh=class extends Dl{constructor(e){super(e),this.localStream_=null,this.exchangeSDPTimeout_=-1,this.localAuxStream_=null,this.publishingStream_=null,this.isPublishingAuxStream_=!1,this.smallGenerator_=null,this.isSDPExchanging_=!1,this.ssrc_={audio:0,video:0,small:0,auxiliary:0},this.mediaSettings_={videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0},this.mixedAudioTrack_=null}get isMainStreamPublished(){return!!this.localStream_}get isAuxStreamPublished(){return!!this.localAuxStream_}get publishState(){const e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this.peerConnection_){const r=this.peerConnection_.getSenders();var t,i,s,n;if(r)if(Ud())e.audio=!(null===(t=r[0])||void 0===t||!t.track),e.bigVideo=!(null===(i=r[1])||void 0===i||!i.track),e.smallVideo=!(null===(s=r[2])||void 0===s||!s.track),e.auxVideo=!(null===(n=r[3])||void 0===n||!n.track);else r.forEach((t=>{t.track&&(t.track.kind===Dt?e.audio=!0:(e.bigVideo=!0,this.smallGenerator_&&(e.smallVideo=!0)))}))}return e}initialize(){super.initialize(),this.installEvents()}reset(){this.isReconnecting_&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.clearExchangeSDPTimeout(),this.localStream_&&this.localStream_.clearCanvas()}close(){super.close(),this.reset(),this.emitConnectionStateChangedEvent(Mi),this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null)}installEvents(){this.emitter_.on(tl.ERROR,this.handleError,this),this.emitter_.on(tl.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}uninstallEvents(){this.emitter_.off(tl.ERROR,this.handleError,this),this.emitter_.off(tl.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}async publish(e,t){var i;this.publishingStream_=e,this.isPublishingAuxStream_=t;let s=null;return e.getVideoTrack()&&!t&&this.client_.getIsEnableSmallStream()&&(this.smallGenerator_=new zl(e),await this.smallGenerator_.initialize(),s=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_)),this.updateMediaSettings(e,t),$d()?await this.publishByTransceiver(e,s,t):await this.publishByAddTrack(e,s),this.publishingStream_=null,this.isPublishingAuxStream_=!1,t?this.localAuxStream_=e:this.localStream_=e,null===(i=this.sei_)||void 0===i||i.handleEncodedStreams(),e}async publishByTransceiver(e,t,i){this.log_.info("publish by transceiver");const s=e.getMediaStream(),n=e.getAudioTrack(),r=e.getVideoTrack();let a=null;(bt||It)&&Ta(r)&&(a=e.getCanvasTrack());const o=this.peerConnection_.getTransceivers();if(0===o.length)this.peerConnection_.addTransceiver(n||Dt,{direction:ci,streams:[s]}),this.peerConnection_.addTransceiver(i?Pt:a||r||Pt,{direction:ci,streams:[s]}),this.peerConnection_.addTransceiver(t||Pt,{direction:ci,streams:[s]}),this.peerConnection_.addTransceiver(i?a||r:Pt,{direction:ci,streams:[s]}),await this.connect();else{const s=[];if(n&&(o[0].sender.track?(this.mixAudioTrack(o[0].sender.track,n),await o[0].sender.replaceTrack(this.mixedAudioTrack_)):(await o[0].sender.replaceTrack(n),s.push(0)),await this.setBandwidth({bandwidth:e.getAudioBitrate(),type:Dt})),r){const n=i?3:1;await o[n].sender.replaceTrack(a||r),await this.setBandwidth({bandwidth:e.getVideoBitrate(),type:Pt,videoType:i?Ot:Lt}),s.push(n),t&&(await o[2].sender.replaceTrack(t),await this.setBandwidth({bandwidth:this.client_.smallStreamConfig.bitrate,type:Pt,videoType:Mt}),s.push(2))}await this.setTransceiverDirection(ci,s),await this.doPublishChange()}}async publishByAddTrack(e,t){this.log_.info("publish by addtrack");const i=e.getMediaStream(),s=e.getAudioTrack(),n=e.getVideoTrack();if(s&&this.peerConnection_.addTrack(s,i),n&&(this.peerConnection_.addTrack(n,i),t)){const e=new MediaStream;e.addTrack(t),this.peerConnection_.addTrack(t,e)}await this.connect()}async unpublish(e){if(!Ud())return this.doUnpublish();const t=e.getAudioTrack(),i=e===this.localAuxStream_,s=this.peerConnection_.getSenders(),n=[];t&&(this.mixedAudioTrack_?(this.log_.info("has mixed audioTrack, use another audioTrack"),await s[0].replaceTrack(i?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack()),this.destroyMixedAudioTrack()):(await s[0].replaceTrack(null),n.push(0))),i?(await s[3].replaceTrack(null),this.localAuxStream_=null,this.mediaSettings_={...this.mediaSettings_,auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0},n.push(3)):(await s[1].replaceTrack(null),await s[2].replaceTrack(null),this.localStream_=null,this.mediaSettings_={...this.mediaSettings_,videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0},n.push(1,2)),this.localStream_||this.localAuxStream_?(await this.setTransceiverDirection(oi,n),await this.doPublishChange()):await this.doUnpublish()}async doPublishChange(){const e={state:this.publishState,constraintConfig:this.mediaSettings_};await this.signalChannel_.sendWaitForResponse({command:Qo,data:e,responseCommand:qo.PUBLISH_STATE_CHANGE_RESULT})}doUnpublish(){return this.signalChannel_.sendWaitForResponse({command:ic,commandDesc:"unpublish",responseCommand:qo.UNPUBLISH_RESULT}).then((()=>{this.close()})).catch((()=>{this.close()}))}updateMediaSettings(e,t){this.localAuxStream_&&e===this.localAuxStream_&&(t=!0);const{detail:{isH264EncodeSupported:i,isVp8EncodeSupported:s}}=this.client_.getSystemResult();if(i?this.mediaSettings_.videoCodec="H264":s&&(this.mediaSettings_.videoCodec="VP8"),Zd){e.getMediaStream().getTracks().forEach((i=>{const s=i.getSettings();if(i.kind===Dt){let t=1;s.channelCount&&(t=s.channelCount),this.mediaSettings_.audioChannel=t,this.mediaSettings_.audioBps=1e3*e.getAudioBitrate(),this.mediaSettings_.audioFs=s.sampleRate}else if(i.kind===Pt){if(t)return this.mediaSettings_.auxVideoWidth=s.width,this.mediaSettings_.auxVideoHeight=s.height,this.mediaSettings_.auxVideoFps=s.frameRate,void(this.mediaSettings_.auxVideoBps=1e3*e.getVideoBitrate());this.client_.getIsEnableSmallStream()&&(this.mediaSettings_.smallVideoWidth=this.client_.smallStreamConfig.width,this.mediaSettings_.smallVideoHeight=this.client_.smallStreamConfig.height,this.mediaSettings_.smallVideoFps=this.client_.smallStreamConfig.frameRate,this.mediaSettings_.smallVideoBps=1e3*this.client_.smallStreamConfig.bitrate),this.mediaSettings_.videoWidth=s.width,this.mediaSettings_.videoHeight=s.height,this.mediaSettings_.videoFps=s.frameRate,this.mediaSettings_.videoBps=1e3*e.getVideoBitrate()}}))}else this.updateMediaSettingsFromProfile(e);this.log_.info("updateMediaSettings: "+JSON.stringify(this.mediaSettings_))}updateMediaSettingsFromProfile(e){if(e){if(e.hasAudio()){const t=e.getAudioProfile();this.mediaSettings_.audioChannel=t.channelCount,this.mediaSettings_.audioBps=1e3*t.bitrate,this.mediaSettings_.audioFs=t.sampleRate}if(e.hasVideo()){const t=e.getVideoProfile();this.mediaSettings_.videoWidth=t.width,this.mediaSettings_.videoHeight=t.height,this.mediaSettings_.videoFps=t.frameRate,this.mediaSettings_.videoBps=1e3*t.bitrate}}}sendMediaSettings(e){this.updateMediaSettings(e),this.signalChannel_.sendWaitForResponse({command:_c,data:this.mediaSettings_,responseCommand:qo.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this.log_.warn(e.data.message)})).catch(this.log_.warn)}async addTrack(e,t){var i;if(!this.peerConnection_)return;const s=t===this.localAuxStream_;this.log_.info(`is adding ${e.kind} track to current published local ${s?Ot:Xt} stream`),null===(i=this.sei_)||void 0===i||i.handleEncodedStreams(),Ud()?await this.addTrackByTransceiver(e,t):await this.addTrackBySender(e),ed(this.userId_,{eventId:e.kind===Dt?Sc:fc,eventDesc:`add ${e.kind} track to current published stream`,timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_})}async addTrackByTransceiver(e,t){const i=t===this.localAuxStream_,s=this.peerConnection_.getTransceivers();if(e.kind===Dt)s[0].sender.track?(this.mixAudioTrack(s[0].sender.track,e),await s[0].sender.replaceTrack(this.mixedAudioTrack_)):await s[0].sender.replaceTrack(e);else{const t=i?3:1;if(await s[t].sender.replaceTrack(e),1===t&&this.client_.getIsEnableSmallStream()){this.smallGenerator_=new zl(this.localStream_),await this.smallGenerator_.initialize();let e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);await s[2].sender.replaceTrack(e)}s[t].direction===oi&&await this.setTransceiverDirection(ci,[t])}this.updateMediaSettings(t,i),await this.doPublishChange()}async addTrackBySender(e){Ud()&&this.peerConnection_.getTransceivers().findIndex((e=>"stopped"===e.direction))>=0&&(this.log_.warn("transceiver is stopping, negotiate sdp first"),await this.updateOffer(ks.REMOVE,e));const t=this.peerConnection_.getSenders().find((t=>t.track&&t.track.kind===e.kind));if(t){this.log_.warn("sender already exists, remove sender first");const e=t.track;this.removeSender(t),await this.updateOffer(ks.REMOVE,e)}const i=this.localStream_.getMediaStream();if(this.peerConnection_.addTrack(e,i),e.kind===Pt&&this.client_.getIsEnableSmallStream()){this.smallGenerator_=new zl(this.localStream_),await this.smallGenerator_.initialize();let e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);const t=new MediaStream;t.addTrack(e),this.peerConnection_.addTrack(e,t)}await this.updateOffer(ks.ADD,e)}isNeedToResetOfferOrder(){if("plan-b"===this.sdpSemantics_||!this.peerConnection_||!this.peerConnection_.localDescription)return!1;const e=this.peerConnection_.localDescription.sdp,t=fd(e);for(let i=0;i<t.media.length;i++)if(0===t.media[i].mid&&t.media[i].type===Pt)return!0;return!1}removeSender(e){let t=null;Ud()&&(t=this.peerConnection_.getTransceivers().find((t=>t.sender&&t.sender.track===e.track))),this.peerConnection_.removeTrack(e),t&&_a(t.stop)&&(this.log_.info("stop transceiver"),t.stop())}async removeTrack(e,t){this.peerConnection_&&(this.log_.info(`is removing ${e.kind} track from current published local ${t===this.localAuxStream_?Ot:Xt} stream`),Ud()?await this.removeTrackByTransceiver(e,t):await this.removeTrackBySender(e),ed(this.userId_,{eventId:e.kind===Dt?yc:vc,eventDesc:`remove ${e.kind} track from current published stream`,timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_}))}async removeTrackByTransceiver(e,t){const i=t===this.localAuxStream_,s=this.peerConnection_.getTransceivers();if(e.kind===Dt)this.mixedAudioTrack_?(await s[0].sender.replaceTrack(i?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack()),this.destroyMixedAudioTrack()):await s[0].sender.replaceTrack(null);else{const e=i?3:1;await s[e].sender.replaceTrack(null),1===e&&this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null,await s[2].sender.replaceTrack(null)),await this.setTransceiverDirection(oi,[e])}this.updateMediaSettings(t,i),await this.doPublishChange()}async setTransceiverDirection(e,t){if(!ke)return;let i=!1,s=!1;this.log_.info(`setting transceiver ${t.join(",")} direction to ${e}`);const n=this.peerConnection_.getTransceivers();if(t.forEach((t=>{n[t].direction!==e&&(n[t].direction=e,i=!0)})),i){this.log_.info("updating offer");const e=await this.peerConnection_.createOffer();await this.peerConnection_.setLocalDescription(e)}let r=-1;const a=this.peerConnection_.remoteDescription.sdp.split("\r\n").map((i=>{if(i.match(new RegExp(`a=(${oi}|${di}|${ci})`))&&r++,t.includes(r)){if(e===oi&&i.includes(`a=${di}`))return s=!0,`a=${e}`;if(e===ci&&i.includes(`a=${oi}`))return s=!0,`a=${di}`}return i})).join("\r\n");s&&(this.log_.info("updating answer"),await this.peerConnection_.setRemoteDescription({type:"answer",sdp:a}))}async removeTrackBySender(e){var t;if(e.kind===Pt&&this.isNeedToResetOfferOrder())return this.reset(),this.initialize(),null===(t=this.localStream_.getMediaStream())||void 0===t||t.removeTrack(e),void(await this.publish(this.localStream_));const i=this.peerConnection_.getSenders().find((t=>t.track===e));i&&(this.removeSender(i),e.kind===Pt&&this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null,this.peerConnection_.getSenders().forEach((e=>{e.track&&e.track.kind===Pt&&this.removeSender(e)})))),await this.updateOffer(ks.REMOVE,e)}async replaceTrack(e,t){var i;const s=null===(i=this.peerConnection_)||void 0===i?void 0:i.getSenders();if(!s||0===s.length)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Yn})});const n=t===this.localAuxStream_;var r,a;if(this.log_.info(`is replacing ${e.kind} track to current published local ${n?Ot:Xt} stream`),e.kind===Dt&&s[0])if(this.mixedAudioTrack_&&null!==(r=this.localStream_)&&void 0!==r&&r.hasAudio()&&null!==(a=this.localAuxStream_)&&void 0!==a&&a.hasAudio()){this.destroyMixedAudioTrack();const t=n?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack();this.mixAudioTrack(e,t),await s[0].replaceTrack(this.mixedAudioTrack_)}else await s[0].replaceTrack(e);if(e.kind===Pt){if(t===this.localStream_&&s[1]&&(await s[1].replaceTrack(e),this.smallGenerator_&&s[2])){this.log_.info("replacing smallVideo"),this.smallGenerator_.destroy(),this.smallGenerator_=new zl(this.localStream_),await this.smallGenerator_.initialize();const e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);await s[2].replaceTrack(e)}t===this.localAuxStream_&&s[3]&&await s[3].replaceTrack(e)}ed(this.userId_,{eventId:e.kind===Dt?Pc:Dc,eventDesc:`replace ${e.kind} track from current published stream`,timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_})}async updateOffer(e,t){try{const i=await this.peerConnection_.createOffer(uh);ke&&(i.sdp=this.setSDPDirection(i.sdp,"sendrecv")),await this.peerConnection_.setLocalDescription(i);const s=this.updateMediaSettings(this.localStream_||this.localAuxStream_),n={action:e,trackId:t.id,kind:t.kind===Pt?"bigVideo":t.kind,type:"offer",sdp:this.peerConnection_.localDescription.sdp,constraintConfig:s,state:this.publishState};this.log_.info("createOffer success, sending updated offer to remote server"),this.log_.debug("updatedOffer: "+n.sdp);const r=await this.signalChannel_.sendWaitForResponse({command:Ko,data:n,responseCommand:qo.UPDATE_OFFER_RESULT,timeout:1e4,commandDesc:"update offer"}),{code:a,message:o}=r.data;0!==a&&this.checkPublishResultCode(a,o),await this.acceptAnswer(r.data.data),this.updateSSRC(i.sdp),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:ns,kind:"offer"})}catch(i){throw this.log_.error(i),sd.logFailedEvent({userId:this.client_.getUserId(),eventType:ns,kind:"offer",error:i}),i}}async setBandwidth({bandwidth:e,type:t,videoType:i="",sdp:s}){if(!jd()&&s)return t===Pt?this.updateVideoBandwidthRestriction(s,e,i):this.updateAudioBandwidthRestriction(s,e);let n=0;t===Pt&&(n=i===Mt?2:i===Ot?3:1);const r=this.peerConnection_.getSenders()[n];if(r){const n=r.getParameters();n.encodings&&0!==n.encodings.length||(n.encodings=[{}]),"unlimited"===e?delete n.encodings[0].maxBitrate:n.encodings[0].maxBitrate=1e3*e;try{return await r.setParameters(n),this.log_.info(i+t+" bandwidth was set to "+e+" kbps"),s}catch(a){if(this.log_.info("failed to set bandwidth by setting maxBitrate: "+a),s)return t===Pt?this.updateVideoBandwidthRestriction(s,e,i):this.updateAudioBandwidthRestriction(s,e)}}return s}updateVideoBandwidthRestriction(e,t,i){let s="AS";ke&&(s="TIAS",t*=1e3);let n=0,r=-1;return i===Mt?n=1:i===Ot&&(n=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,(e=>(r++,r===n?`${e}b=${s}:${t}\r\n`:e)))}updateAudioBandwidthRestriction(e,t){let i="AS";return ke&&(i="TIAS",t*=1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n")}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}async connect(){try{await this.exchangeSDP(),await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server"),await this.doExchangeSDP(),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){try{const e=await this.peerConnection_.createOffer(uh);await this.peerConnection_.setLocalDescription(e),this.updateSSRC(e.sdp),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:ns,kind:"offer"})}catch(e){throw sd.logFailedEvent({userId:this.client_.getUserId(),eventType:ns,kind:"offer",error:e}),e}}doExchangeSDP(){return new Promise(((e,t)=>{this.exchangeSDPTimeout_=setTimeout((()=>{this.signalChannel_.off(qo.PUBLISH_RESULT,i),this.clearExchangeSDPTimeout();const e=new gc({code:mc.API_CALL_TIMEOUT,message:aa({key:dn})});t(e)}),1e4);const i=async i=>{try{this.clearExchangeSDPTimeout();const{code:t,message:s}=i.data;0===t?(await this.acceptAnswer(i.data.data),e()):this.checkPublishResultCode(t,s)}catch(s){t(s)}},s={type:this.peerConnection_.localDescription.type,sdp:this.removeVideoOrientation(this.peerConnection_.localDescription.sdp),screen:(this.publishingStream_||this.localStream_).hasScreenTrack(),state:this.publishState,constraintConfig:this.mediaSettings_};this.signalChannel_.once(qo.PUBLISH_RESULT,i),this.log_.debug("sending sdp offer: "+s.sdp),this.signalChannel_.send(tc,s)}))}setSDPDirection(e,t,i="all"){const s=fd(e);return s.media.forEach((e=>{"all"!==i&&e.type!==i||(e.direction=t)})),Sd(s)}async acceptAnswer(e){try{let t=this.removeVideoOrientation(e.sdp);const i=this.publishingStream_||this.localStream_;if(i){const e=i.getVideoBitrate(),s=i.getAudioBitrate();if(e){const i=this.isPublishingAuxStream_?Ot:Lt;t=await this.setBandwidth({bandwidth:e,type:Pt,sdp:t,videoType:i})}s&&(t=await this.setBandwidth({bandwidth:s,type:Dt,sdp:t}))}if(this.client_.getIsEnableSmallStream()){const e=this.client_.smallStreamConfig;t=await this.setBandwidth({bandwidth:e.bitrate,type:Pt,videoType:Mt,sdp:t})}const s={type:e.type,sdp:t};await this.peerConnection_.setRemoteDescription(s),this.log_.debug("accepted answer: "+t),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:rs,kind:"answer"})}catch(t){throw sd.logFailedEvent({userId:this.client_.getUserId(),eventType:rs,kind:"answer",error:t}),this.log_.error("failed to accept remote answer "+t),t}}sendMutedFlag(e,t){if(t===this.localAuxStream_)return;const i={audio:e.audio,bigVideo:e.video,auxVideo:e.auxVideo};this.log_.info(`send muted state: ${JSON.stringify(i)}`),this.signalChannel_.send(ec,i)}getIsReconnecting(){return this.isReconnecting_}async reconnect(){if(-1===this.reconnectionTimer_){if(this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect uplink for 30 times, but all failed, please check your network"),this.stopReconnection();const e=new gc({code:mc.UPLINK_RECONNECTION_FAILED,message:aa({key:un})});return sd.logFailedEvent({userId:this.client_.getUserId(),eventType:ts,error:e}),this.addEventInternal(zc,"uplink-connection reconnect fail"),this.emitConnectionStateChangedEvent(Mi),void this.emitter_.emit(tl.ERROR,e)}if(this.signalChannel_.getCurrentState()!==Jo)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Fo,this.reconnect,this);this.reconnectionCount_++;try{this.log_.warn(`reconnect() try to reconnect uplink [${this.reconnectionCount_}/30]`);const e=pa(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect() uplink reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()}),e),this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===Ui)return;await this.signalChannel_.sendWaitForResponse({command:ic,responseCommand:qo.UNPUBLISH_RESULT,enableLog:!1}),this.reset(),this.initialize(),this.localStream_&&await this.publish(this.localStream_),this.localAuxStream_&&await this.publish(this.localAuxStream_,!0),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:ts}),this.log_.warn("reconnect() uplink reconnect successfully"),this.addEventInternal(Wc,"uplink-connection reconnect success"),this.stopReconnection(),this.localStream_.syncMuteState()}catch(e){}}else this.log_.warn("reconnect() uplink is reconnecting, ignore current reconnection")}clearExchangeSDPTimeout(){-1!==this.exchangeSDPTimeout_&&(clearTimeout(this.exchangeSDPTimeout_),this.exchangeSDPTimeout_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}handleError(e){e.getCode()===mc.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,sd.logFailedEvent({userId:this.client_.getUserId(),eventType:es,error:e})),this.isReconnecting_||this.startReconnection())}handleConnectionStateChange(e){e.state===xi&&this.isFirstConnection_&&(this.isFirstConnection_=!1,sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:es}),this.addEventInternal(Fc,"uplink-connection is connected"))}updateSSRC(e){try{fd(e).media.forEach(((e,t)=>{if(e.type===Dt){const t=e.ssrcs[0];t&&(this.ssrc_.audio=t.id)}else{if("plan-b"===this.sdpSemantics_)return void e.ssrcGroups.forEach(((e,t)=>{const i=Number(e.ssrcs.split(" ")[0]);0===t?this.ssrc_.video=i:1===t&&(this.ssrc_.small=i)}));const i=e.ssrcs[0];if(!i)return;switch(t){case 1:this.ssrc_.video=i.id;break;case 2:this.ssrc_.small=i.id;break;case 3:this.ssrc_.auxiliary=i.id}}}))}catch(t){}}getVideoTrackId(e=Pt){if(this.peerConnection_){const t=this.peerConnection_.getSenders();if(e===Ot&&t[3]&&t[3].track)return t[3].track.id;if(e===Pt&&t[1]&&t[1].track)return t[1].track.id}if(this.localStream_&&e===Pt){const e=this.localStream_.getVideoTrack();if(e)return e.id}if(this.localAuxStream_&&e===Ot){const e=this.localAuxStream_.getVideoTrack();if(e)return e.id}return""}getSSRC(){return this.ssrc_}checkPublishResultCode(e,t){if(0!==e)throw 1028===e?(this.log_.error(sa.NOT_SUPPORTED_H264ENCODE),new gc({code:mc.NOT_SUPPORTED_H264,message:aa({key:Lr})})):new gc({code:mc.UNKNOWN,message:aa({key:Br,data:{signalResponse:qo.PUBLISH_RESULT,code:e,message:t}})})}getLocalStream(){return this.localStream_}sendSEI(e,t){this.sei_.push(e,t)}mixAudioTrack(e,t){this.log_.info("mix audio track"),this.mixedAudioTrack_=function(e){const t=wa(),i=t.createMediaStreamDestination(),s=[];e.forEach((e=>{const n=new MediaStream;n.addTrack(e);const r=t.createMediaStreamSource(n);r.connect(i),s.push(r)}));const n=i.stream.getAudioTracks()[0];return Kl.set(n,{destination:i,track:n,mediaStreamSourceList:s}),n}([e,t])}destroyMixedAudioTrack(){this.mixedAudioTrack_&&(this.log_.info("destroy audio track"),function(e){if(Kl.has(e)){const{destination:t,track:i,mediaStreamSourceList:s}=Kl.get(e);i.stop(),t.disconnect(),s.forEach((e=>{e.disconnect()})),Kl.delete(e)}}(this.mixedAudioTrack_),this.mixedAudioTrack_=null)}},e(hh.prototype,"publish",[lh],Object.getOwnPropertyDescriptor(hh.prototype,"publish"),hh.prototype),hh);var _h,mh;let gh=(_h=ql({retries:1,timeout:0,onRetrying(e){this.log_.warn(`connection timeout, retrying [${e}]`)},onError(e,t,i){e.message.includes("timeout")?t():i(e)}}),mh=class extends Dl{constructor(e){super(e),this.remoteStreams_=new Map,this.autoSubscribe=e.autoSubscribe,this.trackState_={audio:e.trackState.audio,video:e.trackState.video,auxiliary:e.trackState.auxiliary,smallVideo:e.trackState.smallVideo},this.ssrc_={audio:0,video:0,auxiliary:0},this.subscribeState_={audio:e.autoSubscribe,video:e.autoSubscribe,auxiliary:e.autoSubscribe,smallVideo:!1},this.isSDPExchanging_=!1,this.installEvents()}get isMainStreamSubscribed(){return(this.subscribeState_.audio||this.subscribeState_.video||this.subscribeState_.smallVideo)&&(this.trackState_.audio||this.trackState_.video||this.trackState_.smallVideo)}get isAuxStreamSubscribed(){return this.subscribeState_.auxiliary&&this.trackState_.auxiliary}get isSmallStreamSubscribed(){return this.subscribeState_.smallVideo&&this.trackState_.smallVideo}get isBigStreamSubscribed(){return this.subscribeState_.video&&this.trackState_.video}isStreamUnpublished(e){return e.getType()===Xt?!this.trackState_.audio&&!this.trackState_.video:!this.trackState_.auxiliary}initialize(){super.initialize(),this.peerConnection_.ontrack=this.onTrack.bind(this)}close(){super.close(),this.trackState_.audio=!1,this.trackState_.video=!1,this.trackState_.smallVideo=!1,this.trackState_.auxiliary=!1,this.emitConnectionStateChangedEvent(Mi),this.remoteStreams_.forEach((e=>{const t=e;t.setConnection(null),t.uninstallEvents(),t.getIsStreamAddedEventEmitted()&&this.emitter_.emit(tl.STREAM_REMOVED,{stream:t})})),this.remoteStreams_.clear(),this.uninstallEvents()}installEvents(){Va.on(ro,this.onRemoteStreamUpdate,this),this.emitter_.on(tl.ERROR,(e=>{e.getCode()===mc.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,sd.logFailedEvent({userId:this.client_.getUserId(),eventType:is,error:e})),this.isReconnecting_||this.startReconnection())})),this.emitter_.on(tl.CONNECTION_STATE_CHANGED,(e=>{e.state===xi&&this.isFirstConnection_&&(this.isFirstConnection_=!1,sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:is}),this.addEventInternal(jc,"downlink-connection is connected"))}))}uninstallEvents(){Va.removeListener(ro,this.onRemoteStreamUpdate,this)}onRemoteStreamUpdate(e){if(this.hitTest(e.tinyId)&&e.client===this.client_){this.updateTrackState(e.action,e.kind);const t=e.kind===Ot?Ai:wi,i=this.remoteStreams_.get(t);if(!i)return;e.action===ks.ADD?this.handleRemoteAddTrack(e.kind,i):this.handleRemoteRemoveTrack(e.kind,i)}}handleRemoteAddTrack(e,t){this.log_.info(`remote add ${e} track`),e===Dt?t.updateAudioPlayingState(this.subscribeState_.audio):t.updateVideoPlayingState(e===Ot?this.subscribeState_.auxiliary:this.subscribeState_.video||this.subscribeState_.smallVideo),t.getIsStreamAddedEventEmitted()?this.emitter_.emit(tl.STREAM_UPDATED,{stream:t}):(this.emitter_.emit(tl.STREAM_ADDED,{stream:t}),this.currentState_===xi&&t.emitConnectionStateChanged({prevState:Mi,state:xi}))}handleRemoteRemoveTrack(e,t){t.getIsStreamAddedEventEmitted()&&(this.log_.info(`remote remove ${e} track`),e===Ot||!this.trackState_.audio&&!this.trackState_.video?(this.log_.info(`remote stream ${t.getType()} removed`),this.currentState_===xi&&t.emitConnectionStateChanged({prevState:xi,state:Mi}),this.emitter_.emit(tl.STREAM_REMOVED,{stream:t})):(e===Dt?t.updateAudioPlayingState(!1):(e!==Vt||this.isSmallStreamSubscribed)&&t.updateVideoPlayingState(!1),this.emitter_.emit(tl.STREAM_UPDATED,{stream:t})))}updateTrackState(e,t){const i=e===ks.ADD;switch(t){case Dt:this.trackState_.audio=i;break;case Pt:this.trackState_.video=i;break;case Ot:this.trackState_.auxiliary=i;break;case Vt:this.trackState_.smallVideo=i}this.log_.info(`trackState updated: ${JSON.stringify(this.trackState_)}`)}onTrack(e){const t=e.streams[0],i=e.track;if(this.log_.info(`ontrack() kind: ${i.kind} id: ${i.id} streamId: ${t.id}`),"unified-plan"===this.sdpSemantics_){const e=function(e){let t=rd.parse(e),i={audio:[],video:[]};return t.media.forEach((e=>{if(e.ssrcs){let t=e.ssrcs[0].id>>16&255;if(e.type===Dt)i.audio.push(wi);else if(e.type==Pt){const e=t===Di?wi:Ai;i.video.push(e)}}})),i}(this.peerConnection_.remoteDescription.sdp);if(i.kind===Dt){if(0===e.audio.length||t.id!==wi)return void this.log_.debug("skip this invalid audio track")}else if(-1===e.video.indexOf(t.id))return void this.log_.debug(`skip this invalid video track: ${i.id}  msid: ${t.id}`)}sd.logEvent({eventType:"ontrack",kind:i.kind});let s=!1,n=this.remoteStreams_.get(t.id);const r=t.id===wi?Pi:Ni;if(ma(n)&&(n=new Bl({type:r,userId:this.userId_,client:this.client_}),n.setConnection(this),this.remoteStreams_.set(t.id,n),s=!0),n.setMediaStream(t),i.kind===Dt?n.updateAudioPlayingState(this.subscribeState_.audio):r===Pi?n.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo):n.updateVideoPlayingState(this.subscribeState_.auxiliary),r===Ni&&!this.trackState_.auxiliary)return;if(r===Pi&&!this.trackState_.audio&&!this.trackState_.video)return;const a=this.client_.getSubscriptionManager();a&&a.hasAutoRecoveryFlag(this.userId_,r)||(s?this.emitter_.emit(tl.STREAM_ADDED,{stream:n}):this.emitter_.emit(tl.STREAM_UPDATED,{stream:n}))}addRRTRLine(e){const t=e.split("\r\n"),i=new Map;t.forEach(((e,s)=>{/^a=rtcp-fb:/.test(e)&&t[s+1]&&!/^a=rtcp-fb:/.test(t[s+1])&&i.set(s+1,e.match(/^a=rtcp-fb:\d+/)[0]+" rrtr")}));const s=[...i];for(let n=0;n<s.length;n++){let[e,i]=s[n];t.splice(e+n,0,i)}return t.join("\r\n")}addSPSDescription(e){const t=fd(e);return t.media.forEach((e=>{e.type===Pt&&e.fmtp.forEach((e=>{e.config+=";sps-pps-idr-in-keyframe=1"}))})),Sd(t)}removeSDESDescription(e){const t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=fd(e);return i.media.forEach((e=>{e.ext=e.ext.filter((e=>!t.includes(e.uri)))})),Sd(i)}isSubscriptionStateNotChanged(e,t){return e.getType()===Pi?(null==t?void 0:t.audio)===this.subscribeState_.audio&&(null==t?void 0:t.video)===this.subscribeState_.video&&this.isSubscribeSmall(t):e.getType()===Ni?!ma(t.video)&&this.subscribeState_.auxiliary===t.video:void 0}isSubscribeSmall(e){return ma(e.smallVideo)&&!this.subscribeState_.smallVideo}async subscribe(e,t){try{var i,s;const{emitEvent:n=!0}=t,r=e.getType();if((null===(i=this.peerConnection_)||void 0===i?void 0:i.connectionState)!==Vi&&(null===(s=this.peerConnection_)||void 0===s?void 0:s.connectionState)!==Ui||await this.waitForPeerConnectionConnected(),this.isSubscriptionStateNotChanged(e,t))return this.peerConnection_||(this.initialize(),await this.connect()),n&&ma(t.smallVideo)&&this.emitter_.emit(tl.STREAM_SUBSCRIBED,{stream:e,result:!0}),e;if(r===Xt?(ma(t.audio)||(this.subscribeState_.audio=t.audio),ma(t.video)||(this.subscribeState_.video=t.video),this.subscribeState_.smallVideo=(null==t?void 0:t.smallVideo)||!1,this.addEventInternal(this.subscribeState_.audio?Cc:kc,this.subscribeState_.audio?"subscribe audio":"unsubscribe audio"),this.addEventInternal(this.subscribeState_.video?Cc:kc,this.subscribeState_.video?"subscribe video":"unsubscribe video"),this.addEventInternal(this.subscribeState_.smallVideo?Xc:Yc,this.subscribeState_.smallVideo?"subscribe smallVideo":"unsubscribe smallVideo")):ma(t.video)||(this.subscribeState_.auxiliary=t.video),this.log_.info(`subscribe ${r} stream with options ${JSON.stringify(t)} current state: ${JSON.stringify(this.subscribeState_)}`),this.peerConnection_||this.isSDPExchanging_){let t=Ss;this.isMainStreamSubscribed||this.isAuxStreamSubscribed||(t=fs),await this.sendSubscription(t),r===Xt?(e.updateAudioPlayingState(this.subscribeState_.audio),e.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo)):e.updateVideoPlayingState(this.subscribeState_.auxiliary)}else this.initialize(),await this.connect();return n&&ma(t.smallVideo)&&this.emitter_.emit(tl.STREAM_SUBSCRIBED,{stream:e,result:!0}),e}catch(n){if(this.client_.getIsJoined()&&this.isStreamUnpublished(e))throw this.log_.warn(`${n.message} ${JSON.stringify(this.trackState_)}`),new gc({code:mc.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId_} unpublished stream`});throw n}}async unsubscribe(e){const t=e.getType();if(t===Xt){if(!this.isMainStreamSubscribed)return this.log_.info("main stream already unsubscribed"),e;this.subscribeState_.audio=!1,this.subscribeState_.video=!1,this.subscribeState_.smallVideo=!1}else{if(!this.isAuxStreamSubscribed)return this.log_.info("auxiliary stream already unsubscribed"),e;this.subscribeState_.auxiliary=!1}let i=fs;if((t===Pi&&this.isAuxStreamSubscribed||t===Ni&&this.isMainStreamSubscribed)&&(i=Ss),this.log_.info(`unsubscribe ${t} stream with ${JSON.stringify(this.subscribeState_)}`),await this.sendSubscription(i),e.updateVideoPlayingState(!1),e.updateAudioPlayingState(!1),i===fs){const t=e.getMediaStream();t&&t.getTracks().forEach((e=>t.removeTrack(e))),this.closePeerConnection(),this.emitConnectionStateChangedEvent(Mi)}return this.addEventInternal(kc,"unsubscribe audio"),this.addEventInternal(Rc,"unsubscribe video"),e}sendSubscription(e){let t={srcTinyId:this.tinyId_,srcUserId:this.userId_},i=nc,s=qo.UNSUBSCRIBE_RESULT;return e===Ss&&(t={audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo,srcTinyId:this.tinyId_},i=rc,s=qo.SUBSCRIBE_CHANGE_RESULT),this.signalChannel_.sendWaitForResponse({command:i,data:t,responseCommand:s,timeout:1e4}).then((({data:t})=>{if(0!==t.code){const i=new gc({code:t.code,message:aa({key:cn,data:{type:e,message:t.message}})});throw this.log_.error(i),i}}))}async connect(){try{await this.exchangeSDP(),await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server");const{type:e,sdp:t}=this.peerConnection_.localDescription,i={type:e,sdp:t,srcUserId:this.userId_,srcTinyId:this.tinyId_,audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo};Va.emit(Ro,{client:this.client_,connection:this,userId:this.userId_,tinyId:this.tinyId_,role:Ri,subscribeState:this.subscribeState_,trackState:this.trackState_});const s=await this.signalChannel_.sendWaitForResponse({command:sc,commandDesc:"exchange sdp",data:i,responseCommand:qo.SUBSCRIBE_RESULT,timeout:1e4});if(!this.peerConnection_){const e=new gc({code:mc.INVALID_OPERATION,message:aa({key:Jr})});throw this.log_.warn(e),e}await this.onSubscribeResult(s),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){const e={voiceActivityDetection:!1};$d()&&"unified-plan"===this.sdpSemantics_?(this.peerConnection_.addTransceiver(Dt,{direction:"recvonly"}),this.peerConnection_.addTransceiver(Pt,{direction:"recvonly"}),this.peerConnection_.addTransceiver(Pt,{direction:"recvonly"})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);const t=await this.peerConnection_.createOffer(e),{isH264DecodeSupported:i}=await Nd();i||(this.log_.warn("remove h264 desc from sdp"),t.sdp=function(e){const t=fd(e);return t.media.forEach((e=>{if(e.type===Pt){const t=new Set;e.rtp.forEach((({payload:e,codec:i})=>"H264"===i&&t.add(e))),e.fmtp.forEach((({payload:e,config:i})=>{const s=i.match(/apt=(\d+)/);s&&s[1]&&t.has(Number(s[1]))&&t.add(e)}));const i=({payload:e})=>!t.has(e);e.rtp=e.rtp.filter(i),e.rtcpFb=e.rtcpFb.filter(i),e.fmtp=e.fmtp.filter(i),e.payloads=e.payloads.split(" ").filter((e=>!t.has(Number(e)))).join(" ")}})),Sd(t)}(t.sdp)),t.sdp=this.addRRTRLine(t.sdp),t.sdp=this.addSPSDescription(t.sdp),t.sdp=function(e){const t=fd(e);return t.media.forEach((e=>{e.type===Dt&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1"}))})),Sd(t)}(t.sdp),"unified-plan"===this.sdpSemantics_&&(t.sdp=this.removeSDESDescription(t.sdp)),await this.peerConnection_.setLocalDescription(t)}async onSubscribeResult(e){let{code:t,message:i=""}=e&&e.data||{},{type:s,sdp:n}=e&&e.data&&e.data.data||{};if(77393===t)throw this.log_.error(sa.NOT_SUPPORTED_H264DECODE),new gc({code:mc.NOT_SUPPORTED_H264,message:aa({key:Or})});try{if(0!==t)throw new gc({code:t,message:aa({key:hn,data:{errMsg:i}})});this.log_.debug("accept remote answer: "+n),await this.peerConnection_.setRemoteDescription({type:s,sdp:n}),this.sei_&&(this.sei_.handleEncodedStreams(),this.sei_.onSEIMessage=e=>{this.emitter_.emit(tl.SEI_MESSAGE,{...e,userId:this.userId_})}),this.updateSSRC(n)}catch(r){throw this.log_.error(r),r}}updateSSRC(e){try{fd(e).media.forEach((e=>{if(e.type===Dt){const t=e.ssrcs.find((e=>e.value.includes(wi)));t&&(this.ssrc_.audio=t.id)}else{const t=e.ssrcs.find((e=>e.value.includes(wi))),i=e.ssrcs.find((e=>e.value.includes(Ai)));t&&(this.ssrc_.video=t.id),i&&(this.ssrc_.auxiliary=i.id)}}))}catch(t){}}setRemoteStream(e,t){this.remoteStreams_.set(e,t)}getSubscribeState(){return this.subscribeState_}getTrackState(){return this.trackState_}getSSRC(){return this.ssrc_}getMainStream(){return this.remoteStreams_.get(wi)}getAuxStream(){return this.remoteStreams_.get(Ai)}getMainStreamVideoTrackId(){const e=this.getMainStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}getAuxStreamVideoTrackId(){const e=this.getAuxStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}async reconnect(){if(-1!==this.reconnectionTimer_)return void this.log_.warn("reconnect() downlink is reconnecting, ignore current reconnection");if(this.reconnectionCount_>=30){this.log_.warn(`SDK has tried reconnect downlink [${this.userId_}] for 30 times, but all failed, please check your network`),this.stopReconnection();const e=new gc({code:mc.DOWNLINK_RECONNECTION_FAILED,message:aa({key:ln})});return sd.logFailedEvent({userId:this.client_.getUserId(),eventType:ss,error:e}),this.addEventInternal(Qc,"downlink-connection reconnect fail"),this.emitConnectionStateChangedEvent(Mi),void this.emitter_.emit(tl.ERROR,e)}if(this.signalChannel_.getCurrentState()!==Jo)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Fo,this.reconnect,this);this.reconnectionCount_++,this.log_.warn(`reconnect() try to reconnect downlink [${this.reconnectionCount_}/30]`);const e=pa(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect() downlink [${this.userId_}] reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()}),e),!(this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===Ui))try{this.closePeerConnection(),this.initialize(),await this.connect(),this.stopReconnection(),this.log_.warn("reconnect() downlink reconnect successfully"),sd.logSuccessEvent({userId:this.client_.getUserId(),eventType:ss}),this.addEventInternal(Kc,"downlink-connection reconnect success"),this.recoverSubscription()}catch(t){}}recoverSubscription(){const e=this.client_.getSubscriptionManager();e&&[...this.remoteStreams_.values()].forEach((t=>{e.hasAutoRecoveryFlag(this.userId_,t.getType())&&e.recover(t)}))}getIsReconnecting(){return this.isReconnecting_}getSubscribedMainStream(){let e=null;return this.isMainStreamSubscribed&&(e=this.remoteStreams_.get(wi)),e}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}startReconnection(){const e=this.client_.getSubscriptionManager();if(e)for(let t of this.remoteStreams_.values()){const i=t.getType();(i===Pi&&(this.trackState_.audio||this.trackState_.video)||i===Ni&&this.trackState_.auxiliary)&&e.setAutoRecoveryFlag(this.userId_,t.getType())}super.startReconnection()}getCurrentState(){return this.currentState_}hasMainStream(){return this.trackState_.video||this.trackState_.audio||this.trackState_.smallVideo}hasAuxStream(){return this.trackState_.auxiliary}},e(mh.prototype,"subscribe",[_h],Object.getOwnPropertyDescriptor(mh.prototype,"subscribe"),mh.prototype),mh);class fh{constructor(){this.startTime=0,this.endTime=0,this.start()}start(){0===this.startTime&&(this.startTime=Ea())}stop(){0===this.endTime&&(this.endTime=Ea())}getDuration(){return 0===this.endTime?Ea()-this.startTime:this.endTime-this.startTime}}class Sh{constructor(e){this.client_=e.client,this.intervalId_=-1,this.statsCalculator_=e.stats,this.prevStats_=null,this.renderFreezeMap_=new Map,this.remoteStreamMap_=new Map,this.dataFreezeMap_=new Map,this.monitorFreezeData_=new Map}installEvents(){Va.on(To,this.handlePlayVideoStart,this),Va.on(fo,this.onVideoTrackMuted,this),Va.on(So,this.onVideoTrackUnmuted,this),Va.on(uo,this.handleStreamStopped,this),Va.on(lo,this.handleStreamStopped,this),Va.on(so,this.handleVideoPlaying,this)}uninstallEvents(){Va.off(To,this.handlePlayVideoStart,this),Va.off(fo,this.onVideoTrackMuted,this),Va.off(So,this.onVideoTrackUnmuted,this),Va.off(uo,this.handleStreamStopped,this),Va.off(lo,this.handleStreamStopped,this),Va.off(so,this.handleVideoPlaying,this)}start(){-1===this.intervalId_&&(this.installEvents(),this.intervalId_=Rd.run((async()=>{try{await this.detectFPS()}catch(e){}}),{delay:1e3}))}stop(){-1!==this.intervalId_&&(this.uninstallEvents(),Rd.clearTask(this.intervalId_),this.intervalId_=-1,this.renderFreezeMap_.clear(),this.dataFreezeMap_.clear(),this.remoteStreamMap_.clear())}onVideoTrackMuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,s=`${t}_${i}`,n=this.dataFreezeMap_.get(s),r=new fh;n?n.durationItemList.push(r):this.dataFreezeMap_.set(s,{userId:t,type:i,durationItemList:[r],isFreezing(){const e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}})}onVideoTrackUnmuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,s=`${t}_${i}`;this.stopDataFreeze({key:s,userId:t,type:i})}handleStreamStopped({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),s=t.getType(),n=`${i}_${s}`;this.stopDataFreeze({key:n,userId:i,type:s})}stopDataFreeze({key:e,userId:t,type:i}){const s=this.dataFreezeMap_.get(e);if(!s||!s.isFreezing())return;const n=s.durationItemList[s.durationItemList.length-1];n.stop();const r=n.getDuration();r>500?(sd.logEvent({eventType:"videoFrozenCount",delta:r}),this.monitorFreezeData_.set(e,{userId:t,type:i,duration:r})):s.durationItemList.pop()}getTotalDuration(e){return e.reduce(((e,t)=>{const i=t.getDuration();return e+Math.min(i,5e3)}),0)}async getStats(){const e=this.client_.getConnections(),t={};for(let[i,s]of e){if(!s.getPeerConnection())continue;const e=s.getSubscribeState(),n=s.getTrackState(),r=await this.statsCalculator_.getReceiverStats(s),a={userId:r.userId,tinyId:i,hasVideo:n.video&&e.video,hasAuxiliary:n.auxiliary&&e.auxiliary,video:{framesDecoded:0},auxiliary:{framesDecoded:0}};a.hasVideo&&(a.video.framesDecoded=r.video.framesDecoded),a.hasAuxiliary&&(a.auxiliary.framesDecoded=r.auxiliary.framesDecoded),t[r.userId]=a}return t}async detectFPS(){const e=await this.getStats();if(this.prevStats_){for(let t in e){if(!this.prevStats_[t])continue;const i=e[t].tinyId,s=this.client_.getMutedStates();if(e[t].hasVideo&&this.prevStats_[t].hasVideo&&s.has(i)&&!s.get(i).videoMuted){const i=e[t].video.framesDecoded-this.prevStats_[t].video.framesDecoded;this.handleRenderFreeze({userId:t,type:Pi,fps:i})}if(e[t].hasAuxiliary&&this.prevStats_[t].hasAuxiliary){const i=e[t].auxiliary.framesDecoded-this.prevStats_[t].auxiliary.framesDecoded;this.handleRenderFreeze({userId:t,type:Ni,fps:i})}}this.prevStats_=e}else this.prevStats_=e}async handleRenderFreeze({userId:e,fps:t,type:i}){const s=`${e}_${i}`;let n=this.renderFreezeMap_.get(s);if(t<=2){const t=Ea();n&&!n.isFreeze&&(n.freezeTimeline.push({startTime:t,endTime:void 0}),n.isFreeze=!0),n||this.renderFreezeMap_.set(s,{userId:e,type:i,isFreeze:!0,freezeTimeline:[{startTime:t,endTime:void 0}],renderFreezeTotal:0})}else if(n&&n.isFreeze){n.isFreeze=!1;const e=n.freezeTimeline.pop();e.endTime=Ea();const t=e.endTime-e.startTime;n.freezeTimeline.push(e),n.renderFreezeTotal+=Math.min(5e3,t)}}handlePlayVideoStart({stream:e}){if(e.getClient()!==this.client_||!e.isRemote()||!e.hasVideo())return;const t=`${e.getUserId()}_${e.getType()}`;this.remoteStreamMap_.has(t)||this.remoteStreamMap_.set(t,{isPlayingFired:!1})}handleVideoPlaying({stream:e}){if(!e.isRemote()||e.getClient()!==this.client_)return;const t=`${e.getUserId()}_${e.getType()}`;if(this.remoteStreamMap_.has(t)){this.remoteStreamMap_.get(t).isPlayingFired=!0}}getDataFreezeDuration(e){const t={dataFreeze:0,count:0},i=this.dataFreezeMap_.get(e);if(i){if(i.isFreezing()){const e=i.durationItemList[i.durationItemList.length-1];e.stop();e.getDuration()<500&&i.durationItemList.pop()}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length}return t}getRenderFreezeDuration(e){const t=this.renderFreezeMap_.get(e);let i=0,s=0;if(t)if(t.isFreeze){const e=Ea()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(e,5e3),s=t.freezeTimeline.length}else i=t.renderFreezeTotal;return{renderFreeze:i,count:s}}getMonitorFreeze(){return this.monitorFreezeData_}isBlackStream(e){if(this.remoteStreamMap_.has(e)){return!this.remoteStreamMap_.get(e).isPlayingFired}return!1}resetMonitor(){this.monitorFreezeData_.clear()}}class vh{constructor(e){this.userId=e.userId,this.tinyId=e.tinyId,this.role=e.role===Ri?"anchor":"audience"}}var yh,Th={exports:{}};yh=Th,function(e){function t(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function i(e,i,s,n,r,a){return t((o=t(t(i,e),t(n,a)))<<(c=r)|o>>>32-c,s);var o,c}function s(e,t,s,n,r,a,o){return i(t&s|~t&n,e,t,r,a,o)}function n(e,t,s,n,r,a,o){return i(t&n|s&~n,e,t,r,a,o)}function r(e,t,s,n,r,a,o){return i(t^s^n,e,t,r,a,o)}function a(e,t,s,n,r,a,o){return i(s^(t|~n),e,t,r,a,o)}function o(e,i){var o,c,d,l,h;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;var u=1732584193,p=-271733879,_=-1732584194,m=271733878;for(o=0;o<e.length;o+=16)c=u,d=p,l=_,h=m,u=s(u,p,_,m,e[o],7,-680876936),m=s(m,u,p,_,e[o+1],12,-389564586),_=s(_,m,u,p,e[o+2],17,606105819),p=s(p,_,m,u,e[o+3],22,-1044525330),u=s(u,p,_,m,e[o+4],7,-176418897),m=s(m,u,p,_,e[o+5],12,1200080426),_=s(_,m,u,p,e[o+6],17,-1473231341),p=s(p,_,m,u,e[o+7],22,-45705983),u=s(u,p,_,m,e[o+8],7,1770035416),m=s(m,u,p,_,e[o+9],12,-1958414417),_=s(_,m,u,p,e[o+10],17,-42063),p=s(p,_,m,u,e[o+11],22,-1990404162),u=s(u,p,_,m,e[o+12],7,1804603682),m=s(m,u,p,_,e[o+13],12,-40341101),_=s(_,m,u,p,e[o+14],17,-1502002290),u=n(u,p=s(p,_,m,u,e[o+15],22,1236535329),_,m,e[o+1],5,-165796510),m=n(m,u,p,_,e[o+6],9,-1069501632),_=n(_,m,u,p,e[o+11],14,643717713),p=n(p,_,m,u,e[o],20,-373897302),u=n(u,p,_,m,e[o+5],5,-701558691),m=n(m,u,p,_,e[o+10],9,38016083),_=n(_,m,u,p,e[o+15],14,-660478335),p=n(p,_,m,u,e[o+4],20,-405537848),u=n(u,p,_,m,e[o+9],5,568446438),m=n(m,u,p,_,e[o+14],9,-1019803690),_=n(_,m,u,p,e[o+3],14,-187363961),p=n(p,_,m,u,e[o+8],20,1163531501),u=n(u,p,_,m,e[o+13],5,-1444681467),m=n(m,u,p,_,e[o+2],9,-51403784),_=n(_,m,u,p,e[o+7],14,1735328473),u=r(u,p=n(p,_,m,u,e[o+12],20,-1926607734),_,m,e[o+5],4,-378558),m=r(m,u,p,_,e[o+8],11,-2022574463),_=r(_,m,u,p,e[o+11],16,1839030562),p=r(p,_,m,u,e[o+14],23,-35309556),u=r(u,p,_,m,e[o+1],4,-1530992060),m=r(m,u,p,_,e[o+4],11,1272893353),_=r(_,m,u,p,e[o+7],16,-155497632),p=r(p,_,m,u,e[o+10],23,-1094730640),u=r(u,p,_,m,e[o+13],4,681279174),m=r(m,u,p,_,e[o],11,-358537222),_=r(_,m,u,p,e[o+3],16,-722521979),p=r(p,_,m,u,e[o+6],23,76029189),u=r(u,p,_,m,e[o+9],4,-640364487),m=r(m,u,p,_,e[o+12],11,-421815835),_=r(_,m,u,p,e[o+15],16,530742520),u=a(u,p=r(p,_,m,u,e[o+2],23,-995338651),_,m,e[o],6,-198630844),m=a(m,u,p,_,e[o+7],10,1126891415),_=a(_,m,u,p,e[o+14],15,-1416354905),p=a(p,_,m,u,e[o+5],21,-57434055),u=a(u,p,_,m,e[o+12],6,1700485571),m=a(m,u,p,_,e[o+3],10,-1894986606),_=a(_,m,u,p,e[o+10],15,-1051523),p=a(p,_,m,u,e[o+1],21,-2054922799),u=a(u,p,_,m,e[o+8],6,1873313359),m=a(m,u,p,_,e[o+15],10,-30611744),_=a(_,m,u,p,e[o+6],15,-1560198380),p=a(p,_,m,u,e[o+13],21,1309151649),u=a(u,p,_,m,e[o+4],6,-145523070),m=a(m,u,p,_,e[o+11],10,-1120210379),_=a(_,m,u,p,e[o+2],15,718787259),p=a(p,_,m,u,e[o+9],21,-343485551),u=t(u,c),p=t(p,d),_=t(_,l),m=t(m,h);return[u,p,_,m]}function c(e){var t,i="",s=32*e.length;for(t=0;t<s;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function d(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function l(e){var t,i,s="0123456789abcdef",n="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),n+=s.charAt(t>>>4&15)+s.charAt(15&t);return n}function h(e){return unescape(encodeURIComponent(e))}function u(e){return function(e){return c(o(d(e),8*e.length))}(h(e))}function p(e,t){return function(e,t){var i,s,n=d(e),r=[],a=[];for(r[15]=a[15]=void 0,n.length>16&&(n=o(n,8*e.length)),i=0;i<16;i+=1)r[i]=909522486^n[i],a[i]=1549556828^n[i];return s=o(r.concat(d(t)),512+8*t.length),c(o(a.concat(s),640))}(h(e),h(t))}function _(e,t,i){return t?i?p(t,e):l(p(t,e)):i?u(e):l(u(e))}yh.exports?yh.exports=_:e.md5=_}(C);var Ih,bh,Eh=Th.exports;class Ch{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.log_=Oo.createLogger({id:"mix|"+this.client_.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.isMixing_=!1,this.config_=null,this.data_=null,this.remoteStreamMap_=new Map,this.installEvents()}get isPresetLayoutMode(){return this.config_&&this.config_.mode===vs.PRESET_LAYOUT}installEvents(){Va.on(co,this.onStreamSubscribed,this),Va.on(lo,this.onStreamUnsubscribed,this),this.client_.on("stream-removed",this.onStreamRemoved,this)}uninstallEvents(){Va.off(co,this.onStreamSubscribed,this),Va.off(lo,this.onStreamUnsubscribed,this),this.client_.off("stream-removed",this.onStreamRemoved,this)}reset(){this.uninstallEvents(),this.isMixing_=!1,this.config_=null}onStreamSubscribed({client:e,stream:t}){e===this.client_&&(this.remoteStreamMap_.set(t.getId(),{remoteStream:t,isUsed:!1}),this.isMixing_&&this.hasAvailablePlaceHolder()&&this.startMixTranscode(this.config_))}onStreamUnsubscribed({client:e,stream:t}){e===this.client_&&this.onStreamRemoved({stream:t})}onStreamRemoved({stream:e}){if(this.remoteStreamMap_.has(e.getId())){const{isUsed:t}=this.remoteStreamMap_.get(e.getId());this.remoteStreamMap_.delete(e.getId()),this.isMixing_&&this.isPresetLayoutMode&&t&&this.startMixTranscode(this.config_)}}async startMixTranscode(e){try{this.resetIsUsedFlag(),this.config_=e;const t=this.getInputParam(e,this.remoteStreamMap_),i=this.getOutputParam(e),s=this.getOutputSessionId({config:e,roomId:this.client_.getRoomId(),userId:this.client_.getUserId()});this.isMixing_&&this.data_&&s!==this.data_.outputSessionId&&(this.log_.info("startMixTranscode() streamId changed, stop mixing before start"),await this.doStopMixTranscode()),await this.doStartMixTranscode({outputSessionId:s,inputParam:t,outputParam:i})}catch(t){throw this.resetIsUsedFlag(),t}}async doStartMixTranscode({outputSessionId:e,inputParam:t,outputParam:i}){const s={roomId:String(this.client_.getRoomId()),mcuRequestTime:Date.now(),outputSessionId:e,inputParam:t,outputParam:i};this.data_=s,this.log_.info(`startMixTranscode: ${JSON.stringify(s)}`),this.isMixing_=!0;try{const e=await this.signalChannel_.sendWaitForResponse({command:lc,data:s,timeout:5e3,responseCommand:qo.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"});let{code:t,message:i}=e.data;if(0!==t)throw-102083===t&&(i=`Please enable relayed-push in https://console.cloud.tencent.com/trtc and try later, refer to ${zs}tutorial-26-advanced-publish-cdn-stream.html`),this.log_.error(`startMixTranscode failed, errCode: ${t} errMsg: ${i}`),this.isMixing_=!1,new gc({code:mc.START_MIX_TRANSCODE_FAILED,message:aa({key:_r,data:{message:i},link:{className:"Client",fnName:"startMixTranscode"}})})}catch(n){throw this.isMixing_=!1,n}}reStartMixTranscode(){this.isMixing_&&this.startMixTranscode(this.config_)}async stopMixTranscode(){if(!this.isMixing_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:gr})});await this.doStopMixTranscode(),this.resetIsUsedFlag()}async doStopMixTranscode(){const e={mcuRequestTime:Date.now(),outputSessionId:this.data_.outputSessionId,streamType:this.data_.outputParam.streamType};this.log_.info(`stopMixTranscode: ${JSON.stringify(e)}`);const t=await this.signalChannel_.sendWaitForResponse({command:hc,data:e,timeout:5e3,responseCommand:qo.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"}),{code:i,message:s}=t.data;if(0!==i)throw this.log_.error(`stopMixTranscode failed, errCode: ${i} errMsg: ${s}`),new gc({code:mc.STOP_MIX_TRANSCODE_FAILED,message:aa({key:mr,data:{message:s},link:{className:"Client",fnName:"stopMixTranscode"}})});this.isMixing_=!1}getOutputSessionId({config:e,userId:t,roomId:i}){return ga(e.streamId)&&e.streamId.length>0?e.streamId:Eh(`${i}_${t}_main`)}getInputParam(e,t){let i=e.mixUsers.map((e=>({userId:e.userId,roomId:String(e.roomId||this.client_.getRoomId()),width:e.width||0,height:e.height||0,locationX:e.locationX||0,locationY:e.locationY||0,zOrder:e.zOrder,streamType:ma(e.streamType)||e.streamType!==Ni?0:1,inputType:e.pureAudio?Ts.IT_PURE_AUDIO:Ts.IT_AUDIO_VIDEO,renderMode:e.renderMode||0})));return e.mode===vs.PRESET_LAYOUT&&(i.forEach((e=>{if(e.userId===ys.REMOTE){const i=[...t.values()].find((({isUsed:e})=>!e));i&&(e.userId=i.remoteStream.getUserId(),e.streamType=i.remoteStream.getType()===Ni?1:0,i.isUsed=!0)}})),i=i.filter((e=>e.userId!==ys.REMOTE))),i}getOutputParam(e){const t=e.streamId||"";return{streamId:t,streamType:t.length>0?1:0,width:ma(e.videoWidth)?640:e.videoWidth,height:ma(e.videoHeight)?480:e.videoHeight,videoBps:e.videoBitrate||0,fps:e.videoFramerate||15,gop:e.videoGOP||2,audioSampleRate:e.audioSampleRate||48e3,audioBps:e.audioBitrate||64,audioChannels:e.audioChannels||1,backgroundColor:e.backgroundColor||0,backgroundImg:e.backgroundImage||"",extraInfo:"",videoCodec:2,audioCodec:0}}hasAvailablePlaceHolder(){return!!this.isPresetLayoutMode&&this.data_.inputParam.length!==this.config_.mixUsers.length}resetIsUsedFlag(){this.remoteStreamMap_.forEach((e=>e.isUsed=!1))}}class Rh{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.publishTencentMainStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1},this.publishTencentAuxStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1},this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}setSignalChannel(e){this.signalChannel_=e.signalChannel}getIsPublishingTencentCDN(){return this.publishTencentMainStreamObj_.isPublishing_||this.publishTencentAuxStreamObj_.isPublishing_}getIsPublishingGivenCDN(){return this.isPublishingGivenCDN_}generatePublishCDNStreamId(e,t){if(!e){let e=`${this.client_.getRoomId()}_${this.client_.getUserId()}_${t}`;return/^[A-Za-z\d_-]*$/.test(e)||(e=Eh(e)),`${this.client_.getSDKAppId()}_${e}`}return e}generatePublishCDNSessionId(e){return Eh(`${this.client_.getRoomId()}_${this.client_.getUserId()}_${e}`)}async startPublishTencentCDN(e){if(e.streamType===xt?(this.publishTencentAuxStreamObj_.params_=e,this.publishTencentAuxStreamObj_.isPublishing_=!0):(this.publishTencentMainStreamObj_.params_=e,this.publishTencentMainStreamObj_.isPublishing_=!0),!this.client_.isJoined_)return;const t=this.generatePublishCDNStreamId(e.streamId,e.streamType),i=this.generatePublishCDNSessionId(e.streamType),s=e.streamType===xt?1:0,n={requestTime:Date.now(),sessionId:i,streamId:t,streamType:s};await this.doStartPublishTencentCDN(n,e.streamType)}async doStartPublishTencentCDN(e,t){try{Oo.info("startPublishTencentCDN: "+JSON.stringify(e));const i=await this.signalChannel_.sendWaitForResponseWithRetry({command:ac,data:e,timeout:2e3,responseCommand:qo.START_PUBLISH_TENCENT_CDN_RES,commandDesc:"startPublishCDNStream",retries:2});let{code:s,message:n}=i.data;if(0!==s)throw t===xt?this.publishTencentAuxStreamObj_.isPublishing_=!1:this.publishTencentMainStreamObj_.isPublishing_=!1,-102083===s&&(n=`Please enable relayed-push in https://console.cloud.tencent.com/trtc and try later, refer to ${zs}tutorial-26-advanced-publish-cdn-stream.html`),Oo.error(`startPublishTencentCDN failed, errCode: ${s}, errMsg: ${n}`),new gc({code:mc.START_PUBLISH_CDN_FAILED,message:aa({key:Fn,data:{message:n},link:{className:"Client",fnName:"startPublishCDNStream"}})});t===xt?this.publishTencentAuxStreamObj_.streamId_=e.streamId:this.publishTencentMainStreamObj_.streamId_=e.streamId}catch(i){throw t===xt?this.publishTencentAuxStreamObj_.isPublishing_=!1:this.publishTencentMainStreamObj_.isPublishing_=!1,i}}resetPublishTencentParam(e){e===Xt&&(this.publishTencentMainStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1}),e===xt&&(this.publishTencentAuxStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1})}async stopPublishTencentCDN(){if(!this.client_.isJoined_)return this.resetPublishTencentParam(Xt),void this.resetPublishTencentParam(xt);this.publishTencentMainStreamObj_.isPublishing_&&await this.doStopPublishTencentCDN(Xt),this.publishTencentAuxStreamObj_.isPublishing_&&await this.doStopPublishTencentCDN(xt)}async doStopPublishTencentCDN(e){const t={requestTime:Date.now(),sessionId:Eh(`${this.client_.getRoomId()}_${this.client_.getUserId()}_${e}`)};Oo.info("stopPublishTencentCDN: "+JSON.stringify(t));const i=await this.signalChannel_.sendWaitForResponse({command:oc,data:t,timeout:5e3,responseCommand:qo.STOP_PUBLISH_TENCENT_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:s,message:n}=i.data;if(0===s)this.resetPublishTencentParam(e);else{if(-102069!==s)throw Oo.error(`stopPublishTencentCDN failed, errCode: ${s} errMsg: ${n}`),new gc({code:mc.STOP_PUBLISH_CDN_FAILED,message:aa({key:jn,data:{message:n},link:{className:"Client",fnName:"stopPublishCDNStream"}})});Oo.warn("stopPublishTencentCDN failed, can not stopPublishTencentCDN in auto relayed-push mode"),this.resetPublishTencentParam(e)}}async startPublishGivenCDN(e){const t=e.streamType===Xt?this.publishTencentMainStreamObj_.streamId_:this.publishTencentAuxStreamObj_.streamId_,i={pushRequestTime:Date.now(),pushAppId:e.appId,pushBizId:e.bizId,pushCdnUrl:e.url,pushStreamType:e.streamType,pushStreamId:t};if(Oo.info("startPublishGivenCDN: "+JSON.stringify(i)),this.publishGivenCDNData_=i,this.isPublishingGivenCDN_=!0,this.client_.isJoined_)try{const e=await this.signalChannel_.sendWaitForResponse({command:cc,data:i,timeout:5e3,responseCommand:qo.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDNStream"});let{code:t,message:s}=e.data;if(0!==t)throw Oo.error(`startPublishGivenCDN failed, errCode: ${t}, errMsg: ${s}`),this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,new gc({code:mc.START_PUBLISH_CDN_FAILED,message:aa({key:Fn,data:{message:s},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(s){throw this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,s}}async stopPublishGivenCDN(){if(!this.client_.isJoined_)return this.publishGivenCDNData_=null,void(this.isPublishingGivenCDN_=!1);let{pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:s}=this.publishGivenCDNData_;const n={pushRequestTime:Date.now(),pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:s};Oo.info("stopPublishGivenCDN: "+JSON.stringify(n));const r=await this.signalChannel_.sendWaitForResponse({command:dc,data:n,timeout:5e3,responseCommand:qo.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:a,message:o}=r.data;if(0!==a)throw Oo.error(`stopPublishGivenCDN failed, errCode: ${a} errMsg: ${o}`),new gc({code:mc.STOP_PUBLISH_CDN_FAILED,message:aa({key:jn,data:{message:o},link:{className:"Client",fnName:"stopPublishCDNStream"}})});this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}handleCDNConfigForJoinData(e){let t,i=e;if(this.publishTencentMainStreamObj_.isPublishing_||this.publishTencentAuxStreamObj_.isPublishing_){let e={};ga(i)&&(e=JSON.parse(i)),e.Str_uc_params||(e.Str_uc_params={}),this.publishTencentMainStreamObj_.isPublishing_&&(this.publishTencentMainStreamObj_.streamId_?e.Str_uc_params.userdefine_streamid_main=this.publishTencentMainStreamObj_.streamId_:this.publishTencentMainStreamObj_.params_&&(e.Str_uc_params.userdefine_streamid_main=this.generatePublishCDNStreamId(this.publishTencentMainStreamObj_.params_.streamId,Xt))),this.publishTencentAuxStreamObj_.isPublishing_&&(this.publishTencentAuxStreamObj_.streamId_?e.Str_uc_params.userdefine_streamid_aux=this.publishTencentAuxStreamObj_.streamId_:this.publishTencentAuxStreamObj_.params_&&(e.Str_uc_params.userdefine_streamid_aux=this.generatePublishCDNStreamId(this.publishTencentAuxStreamObj_.params_.streamId,xt))),i=JSON.stringify(e)}if(this.isPublishingGivenCDN_){let{pushAppId:e,pushBizId:i,pushCdnUrl:s,pushStreamType:n,pushStreamId:r}=this.publishGivenCDNData_;t={pushRequestTime:Date.now(),pushAppId:e,pushBizId:i,pushCdnUrl:s,pushStreamType:n,pushStreamId:r}}return{bussinessInfo:i,pushUserCdnInfo:t}}reset(){this.resetPublishTencentParam(Xt),this.resetPublishTencentParam(xt),this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}}class kh{constructor(e){this.client_=e.client,this.durationMap_=new Map,this.installEvents()}installEvents(){Va.on(co,this.handleSubscribed,this),Va.on(ro,this.handleStreamTrackUpdated,this),Va.on(lo,this.handleStreamStopped,this),Va.on(uo,this.handleStreamStopped,this)}uninstallEvents(){Va.off(co,this.handleSubscribed,this),Va.off(ro,this.handleStreamTrackUpdated,this),Va.off(lo,this.handleStreamStopped,this),Va.off(uo,this.handleStreamStopped,this)}handleSubscribed({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),s=t.getType(),n=`${i}_${s}`;if(t.hasAudio())if(t.isMainAudioSubscribed){const e=new fh,t=this.durationMap_.get(n);t?this.isRecording(t.audio)||t.audio.push(e):this.durationMap_.set(n,{userId:i,type:s,audio:[e],video:[]})}else this.stopDurationItem(n,Dt);if(t.hasVideo())if(s===Pi&&t.isMainVideoSubscribed||s===Ni&&t.isAuxVideoSubscribed){const e=new fh,t=this.durationMap_.get(n);t?this.isRecording(t.video)||t.video.push(e):this.durationMap_.set(n,{userId:i,type:s,audio:[],video:[e]})}else this.stopDurationItem(n,Pt)}handleStreamStopped({client:e,stream:t}){if(!this.clientHitTest(e))return;const i=`${t.getUserId()}_${t.getType()}`;this.stopDurationItem(i,Dt),this.stopDurationItem(i,Pt)}handleStreamTrackUpdated({client:e,userId:t,tinyId:i,kind:s,action:n}){if(!this.clientHitTest(e)||!this.client_.getConnections().has(i))return;const r=s===Ot?s:Pi,a=`${t}_${r}`;if(n===ks.ADD){const e=this.client_.getConnections().get(i).getSubscribeState();if(s===Dt&&!e.audio||s===Pt&&!e.video||s===Ot&&!e.auxiliary)return;const n=new fh,o=this.durationMap_.get(a);o?(s!==Dt||this.isRecording(o.audio)||o.audio.push(n),s===Dt||this.isRecording(o.video)||o.video.push(n)):this.durationMap_.set(a,{userId:t,type:r,audio:s===Dt?[n]:[],video:s===Dt?[]:[n]})}else this.stopDurationItem(a,s===Dt?Dt:Pt)}isRecording(e){return e.findIndex((e=>0===e.endTime))>=0}stopDurationItem(e,t){if(this.durationMap_.has(e)){const i=this.durationMap_.get(e)[t].find((e=>0===e.endTime));i&&i.stop()}}clientHitTest(e){return this.client_===e}getDuration(e,t){if(this.durationMap_.has(e)){return this.durationMap_.get(e)[t].reduce(((e,t)=>e+t.getDuration()),0)}return 0}getDurationMap(){return this.durationMap_}reset(){this.durationMap_.clear()}destroy(){this.client_=null,this.uninstallEvents()}}const wh={msg_user_info:0,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0};class Ah{constructor(e){this.str_identifier=String(e.userId),this.uint64_tinyid=Number(e.tinyId),this.uint32_role=e.role}}let Dh=(Ih=ql({timeout:500,retries:3}),bh=class{constructor(e){this.frameWorkType_=e.frameWorkType||30,this.component_=e.component||0,this.client_=e.client,this.keyPrefix_="key_point",this.storageKey_=`${this.keyPrefix_}_${this.client_.getUserId()}`,this.log_=Oo.createLogger({id:"kpm|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),Object.getOwnPropertyNames(this.__proto__).forEach((e=>{e.startsWith("handle")&&_a(this[e])&&(this[e]=function({fn:e,context:t}){return async function(...i){try{return await e.apply(t||this,i)}catch(s){Oo.error(`${e.name}() error observed `+s)}}}({fn:this[e],context:this}))})),this.initData(),this.installEvents(),this.intervalId_=Rd.run(Xs,this.setStorage.bind(this),{delay:2e4})}initData(){this.firstPublishedUserList_=[],this.networkQuality_={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this.basicInfo={string_sdk_version:"4.15.1",uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===this.client_.getMode()?1:0,uint32_joining_duration:0,uint32_networkType:ws[la()],uint32_framework:this.frameWorkType_,uint32_component:this.component_},this.pathJoinRoom_={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this.pathLeaveRoom_={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this.pathMainVideoMap_=new Map,this.pathMainAudioMap_=new Map,this.pathAuxiliaryMap_=new Map,this.localStreamStats_={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this.remoteStreamStatsMap_=new Map}installEvents(){Va.on(Ua,this.handleJoinStart,this),Va.on(Ka,this.handleWSStart,this),Va.on(Qa,this.handleWSEnd,this),Va.on($a,this.handleJoinSendCMD,this),Va.on(Fa,this.handleJoinReceivedCMDResponce,this),Va.on(ja,this.handleJoinSuccess,this),Va.on(Ba,this.handleJoinFailed,this),Va.on(za,this.handleReceivedPublishUserList,this),Va.on(Co,this.handleConnectionStateChanged,this),Va.on(Ha,this.handleLeaveStart,this),Va.on(Ja,this.handleLeaveSuccess,this),Va.on(Ga,this.handleLeaveSendCMD,this),Va.on(Ro,this.handleSendSubscribeCMD,this),Va.on(so,this.handleVideoPlaying,this),Va.on(no,this.handleAudioPlaying,this),Va.on(ko,this.handleNetworkQuality,this),Va.on(Wa,this.handleHeartbeatStats,this),Va.on(ao,this.handleRemoteStreamAdded,this),Va.on(oo,this.handleRemoteStreamSubscribeStart,this),Va.on(co,this.handleRemoteStreamSubscribed,this),Va.on(uo,this.handleRemoteStreamRemoved,this),Va.on(yo,this.handleVideoLoadedData,this),Va.on(vo,this.handlePlayStream,this),Va.on(qa,this.handlePublishStart,this),Va.on(_o,this.handleLocalStreamInitStart,this),Va.on(mo,this.handleLocalStreamInitEnd,this),Va.on(go,this.handleLocalStreamInitFailed,this)}uninstallEvents(){Va.off(Ua,this.handleJoinStart,this),Va.off(Ka,this.handleWSStart,this),Va.off(Qa,this.handleWSEnd,this),Va.off($a,this.handleJoinSendCMD,this),Va.off(Fa,this.handleJoinReceivedCMDResponce,this),Va.off(za,this.handleReceivedPublishUserList,this),Va.off(Co,this.handleConnectionStateChanged,this),Va.off(Ha,this.handleLeaveStart,this),Va.off(Ja,this.handleLeaveSuccess,this),Va.off(ja,this.handleJoinSuccess,this),Va.off(Ba,this.handleJoinFailed,this),Va.off(Ga,this.handleLeaveSendCMD,this),Va.off(Ro,this.handleSendSubscribeCMD,this),Va.off(so,this.handleVideoPlaying,this),Va.off(no,this.handleAudioPlaying,this),Va.off(ko,this.handleNetworkQuality,this),Va.off(Wa,this.handleHeartbeatStats,this),Va.off(ao,this.handleRemoteStreamAdded,this),Va.off(oo,this.handleRemoteStreamSubscribeStart,this),Va.off(co,this.handleRemoteStreamSubscribed,this),Va.off(uo,this.handleRemoteStreamRemoved,this),Va.off(yo,this.handleVideoLoadedData,this),Va.off(vo,this.handlePlayStream,this),Va.off(qa,this.handlePublishStart,this),Va.off(_o,this.handleLocalStreamInitStart,this),Va.off(mo,this.handleLocalStreamInitEnd,this),Va.off(go,this.handleLocalStreamInitFailed,this)}destroy(){this.uninstallEvents(),Rd.clearTask(this.intervalId_),this.client_=null}handleJoinStart(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_start_time&&(this.pathJoinRoom_.uint64_start_time=Date.now(),this.checkStorage())}handleWSStart({client:e}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleWSEnd({client:e,error:t}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time=Date.now(),t&&(this.pathJoinRoom_.int32_send_request_acc_ip_cmd_ret=t instanceof gc?Number(t.getExtraCode()||t.getCode()):mc.UNKNOWN,this.pathJoinRoom_.int32_end_ret=2))}handleJoinSendCMD(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time=Date.now(),this.pathJoinRoom_.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this.pathJoinRoom_.int32_end_ret=3))}handleJoinSuccess(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_end_time&&(this.pathJoinRoom_.uint64_end_time=Date.now(),this.pathJoinRoom_.int32_end_ret=0)}handleJoinFailed({client:e}){this.hitTest(e)&&(this.pathJoinRoom_.uint64_end_time=Date.now(),0===this.pathJoinRoom_.int32_end_ret&&(this.pathJoinRoom_.int32_end_ret=3),this.prepareReport(),this.report())}handleReceivedPublishUserList(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_recv_userlist_time&&(this.pathJoinRoom_.uint64_recv_userlist_time=Date.now(),this.firstPublishedUserList_=e.data.data&&e.data.data.userList||[])}handleConnectionStateChanged({client:e,state:t,connection:i}){if(this.hitTest(e)&&t===xi){this.client_.getUplinkConnection()===i&&0===this.pathJoinRoom_.uint64_send_first_video_frame_time&&this.localStreamStats_.publishStartTime>this.pathJoinRoom_.uint64_end_time&&this.localStreamStats_.publishStartTime-this.pathJoinRoom_.uint64_end_time<=100&&(this.pathJoinRoom_.uint64_send_first_video_frame_time=Date.now());const e=this.pathMainVideoMap_.get(`${i.getUserId()}_${Pi}`);e&&0===e.statsToReport.uint64_pc_connected_time&&(e.statsToReport.uint64_pc_connected_time=Date.now())}}handleLeaveStart(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_start_time=Date.now())}handleLeaveSuccess(e){this.hitTest(e.client)&&0===this.pathLeaveRoom_.uint64_end_time&&(this.pathLeaveRoom_.uint64_end_time=Date.now(),0!==this.pathJoinRoom_.uint64_end_time?this.basicInfo.uint32_joining_duration=this.pathLeaveRoom_.uint64_end_time-this.pathJoinRoom_.uint64_end_time:this.log_.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_start_time=Date.now(),this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded({client:e,stream:t}){if(this.hitTest(e)){const e=t.getUserId(),i=t.getType(),s=`${e}_${i}`,n=this.remoteStreamStatsMap_.get(s);if(n)n.stream=t;else{const n={userId:e,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:{...wh},stream:t};n.statsToReport.msg_user_info=new Ah({userId:e,tinyId:t.getTinyId(),role:Ri}),n.statsToReport.uint32_stream_type=i===Pi?2:7,this.remoteStreamStatsMap_.set(s,n)}}}handleRemoteStreamSubscribeStart({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribeStartTime&&(i.subscribeStartTime=Date.now())}}handleSendSubscribeCMD(e){if(this.hitTest(e.client)){const t=new Ah(e),i=Date.now(),s=`${e.userId}_${Pi}`;e.trackState.video&&e.subscribeState.video&&!this.pathMainVideoMap_.has(s)&&this.pathMainVideoMap_.set(s,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0,uint64_pc_connected_time:0},userId:e.userId,sendSubscribeCMDTime:i}),e.trackState.audio&&e.subscribeState.audio&&!this.pathMainAudioMap_.has(s)&&this.pathMainAudioMap_.set(s,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_play_first_frame_time:0},userId:e.userId,sendSubscribeCMDTime:i});const n=`${e.userId}_${Ni}`;e.trackState.auxiliary&&e.subscribeState.auxiliary&&!this.pathAuxiliaryMap_.has(n)&&this.pathAuxiliaryMap_.set(n,{sendSubscribeCMDTime:i})}}handleRemoteStreamSubscribed({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribedTime&&(i.subscribedTime=Date.now(),i.stream=t)}}handleRemoteStreamRemoved({client:e,stream:t}){if(this.hitTest(e)){const e=t.getUserId(),i=t.getType(),s=this.remoteStreamStatsMap_.get(`${e}_${i}`);s&&(s.stream=null)}}handlePlayStream({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.remoteStreamStatsMap_.has(t)){const e=this.remoteStreamStatsMap_.get(t);0===e.playStreamTime&&(e.playStreamTime=Date.now())}}handleVideoLoadedData({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);0===e.statsToReport.uint64_combine_first_frame_time&&(e.statsToReport.uint64_combine_first_frame_time=Date.now())}}handleVideoPlaying({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`,i=Date.now();if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);if(0===e.statsToReport.uint64_render_first_frame_time&&(e.statsToReport.uint64_render_first_frame_time=i),this.remoteStreamStatsMap_.has(t)){const{statsToReport:s,playStreamTime:n,subscribedTime:r}=this.remoteStreamStatsMap_.get(t);0===s.uint32_video_render_first&&n-r<=100&&(s.uint32_video_render_first=i-e.sendSubscribeCMDTime)}}if(e.getType()===Ni&&this.pathAuxiliaryMap_.has(t)&&this.remoteStreamStatsMap_.has(t)){const{statsToReport:e,playStreamTime:s,subscribedTime:n}=this.remoteStreamStatsMap_.get(t);0===e.uint32_video_render_first&&s-n<=100&&(e.uint32_video_render_first=i-this.pathAuxiliaryMap_.get(t).sendSubscribeCMDTime)}}handleAudioPlaying(e){if(!e.stream.isRemote()||!e.stream.getConnection()||!this.hitTest(e.stream.getConnection().getClient()))return;const t=`${e.stream.getConnection().getUserId()}_${e.stream.getType()}`;if(this.pathMainAudioMap_.has(t)){const e=this.pathMainAudioMap_.get(t);0===e.statsToReport.uint64_play_first_frame_time&&(e.statsToReport.uint64_play_first_frame_time=Date.now())}}handleNetworkQuality(e){this.hitTest(e.client)&&(this.networkQuality_.totalUplinkLoss+=e.uplinkLoss,this.networkQuality_.totalUplinkRTT+=e.uplinkRTT,this.networkQuality_.count++,e.downlinkLossAndRTTMap.forEach((({rtt:e,loss:t,userId:i})=>{const s=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);s?(s.totalRTT+=e,s.totalLoss+=t,s.count++):this.networkQuality_.totalDownlinkRTTAndLossMap.set(i,{totalRTT:e,totalLoss:t,count:1})})))}handleHeartbeatStats(e){if(this.hitTest(e.client)){const{msg_up_stream_info:t,msg_down_stream_info:i}=e.stats;if(t.msg_video_status[0]){const{uint32_video_codec_bitrate:e,uint32_video_enc_fps:i,uint32_video_width:s,uint32_video_height:n}=t.msg_video_status[0];this.localStreamStats_.totalVideoBitrate+=e,this.localStreamStats_.totalVideoFPS+=i,this.localStreamStats_.totalVideoWidth+=s,this.localStreamStats_.totalVideoHeight+=n,this.localStreamStats_.videoCount++}if(t.msg_audio_status){const e=t.msg_audio_status.audioLevel;Math.floor(100*e)>0&&(this.localStreamStats_.totalAudioLevel+=e,this.localStreamStats_.audioLevelCount++)}i.forEach((e=>{const{msg_user_info:t,msg_audio_status:i,msg_video_status:s}=e,n=t.str_identifier;if(s.forEach((e=>{const t=2===e.uint32_video_stream_type,i=7===e.uint32_video_stream_type,s=`${n}_${t?Pi:Ni}`;if(this.remoteStreamStatsMap_.has(s)){var r,a;const n=this.remoteStreamStatsMap_.get(s);(t&&null!==(r=n.stream)&&void 0!==r&&r.isMainVideoSubscribed||i&&null!==(a=n.stream)&&void 0!==a&&a.isAuxVideoSubscribed)&&(n.totalVideoFPS+=e.uint32_video_receive_fps,n.totalVideoBitrate+=e.uint32_video_codec_bitrate,n.videoCount++,0===n.statsToReport.uint32_video_width&&(n.statsToReport.uint32_video_width=e.uint32_video_width),0===n.statsToReport.uint32_video_height&&(n.statsToReport.uint32_video_height=e.uint32_video_height))}})),i){const e=`${n}_${Pi}`;if(this.remoteStreamStatsMap_.has(e)){var r;const t=this.remoteStreamStatsMap_.get(e);null!==(r=t.stream)&&void 0!==r&&r.isMainAudioSubscribed&&(t.totalAudioBitrate+=i.uint32_audio_codec_bitrate,t.audioCount++,Math.floor(100*i.audioLevel)>0&&(t.totalAudioLevel+=i.audioLevel,t.audioLevelCount++))}}}))}}handlePublishStart({client:e}){this.hitTest(e)&&0===this.localStreamStats_.publishStartTime&&(this.localStreamStats_.publishStartTime=Date.now())}handleLocalStreamInitStart({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_start_time&&(this.pathJoinRoom_.uint64_init_audio_start_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_start_time&&(this.pathJoinRoom_.uint64_init_camera_start_time=Date.now())}handleLocalStreamInitEnd({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}handleLocalStreamInitFailed({audio:e,video:t,error:i}){const s=i instanceof gc?i.getExtraCode()||i.getCode():{NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5}[i.name]||mc.UNKNOWN;e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.int32_init_audio_ret=s,this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.int32_init_camera_ret=s,this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}hasVideoFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&1&t.flag))>=0}hasAudioFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&8&t.flag))>=0}hasAuxFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&4&t.flag))>=0}hitTest(e){return e===this.client_}async checkStorage(){try{const e=kd.getItem(this.storageKey_);e&&(await this.upload(e),kd.deleteItem(this.storageKey_))}catch(e){this.log_.warn(e)}}setStorage(){this.prepareReport();const e=this.getReportData();0!==e.msg_path_enter_room.uint64_start_time&&kd.setItem(this.storageKey_,e)}prepareReport(){if(this.networkQuality_.count>0&&(this.basicInfo.uint32_avg_rtt=Math.floor(this.networkQuality_.totalUplinkRTT/this.networkQuality_.count),this.basicInfo.uint32_avg_up_loss=Math.floor(this.networkQuality_.totalUplinkLoss/this.networkQuality_.count)),this.localStreamStats_.videoCount>0){this.localStreamStats_.statsToReport.uint32_video_big_capture_fps=Math.floor(this.localStreamStats_.totalVideoFPS/this.localStreamStats_.videoCount),this.localStreamStats_.statsToReport.uint32_video_big_bitrate=Math.floor(this.localStreamStats_.totalVideoBitrate/this.localStreamStats_.videoCount);const e=Math.floor(this.localStreamStats_.totalVideoWidth/this.localStreamStats_.videoCount),t=Math.floor(this.localStreamStats_.totalVideoHeight/this.localStreamStats_.videoCount);this.localStreamStats_.statsToReport.uint32_video_big_resolution=e<<16|t}this.localStreamStats_.audioLevelCount>0&&(this.localStreamStats_.statsToReport.uint32_audio_capture_db=Math.floor(this.localStreamStats_.totalAudioLevel/this.localStreamStats_.audioLevelCount*100)),this.remoteStreamStatsMap_.forEach(((e,t)=>{const i=e.userId;if(this.networkQuality_.totalDownlinkRTTAndLossMap.has(i)){const{totalLoss:t,count:s}=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);e.statsToReport.uint32_avg_down_loss=Math.floor(t/s)}e.videoCount>0&&(e.statsToReport.uint32_video_avg_fps=Math.floor(e.totalVideoFPS/e.videoCount),e.statsToReport.uint32_video_avg_bitrate=Math.floor(e.totalVideoBitrate/e.videoCount)),e.audioCount>0&&(e.statsToReport.uint32_audio_recv_bitrate=e.statsToReport.uint32_audio_bitrate=Math.floor(e.totalAudioBitrate/e.audioCount)),e.audioLevelCount>0&&(e.statsToReport.uint32_audio_play_db=Math.floor(e.totalAudioLevel/e.audioLevelCount*100));const s=this.client_.getCallDurationCalculator();s&&(e.statsToReport.uint32_audio_play_time=s.getDuration(t,Dt),e.statsToReport.uint32_video_play_time=s.getDuration(t,Pt)),e.statsToReport.uint32_video_render_first=Math.min(e.statsToReport.uint32_video_render_first,5e3);const n=this.client_.getBadCaseDetector();if(n){const{dataFreeze:i,count:s}=n.getDataFreezeDuration(t),{renderFreeze:r}=n.getRenderFreezeDuration(t);e.statsToReport.uint32_video_block_count=s,e.statsToReport.uint32_video_block_time=Math.min(i,e.statsToReport.uint32_video_play_time),e.statsToReport.uint32_video_external_block_time=Math.min(r,e.statsToReport.uint32_video_play_time),n.isBlackStream(t)&&0===e.statsToReport.uint32_video_avg_fps?e.statsToReport.uint32_video_black_screen_subjective=1:e.statsToReport.uint32_video_black_screen_subjective=0}(0===e.subscribeStartTime||e.subscribeStartTime-e.streamAddedTime>100||0===e.playStreamTime)&&(this.pathMainAudioMap_.delete(t),this.pathMainVideoMap_.delete(t),e.statsToReport.uint32_video_render_first=0)})),this.pathMainAudioMap_.forEach(((e,t)=>{this.hasAudioFlag(e.userId)?e.statsToReport.uint64_play_first_frame_time-e.statsToReport.uint64_start_enter_time>5e3&&(e.statsToReport.uint64_play_first_frame_time=e.statsToReport.uint64_start_enter_time+5e3):this.pathMainAudioMap_.delete(t)})),this.pathMainVideoMap_.forEach(((e,t)=>{this.hasVideoFlag(e.userId)?e.statsToReport.uint64_render_first_frame_time-e.statsToReport.uint64_start_enter_time>5e3&&(e.statsToReport.uint64_render_first_frame_time=e.statsToReport.uint64_start_enter_time+5e3):this.pathMainVideoMap_.delete(t)})),this.pathJoinRoom_.uint64_end_time-this.pathJoinRoom_.uint64_start_time>5e3&&(this.pathJoinRoom_.uint64_end_time=this.pathJoinRoom_.uint64_start_time+5e3)}getReportData(){const e=this.client_.getSignalInfo();return{uint32_sdk_app_id:Number(this.client_.getSDKAppId()),msg_user_info:new Ah({userId:this.client_.getUserId(),tinyId:this.client_.getTinyId(),role:"anchor"===this.client_.getRole()?Ri:ki}),msg_basic_info:this.basicInfo,uint32_acc_ip:Ca(e.relayIp),uint32_client_ip:Ca(e.clientIp,"small"),uint32_acc_port:0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2**31),msg_path_enter_room:this.pathJoinRoom_,msg_path_exit_room:this.pathLeaveRoom_,msg_path_recv_video:[...this.pathMainVideoMap_.values()].map((e=>e.statsToReport)),msg_quality_statistics:[...this.remoteStreamStatsMap_.values()].map((e=>e.statsToReport)),str_room_name:String(this.client_.getRoomId()),msg_path_recv_audio:[...this.pathMainAudioMap_.values()].map((e=>e.statsToReport)),uint32_info_client_ip:Ca(e.clientIp,"small"),error_code:[],msg_local_statistics:this.localStreamStats_.statsToReport}}async report(){try{const e=this.getReportData();await this.upload(e),kd.deleteItem(this.storageKey_),this.initData()}catch(e){this.log_.warn(e)}}async upload(e){if(Ct||0===e.msg_path_enter_room.uint64_start_time||[Hs,Gs,Js].findIndex((e=>e===location.host))>=0)return;const t=Number(this.client_.getSDKAppId()),i=da(t,Ii),s=await La({url:i,body:JSON.stringify(e)});if("ok"!==s.data)throw`key point upload failed: ${s.data}`}},e(bh.prototype,"upload",[Ih],Object.getOwnPropertyDescriptor(bh.prototype,"upload"),bh.prototype),bh);function Ph(){return function(e,t,i){const s=i.value,n=new Set;return i.value=async function(...e){if(n.has(this))throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Ys,data:{name:t}})});try{n.add(this);const t=await s.apply(this,e);return n.delete(this),t}catch(i){throw n.delete(this),i}},i}}async function Nh({userId:e,sdkAppId:t,useStringRoomId:i,roomId:s,userSig:n}){const r={delta:0,count:[1,1],msg:[]};try{const a=new FormData;a.append("userId",String(e)),a.append("sdkAppId",String(t)),a.append("isStrGroupId",i),a.append("groupId",String(s)),a.append("sdkVersion","4.15.1"),a.append("userSig",String(n));const o=Ea(),c=await function(e,t,i){return new Promise(((s,n)=>{let r=null;var a;(a=[xh((e=>t.count[0]=e+1),((e,i)=>{t.msg[0]=e.message,r||i()}))(Lh(i,Xt),e,{get timeout(){return 1e3*ua(2+t.count[0])}}),xh((e=>t.count[1]=e+1),((e,i)=>{t.msg[1]=e.message,r||i()}))(Lh(i,Yt),e,{get timeout(){return 1e3*ua(2+t.count[1])}})],new Promise(((e,t)=>{let i=[];a.forEach((s=>{s.then(e).catch((e=>{i.push(e),i.length===a.length&&t(i)}))}))}))).then((e=>{r=e,s(r)})).catch(n)}))}(a,r,t);return r.delta=Ea()-o,Mh({stat:r,userId:e}),c}catch(a){const t=ya(a)?a[0]:a,i=fa(t.code)?t.code:0,n=`get websocket url failed: ${t.message.includes("timeout")?"timeout":t.message}`,o=new gc({code:mc.SCHEDULE_FAILED,extraCode:i,message:aa({key:In,data:{error:n,code:i}})});throw Oo.error(o),Mh({stat:r,userId:e,roomId:s,error:o}),o}}function Mh({stat:e,userId:t,error:i}){i?sd.logFailedEvent({eventType:ms,error:i,userId:t}):sd.logSuccessEvent({eventType:ms,delta:e.delta,userId:t}),sd.uploadEvent({log:"stat-schedule:"+JSON.stringify(e),userId:t})}function Lh(e,t=Xt){let i;return i=ca(e)?t===Xt?xs:Vs:t===Xt?Ls:Os,`https://${i}/api/v1/config`}function Oh(e,t,i){return new Promise(((s,n)=>{La({url:e,body:t,timeout:i.timeout}).then((e=>{0===e.data.code?s(e.data.data):n({code:e.data.code,message:e.data.msg})})).catch(n)}))}const xh=(e,t)=>Po({retryFunction:Oh,settings:{retries:3,timeout:0},onError:t,onRetrying:e});var Vh,Uh,$h,Fh,jh,Bh,Hh,Gh,Jh,Wh,zh,qh,Kh,Qh,Xh,Yh,Zh,eu=new class{constructor(){}call(e,t){return _a(this[e])?this[e](t):Promise.reject(new gc({code:mc.INVALID_PARAMETER,message:aa({key:Gr,data:{name:e}})}))}updatePrivateMapKey({privateMapKey:e,client:t}){return t.setProperty("privateMapKey",e),Promise.resolve()}};let tu=(Vh=Ph(),Uh=Ul(xl.CLIENT.join),$h=Ph(),Fh=ql({retries:3}),jh=Ph(),Bh=Ul(...xl.CLIENT.publish),Hh=Ph(),Gh=Ul(xl.CLIENT.unpublish),Jh=Ul(...xl.CLIENT.subscribe),Wh=Ul(xl.CLIENT.unsubscribe),zh=Ph(),qh=Ul(xl.CLIENT.switchRole),Kh=Ul(xl.CLIENT.startPublishCDNStream),Qh=Ul(xl.CLIENT.startMixTranscode),Xh=Vl(...xl.CLIENT.sendSEIMessage),Yh=function({timesInSecond:e,maxSizeInSecond:t,getSize:i}){return function(s,n,r){const a=r.value,o=new Map;return Va.on(Ya,(({client:e})=>o.delete(e))),r.value=function(...s){let r=o.get(this);if(r||(r={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},o.set(this,r)),0===r.timestamp?r.timestamp=Date.now():Date.now()-r.timestamp>1e3&&(r.timestamp=Date.now(),r.callCountInSecond=0,r.totalSizeInSecond=0),i&&(r.totalSizeInSecond+=i(...s)),0!==r.timestamp&&Date.now()-r.timestamp<1e3&&(r.callCountInSecond>=e||r.totalSizeInSecond>t))throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Zr,data:{isTimes:r.callCountInSecond>=e,isSize:r.totalSizeInSecond>t,name:n,timesInSecond:e,maxSizeInSecond:t}})});return r.callCountInSecond++,a.apply(this,s)},r}}({timesInSecond:30,maxSizeInSecond:8e3,getSize:(...e)=>e[0].byteLength}),Zh=class{constructor(e){this.name_=$s,this.mode_=e.mode,this.sdpSemantics_="plan-b",ma(e.sdpSemantics)?function(){var e;if(ma(window.RTCRtpTransceiver))return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t=null,i=!1;try{t=new RTCPeerConnection({sdpSemantics:"unified-plan"}),t.addTransceiver(Dt),i=!0}catch(s){}return null===(e=t)||void 0===e||e.close(),i}()&&(this.sdpSemantics_="unified-plan"):this.sdpSemantics_=e.sdpSemantics,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.log_=Oo.createLogger({id:`c${e.seq}|${this.userId_}`,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.userSig_=e.userSig,this.roomId_=0,this.useStringRoomId_=e.useStringRoomId||!1,this.pureAudioPushMode_=null,this.version_=e.version,this.log_.info("using sdpSemantics: "+this.sdpSemantics_),this.signalChannel_=null,this.role_="anchor",this.privateMapKey_="",this.tinyId_=0,this.env_="",this.proxy_=null,this.connections_=new Map,this.mutedStates_=new Map,this.userMap_=new Map,this.syncUserListInterval_=-1,this.localStream_=null,this.localAuxStream_=null,this.uplinkConnection_=null,this.emitter_=Pa(new xa,this.name_),this.isJoined_=!1,this.heartbeat_=-1,this.lastHeartBeatTime_=-1,this.stats_=new dl(this),this.joinTimeout_=-1,this.changeBigSmallRecords_=new Map,this.networkQuality_=null,this.badCaseDetector_=null,this.networkType_=la(),this.autoSubscribe_=!!ma(e.autoSubscribe)||e.autoSubscribe,this.joinedTimestamp_=0,this.joinOptions_={},this.basis_=function(){const e={browser:wt().name+"/"+wt().version,os:zd(),displayResolution:qd(),isScreenShareSupported:Od(),isWebRTCSupported:Dd(),isGetUserMediaSupported:Kd(),isWebAudioSupported:Qd(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:Yd(),isMediaSessionSupported:"mediaSession"in navigator&&!ma(navigator.mediaSession.setActionHandler),isWebTransportSupported:!ma(window.WebTransport)};return navigator.userAgent.includes("miniProgram")&&(e.browser=`mini/${e.browser}`),e}(),this.initBussinessInfo_(e),this.publishedCDN_=!1,this.publishCDNData_=null,this.mixedMCU_=!1,this.mixTranscodeData_=null,this.checkSystemResult_=null,this.enableAudioVolumeEvaluation_=!1,this.audioVolumeIntervalId_=null,this.mixTranscodeManager_=null,this.publishCDNManager_=new Rh({client:this}),this.keyPointManager_=new Dh({client:this,frameWorkType:e.frameWorkType,component:e.component}),this.isPublishing_=!1,this.isEnableSmallStream_=!1,this.smallStreamConfig_={bitrate:100,frameRate:15,height:120,width:160},this.turnServers_=[],this.iceTransportPolicy_=e.iceTransportPolicy,this.schedule_={domains:null,iceServers:null,iceTransportPolicy:null},this.enableAutoPlayDialog_=!!ma(e.enableAutoPlayDialog)||e.enableAutoPlayDialog,this.enableMultiAuxStream_=!ma(e.enableMultiAuxStream)&&e.enableMultiAuxStream,this.signalInfo_={},this.enableSEI_=!ma(e.enableSEI)&&e.enableSEI,this.isDestroyed_=!1}initBussinessInfo_(e){this.bussinessInfo_=e.bussinessInfo;let t={};if(ga(e.bussinessInfo)&&(t=JSON.parse(e.bussinessInfo)),!ma(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:pn})});this.pureAudioPushMode_=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this.pureAudioPushMode_}if(!ma(e.streamId)){if(!(ga(e.streamId)&&String(e.streamId)&&String(e.streamId).length<=64))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:_n})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_streamid_main=e.streamId}if(!ma(e.userDefineRecordId)){const i=/^[A-Za-z0-9_-]{1,64}$/gi;if(null===e.userDefineRecordId.match(i))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:mn})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!ma(e.userDefinePushArgs)){if(!(ga(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:gn})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs}id(t)||(this.bussinessInfo_=JSON.stringify(t))}async schedule(e){const t=await Nh({userId:this.userId_,sdkAppId:this.sdkAppId_,roomId:e,useStringRoomId:this.useStringRoomId_,version:this.version_,userSig:this.userSig_});t&&(this.log_.info(`schedule: ${JSON.stringify(t)}`),this.schedule_={...this.schedule_,...t},Va.emit(Za,this.schedule_))}getSignalChannelUrl(){const e={mainUrl:"",backupUrl:""},t=oa();return t?e.mainUrl=e.backupUrl=`wss://${t}.rtc.qq.com`:this.proxy_?e.mainUrl=e.backupUrl=this.proxy_:Array.isArray(this.schedule_.domains)&&this.schedule_.domains.length>0&&(e.mainUrl=e.backupUrl=`wss://${this.schedule_.domains[0]}`,this.schedule_.domains[1]&&(e.backupUrl=`wss://${this.schedule_.domains[1]}`)),e}getUserId(){return this.userId_}getUserSig(){return this.userSig_}getRole(){return this.role_}getSignalInfo(){return this.signalInfo_}getRoomId(){return this.roomId_}getSDKAppId(){return this.sdkAppId_}getTinyId(){return this.tinyId_}getIceTransportPolicy(){return this.iceTransportPolicy_||this.schedule_.iceTransportPolicy||"all"}initialize(){this.log_.info("setup signal channel");const{mainUrl:e,backupUrl:t}=this.getSignalChannelUrl();return this.signalChannel_=new nd({sdkAppId:this.sdkAppId_,userId:this.userId_,userSig:this.userSig_,url:e,backupUrl:t,client:this}),this.networkQuality_||(this.networkQuality_=new ll({connections:this.connections_,signalChannel:this.signalChannel_,userId:this.userId_,client:this}),this.networkQuality_.on(il.NETWORK_QUALITY,(e=>{this.emitter_.emit(il.NETWORK_QUALITY,e)}))),this.deviceDetector_||(this.deviceDetector_=new hl({client:this})),this.subscriptionManager_||(this.subscriptionManager_=new Hl({client:this})),this.badCaseDetector_||(this.badCaseDetector_=new Sh({client:this,stats:this.stats_})),this.callDurationCalculator_||(this.callDurationCalculator_=new kh({client:this})),this.mixTranscodeManager_||(this.mixTranscodeManager_=new Ch({client:this,signalChannel:this.signalChannel_})),this.publishCDNManager_&&this.publishCDNManager_.setSignalChannel({signalChannel:this.signalChannel_}),this.signalChannel_.on($o,(e=>{this.log_.info(`SignalChannel state changed from ${e.prevState} to ${e.state}`),this.emitter_.emit(il.CONNECTION_STATE_CHANGED,e)})),this.signalChannel_.on(jo,(e=>{this.reset(),this.emitter_.emit(il.ERROR,e)})),this.signalChannel_.once(Vo,(e=>{this.tinyId_=e.signalInfo.tinyId,Va.emit(Qa,{client:this})})),this.signalChannel_.on(qo.PEER_JOIN,this.onPeerJoin,this),this.signalChannel_.on(qo.PEER_LEAVE,this.onPeerLeave,this),this.signalChannel_.on(qo.UPDATE_REMOTE_MUTE_STAT,(e=>{Date.now()-this.lastHeartBeatTime_>=1e4&&this.doHeartbeat(),Va.emit(za,{client:this,data:e.data}),this.onPublishedUserList(e.data),this.onUpdateRemoteMuteStat(e.data)})),this.signalChannel_.on(qo.CLIENT_BANNED,(e=>{let t,i=e.data.data.reason;if(sd.uploadEvent({log:`stat-banned:${i}`,userId:this.userId_}),i===Zt)t="you got banned by the admin";else if(i===ei)t="duplicated userId joining the room";else if(i===ii)t="the room has been disbanded by the admin",i=i.replace("_","-");else if(i===ti)return this.log_.warn(`${i} last heart beat time: ${this.lastHeartBeatTime_} interval: ${Date.now()-this.lastHeartBeatTime_}, visibility: ${document.visibilityState}`),void this.reJoin();this.log_["kick"===i?"error":"info"](`user was banned because of [${i}]`),this.reset(),this.emitter_.emit(il.CLIENT_BANNED,{reason:i,message:aa({key:xn,data:{message:t,reason:i}})||i})})),Va.emit(Ka,{client:this}),this.signalChannel_.connect()}async preJoin(e){this.joinOptions_=e,this.checkSystemResult_=await Md(),this.checkDestroy();let t=oa();t||(t=gi,this.proxy_&&(this.proxy_.startsWith(_i)?t=fi:this.proxy_.startsWith(mi)&&(t=Si))),this.env_=t,sd.setConfig({env:t,sdkAppId:this.sdkAppId_,userId:this.userId_,roomId:e.roomId}),this.uploadTrtcStats();const{isH264EncodeSupported:i,isVp8EncodeSupported:s}=this.checkSystemResult_.detail;if(!Dd()||!i&&!s)throw new gc({code:mc.NOT_SUPPORTED,message:aa({key:Nr})})}async join(e){const t=Ea();return Va.emit(Ua,{client:this,roomId:e.roomId}),ed(this.userId_,{eventId:xc,eventDesc:"joining room",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_}),await this.preJoin(e),new Promise((async(i,s)=>{this.joinReject_=s;try{this.proxy_||this.schedule_.domains||await this.schedule(e.roomId),this.checkDestroy(),await this.initialize(e),await this.doJoin(e),this.signalInfo_=this.signalChannel_.getSignalInfo(),Va.emit(ja,{client:this}),this.joinedTimestamp_=Ea(),sd.logSuccessEvent({userId:this.userId_,eventType:Ji,delta:this.joinedTimestamp_-t}),sd.logSuccessEvent({userId:this.userId_,eventType:Gi}),sd.uploadEvent({log:`stat-autoplay-dialog:${this.enableAutoPlayDialog_}`,userId:this.userId_}),sd.uploadEvent({log:`stat-conv-${Ct}-${location.hostname}`,userId:this.userId_}),i()}catch(n){Va.emit(Ba,{client:this,error:n}),sd.logFailedEvent({userId:this.userId_,eventType:Gi,error:n}),this.reset(),s(n)}this.joinReject_=null}))}checkDestroy(){if(this.isDestroyed_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:pr,data:{funName:"join"}})})}async uploadTrtcStats(){let e,t;try{const t=await ou.getMicrophones();e=t&&t.length}catch(l){}try{const e=await ou.getCameras();t=e&&e.length}catch(l){}const i={microphone:e,camera:t},{isH264EncodeSupported:s,isVp8EncodeSupported:n,isH264DecodeSupported:r,isVp8DecodeSupported:a}=this.checkSystemResult_.detail,o={webRTC:this.basis_.isWebRTCSupported,getUserMedia:this.basis_.isGetUserMediaSupported,webSocket:this.basis_.isWebSocketsSupported,screenShare:this.basis_.isScreenShareSupported,webAudio:this.basis_.isWebAudioSupported,h264Encode:s,h264Decode:r,vp8Encode:n,vp8Decode:a},c={browser:this.basis_.browser,os:this.basis_.os,trtc:o,devices:i},d={isWebCodecSupported:this.basis_.isWebCodecSupported,isMediaSessionSupported:this.basis_.isMediaSessionSupported,isWebTransportSupported:this.basis_.isWebTransportSupported};sd.uploadEvent({log:"trtcstats-"+JSON.stringify(c),userId:this.userId_}),this.log_.info("TrtcStats-"+JSON.stringify(c)),sd.uploadEvent({log:"trtcadvancedstats-"+JSON.stringify(d),userId:this.userId_})}doJoin(e){return new Promise(((t,i)=>{this.roomId_=e.roomId,ma(e.role)||(this.role_=e.role),ma(e.privateMapKey)||(this.privateMapKey_=e.privateMapKey),this.log_.info(`Join() => joining room: ${e.roomId} useStringRoomId: ${this.useStringRoomId_} mode: ${this.mode_} role: ${this.role_}`);const s={roomId:String(e.roomId),useStringRoomId:this.useStringRoomId_,privateMapKey:this.privateMapKey_,trtcRole:"anchor"===this.role_?Ri:ki,trtcScene:"live"===this.mode_?Ci:Ei,sdpSemantics:this.sdpSemantics_,version:Ma(this.version_),ua:navigator&&navigator.userAgent||"",autoSubscribe:this.autoSubscribe_,terminalType:Re?4:be?2:Te?3:Ze?12:Ye?5:et?13:1,netType:ws[la()],bussinessInfo:this.bussinessInfo_};if(this.publishCDNManager_){const{bussinessInfo:e,pushUserCdnInfo:t}=this.publishCDNManager_.handleCDNConfigForJoinData(this.bussinessInfo_);Object.assign(s,{bussinessInfo:e,pushUserCdnInfo:t})}this.log_.debug(`join room signal data: ${JSON.stringify(s)}`),this.joinTimeout_=setTimeout((()=>{this.log_.error("join room timeout observed"),i(new gc({code:mc.JOIN_ROOM_FAILED,message:aa({key:Tn})}))}),5e3),Va.emit($a,{client:this}),this.signalChannel_.once(Uo,(e=>{this.clearJoinTimeout(),Va.emit(Qa,{client:this,error:e}),i(e)})),this.signalChannel_.send(Xo,s),this.signalChannel_.once(qo.JOIN_ROOM_RESULT,(e=>{this.clearJoinTimeout();const{code:s,message:n,data:r}=e.data;this.onPublishedUserList({data:{userList:r.publishers}}),Va.emit(Fa,{client:this,code:s}),0===s?(this.isJoined_=!0,this.log_.info("Join room success, start heartbeat"),this.startHeartbeat(),this.badCaseDetector_&&this.badCaseDetector_.start(),this.syncUserList(),this.startSyncUserListInterval(),t()):(this.log_.error("Join room failed result: "+s+" error: "+n),i(new gc({code:mc.JOIN_ROOM_FAILED,extraCode:s,message:aa({key:In,data:{error:n,code:s}})})))}))}))}async reJoin(){if(this.isJoined_){this.isJoined_=!1;try{this.log_.warn(`reJoin pending: ${this.joinOptions_.roomId}`),this.subscriptionManager_&&this.subscriptionManager_.markAllStream(),this.signalChannel_.close(),await this.signalChannel_.connect(),await this.doJoin({...this.joinOptions_,role:this.role_,privateMapKey:this.privateMapKey_}),this.log_.warn("reJoin success"),sd.logSuccessEvent({userId:this.userId_,eventType:Wi}),this.checkConnectionsToReconnect(),this.uplinkConnection_&&!this.uplinkConnection_.getIsReconnecting()&&this.uplinkConnection_.startReconnection(),this.mixTranscodeManager_&&this.mixTranscodeManager_.reStartMixTranscode()}catch(e){this.log_.warn("reJoin fail "+e),this.reset(),sd.logFailedEvent({userId:this.userId_,eventType:Wi,error:e}),this.emitter_.emit(il.ERROR,new gc({code:mc.JOIN_ROOM_FAILED,message:aa({key:bn,data:{roomId:this.joinOptions_.roomId}})}))}}else this.log_.warn("reJoin abort")}async leave(){Va.emit(Ha,{client:this}),ed(this.userId_,{eventId:Vc,eventDesc:"leaving room",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_});try{await this.doHeartbeat()}catch(t){}this.doLeave(),Va.emit(Ja,{client:this}),sd.logSuccessEvent({userId:this.userId_,eventType:zi});const e=Math.floor((Ea()-this.joinedTimestamp_)/1e3);sd.logSuccessEvent({userId:this.userId_,eventType:qi,delta:e})}doLeave(){this.isJoined_&&(Va.emit(Ga,{client:this}),this.log_.info("leave() => leaving room"),this.signalChannel_.send(Yo),this.reset())}clearNetworkQuality(){this.networkQuality_&&(this.networkQuality_.stop(),this.networkQuality_=null)}closeConnections(){this.connections_.forEach((e=>{this.closeDownLink(e.getTinyId())}))}clearJoinTimeout(){clearTimeout(this.joinTimeout_),this.joinTimeout_=-1}destroy(){var e,t,i;if(this.isJoined_)throw this.log_.warn(sa.INVALID_DESTROY),new gc({code:mc.INVALID_OPERATION,message:aa({key:En})});this.isDestroyed_||(this.log_.info("destroy client"),this.joinReject_&&(this.joinReject_(new gc({code:mc.INVALID_OPERATION,message:aa({key:pr,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.off("*"),null===(e=this.callDurationCalculator_)||void 0===e||e.destroy(),null===(t=this.keyPointManager_)||void 0===t||t.destroy(),null===(i=this.deviceDetector_)||void 0===i||i.destroy(),this.callDurationCalculator_=null,this.keyPointManager_=null,this.deviceDetector_=null,this.badCaseDetector_=null,this.publishCDNManager_=null,this.isDestroyed_=!0,Va.emit(Ya,{client:this}))}reset(){this.keyPointManager_&&this.keyPointManager_.prepareReport(),this.mixTranscodeManager_&&(this.mixTranscodeManager_.reset(),this.mixTranscodeManager_=null),this.publishCDNManager_&&this.publishCDNManager_.reset(),this.userMap_.clear(),this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.mutedStates_.clear(),this.clearNetworkQuality(),this.badCaseDetector_&&this.callDurationCalculator_&&this.uploadAllCallStats(),this.closeUplink(),this.isJoined_=!1,this.signalChannel_&&(this.log_.info("destroying SignalChannel"),this.signalChannel_.close(),this.signalChannel_=null),this.stats_.reset()}startSyncUserListInterval(){-1===this.syncUserListInterval_&&(this.syncUserListInterval_=Rd.run(Xs,this.syncUserList.bind(this)))}stopSyncUserListInterval(){Rd.clearTask(this.syncUserListInterval_),this.syncUserListInterval_=-1}async syncUserList(){try{const e=await this.getUserList();0!==this.userMap_.size&&this.userMap_.forEach((t=>{e.findIndex((({userId:e})=>e===t.userId))<0&&(this.log_.info(`peer leave detected: ${t.userId}`),this.cleanUser({userId:t.userId,tinyId:t.tinyId}))})),e.forEach((e=>{const{userId:t}=e;this.userMap_.has(t)||t===this.userId_||(this.userMap_.set(t,e),this.emitter_.emit(il.PEER_JOIN,{userId:t}))}))}catch(e){this.log_.warn("sync user list failed: "+e)}}getUserList(){return this.signalChannel_?this.signalChannel_.sendWaitForResponse({command:uc,responseCommand:qo.USER_LIST_RES,enableLog:!1,timeout:2e3}).then((({data:e})=>{const{code:t,message:i}=e;if(0===t){return(e.data&&e.data.userList||[]).map((({userId:e,srcTinyId:t,role:i})=>new vh({userId:e,tinyId:t,role:i})))}throw aa({key:Br,data:{signalResponse:qo.USER_LIST_RES,code:t,message:i}})})):[]}async publish(e,t={isAuxiliary:!1}){e.setPublishState(Ds),this.isPublishing_=!0;const i=Ea();Va.emit(qa,{client:this,stream:e});const s=t.isAuxiliary,n=s?Ot:Xt,r=e.getScreen();this.log_.info(`publish() => publishing ${r?Nt+" ":""}${n} stream ${e.getId()}`);let a=this.uplinkConnection_;try{a||(a=new ph({userId:this.userId_,tinyId:this.tinyId_,client:this,isUplink:!0,signalChannel:this.signalChannel_,enableSEI:this.enableSEI_}),a.initialize(),a.on(tl.ERROR,(e=>{const t=e.getCode();t!==mc.ICE_TRANSPORT_ERROR&&(t===mc.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emitter_.emit(il.ERROR,e))}))),e.setConnection(a),await a.publish(e,s),this.log_.info(`local ${r?Nt+" ":""}${n} stream is published`),this.isPublishing_=!1,s?this.localAuxStream_=e:(this.localStream_=e,this.deviceDetector_&&this.deviceDetector_.setLocalStream(this.localStream_),this.localStream_.getBeautyStatus()&&this.log_.info("beauty stream is published successfully")),e.setPublishState(Ps),e.setClient(this,s),this.uplinkConnection_=a;const t=Ea()-i;sd.logSuccessEvent({userId:this.userId_,eventType:Ki}),sd.logSuccessEvent({userId:this.userId_,eventType:Qi,delta:t}),e.hasAudio()&&ed(this.userId_,{eventId:Sc,eventDesc:"publish audio track",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_}),e.hasVideo()&&ed(this.userId_,{eventId:fc,eventDesc:"publish video track",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_}),this.networkQuality_&&this.networkQuality_.setUplinkConnection(this.uplinkConnection_),Va.emit(po,{localStream:e,isAuxiliary:s,client:this}),this.notPublishWithoutH264Supported_=!1}catch(o){throw o instanceof gc&&o.getCode()===mc.NOT_SUPPORTED_H264&&(this.notPublishWithoutH264Supported_=!0),e.setPublishState(As),a.close(),this.log_.error("failed to publish stream "+o),this.isPublishing_=!1,sd.logFailedEvent({userId:this.userId_,eventType:Ki,error:o}),o}}async unpublish(e){if(!this.uplinkConnection_)return;const t=e===this.localAuxStream_,i=e.getScreen();this.log_.info(`unpublish() => unpublishing local ${i?Nt+" ":""}${t?Ot:Xt} stream`);try{await this.uplinkConnection_.unpublish(e),e.setClient(null),e.setConnection(null),t?this.localAuxStream_=null:(this.localStream_=null,e.hasAudio()&&ed(this.userId_,{eventId:yc,eventDesc:"unpublish audio track",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_}),e.hasVideo()&&ed(this.userId_,{eventId:vc,eventDesc:"unpublish video track",timestamp:fe(),userId:this.userId_,tinyId:this.tinyId_})),this.localStream_||this.localAuxStream_||this.closeUplink(),sd.logSuccessEvent({userId:this.userId_,eventType:Xi})}catch(s){throw sd.logFailedEvent({userId:this.userId_,eventType:Xi,error:s}),s}}closeUplink(){this.uplinkConnection_&&(this.uplinkConnection_.close(),this.uplinkConnection_=null,this.networkQuality_&&this.networkQuality_.setUplinkConnection(null),this.localStream_&&(this.localStream_.setClient(null),this.localStream_.setConnection(null),this.localStream_=null),this.localAuxStream_&&(this.localAuxStream_.setClient(null),this.localAuxStream_.setConnection(null),this.localAuxStream_=null),this.deviceDetector_&&this.deviceDetector_.setLocalStream(null))}closeDownLink(e){const t=this.connections_.get(e);t&&(t.getIsReconnecting()&&t.stopReconnection(),this.subscriptionManager_&&this.subscriptionManager_.delete(t.getUserId()),t.close(),this.connections_.delete(e),this.mutedStates_.delete(e))}async subscribe(e,t){this.log_.info(`subscribe() => subscribe to [${e.getUserId()}] ${e.getType()} stream with options: ${JSON.stringify(t)}`),ma(t)&&(t={audio:!0,video:!0}),ma(t.video)&&(t.video=!0),ma(t.audio)&&(t.audio=!0);try{const i=e.getConnection();Va.emit(oo,{client:this,stream:e}),await i.subscribe(e,t),this.subscriptionManager_&&this.subscriptionManager_.addSubscriptionRecord(e.getUserId(),e,t),this.notSubscribeWithoutH264Supported_=!1,sd.logSuccessEvent({userId:this.userId_,eventType:Yi})}catch(i){const t=i instanceof gc?i.getCode():mc.UNKNOWN;let s;throw t===mc.NOT_SUPPORTED_H264&&(this.notSubscribeWithoutH264Supported_=!0),t===mc.REMOTE_STREAM_NOT_EXIST?(s=new gc({code:mc.API_CALL_ABORTED,message:aa({key:ta,data:{message:i.message,stream:e}})}),this.log_.warn(s)):(s=new gc({code:t,message:aa({key:Pn,data:{message:i.message,stream:e}})}),this.log_.error(s)),sd.logFailedEvent({userId:this.userId_,eventType:Yi,error:s}),s}}async unsubscribe(e){this.log_.info(`unsubscribe() => unsubscribe to [${e.getUserId()}] ${e.getType()} stream`);try{const t=e.getConnection();await t.unsubscribe(e),this.subscriptionManager_&&this.subscriptionManager_.addUnsubscriptionRecord(e.getUserId(),e),Va.emit(lo,{client:this,stream:e}),sd.logSuccessEvent({userId:this.userId_,eventType:Zi})}catch(t){throw sd.logFailedEvent({userId:this.userId_,eventType:Zi,error:t}),t}}async switchRole(e){this.role_!==e&&("audience"===e&&this.localStream_&&await this.unpublish(this.localStream_),this.log_.info("switchRole() => switch role to: "+e),await this.doSwitchRole(e))}doSwitchRole(e){var t,i;const s={command:pc,data:{role:"anchor"===e?Ri:ki,privateMapKey:this.privateMapKey_},responseCommand:qo.SWITCH_ROLE_RES,retries:(null===(t=this.schedule_.config)||void 0===t||null===(i=t.retries)||void 0===i?void 0:i.switchRole)||1};return this.log_.info("switchRole signal data: "+JSON.stringify(s.data)),this.signalChannel_.sendWaitForResponseWithRetry(s).then((t=>{const{code:i,message:s}=t.data;if(0!==i)throw new gc({code:mc.SWITCH_ROLE_FAILED,message:aa({key:On,data:{errMsg:s,errCode:i}})});this.role_=e})).catch((e=>{throw e instanceof gc&&e.getCode()===mc.API_CALL_TIMEOUT&&(e=new gc({code:mc.SWITCH_ROLE_FAILED,message:aa({key:Ln})})),this.log_.error(e),e}))}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}getRemoteMutedState(){const e=[];return this.mutedStates_.forEach(((t,i,s)=>{const n=this.connections_.get(i);n&&e.push({userId:n.getUserId(),...t})})),e}async getTransportStats(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e.rtt=t.rtt}for(let[t,i]of this.connections_){const t=await this.stats_.getReceiverStats(i);e.downlinksRTT[t.userId]=t.rtt}return e}async getLocalAudioStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.audio.bytesSent,packetsSent:t.audio.packetsSent}}return e}async getLocalVideoStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.video.bytesSent,packetsSent:t.video.packetsSent,framesEncoded:t.video.framesEncoded,framesSent:t.video.framesSent,frameWidth:t.video.frameWidth,frameHeight:t.video.frameHeight}}return e}async getRemoteAudioStats(){const e={};for(let[t,i]of this.connections_){const{audioDelay:t}=i.getDelay(),s=await this.stats_.getReceiverStats(i);s.hasAudio&&(e[s.userId]={bytesReceived:s.audio.bytesReceived,packetsReceived:s.audio.packetsReceived,packetsLost:s.audio.packetsLost,end2EndDelay:t})}return e}async getRemoteVideoStats(e=Pi){const t={};for(let[i,s]of this.connections_){const i=await this.stats_.getReceiverStats(s),{videoDelay:n}=s.getDelay();e===Pi&&i.hasVideo&&(t[i.userId]={bytesReceived:i.video.bytesReceived,packetsReceived:i.video.packetsReceived,packetsLost:i.video.packetsLost,framesDecoded:i.video.framesDecoded,frameWidth:i.video.frameWidth,frameHeight:i.video.frameHeight,end2EndDelay:n}),e===Ni&&i.hasAuxiliary&&(t[i.userId]={bytesReceived:i.auxiliary.bytesReceived,packetsReceived:i.auxiliary.packetsReceived,packetsLost:i.auxiliary.packetsLost,framesDecoded:i.auxiliary.framesDecoded,frameWidth:i.auxiliary.frameWidth,frameHeight:i.auxiliary.frameHeight,end2EndDelay:n})}return t}getSdpSemantics(){return this.sdpSemantics_}getIceServers(){return 0===this.turnServers_.length&&this.schedule_.iceServers?this.schedule_.iceServers:this.turnServers_}getConnections(){return this.connections_}getMutedStates(){return this.mutedStates_}startHeartbeat(){-1===this.heartbeat_&&(this.log_.info("startHeartbeat..."),this.heartbeat_=Rd.run(Xs,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){-1!==this.heartbeat_&&(this.log_.info("stopHeartbeat"),Rd.clearTask(this.heartbeat_),this.heartbeat_=-1,this.lastHeartBeatTime_=-1)}async doHeartbeat(){const e=this.badCaseDetector_.getMonitorFreeze(),t=await this.stats_.getStatsReport({uplinkConnection:this.uplinkConnection_,downlinkConnections:this.connections_,freezeMap:e});if(Va.emit(Wa,{client:this,stats:t}),this.badCaseDetector_.resetMonitor(),!this.signalChannel_)return;const i=this.signalChannel_.isConnected()?function(e){let t=Zc.get(e),i=[];return t?(Zc.delete(e),i=t.map((e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc})))):i=[],i}(this.userId_):[],s={str_sdk_version:this.version_,uint64_datetime:(new Date).getTime(),msg_user_info:{str_identifier:this.userId_,uint64_tinyid:this.tinyId_},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:ws[this.networkType_]},...t,msg_event_msg:i};this.signalChannel_.send(Zo,s);const n=Date.now();this.lastHeartBeatTime_>0&&n-this.lastHeartBeatTime_>1e4&&this.log_.warn("heartbeat took "+(n-this.lastHeartBeatTime_)),this.lastHeartBeatTime_=n,!this.isRelayChanged_&&this.isRelayMaybeFailed()&&(this.reJoin(),this.isRelayChanged_=!0)}onRemoteStreamAdded(e){const t=e.content,{userId:i,tinyId:s,audio:n,bigVideo:r,auxVideo:a,smallVideo:o}=t;if(null===i)return void this.log_.warn("received null userId on stream added");this.userMap_.has(i)||(this.userMap_.set(i,new vh({userId:i,tinyId:s,role:"anchor"})),this.emitter_.emit(il.PEER_JOIN,{userId:i}));const c=this.connections_.get(s);if(c){if(c.getIsReconnecting())return;this.log_.warn("duplicated stream-added observed, rebuild the connection"),c.close(),this.connections_.delete(s)}const d={audio:n,video:r,auxiliary:a,smallVideo:o};this.log_.info(`remote peer [${i}] published stream. trackState: ${JSON.stringify(d)}`),this.createDownlinkConnection({userId:i,tinyId:s,trackState:d})}createDownlinkConnection({userId:e,tinyId:t,trackState:i}){const s=new gh({userId:e,tinyId:t,client:this,isUplink:!1,signalChannel:this.signalChannel_,autoSubscribe:this.autoSubscribe_,trackState:i,enableSEI:this.enableSEI_});this.connections_.set(t,s),this.installDownlinkEvents(s,e,t),this.autoSubscribe_?(s.initialize(),s.connect().catch((()=>{!s.getMainStream()&&s.hasMainStream()&&this.initRemoteStream({type:Pi,userId:e,downlinkConnection:s}),!s.getAuxStream()&&s.hasAuxStream()&&this.initRemoteStream({type:Ni,userId:e,downlinkConnection:s})}))):(s.hasMainStream()&&this.initRemoteStream({type:Pi,userId:e,downlinkConnection:s}),s.hasAuxStream()&&this.initRemoteStream({type:Ni,userId:e,downlinkConnection:s}))}initRemoteStream({type:e,userId:t,downlinkConnection:i}){const s=new Bl({type:e,userId:t,client:this});s.setConnection(i),i.setRemoteStream(e===Pi?wi:Ai,s),s.setIsStreamAddedEventEmitted(!0),Va.emit(ao,{client:this,stream:s}),this.emitter_.emit(il.STREAM_ADDED,{stream:s})}installDownlinkEvents(e,t,i){e.on(tl.SEI_MESSAGE,(e=>{this.emitter_.emit(il.SEI_MESSAGE,e)})),e.on(tl.STREAM_ADDED,(e=>{e.stream.setIsStreamAddedEventEmitted(!0),Va.emit(ao,{client:this,stream:e.stream}),this.emitter_.emit(il.STREAM_ADDED,{stream:e.stream})})),e.on(tl.STREAM_REMOVED,(e=>{this.changeBigSmallRecords_.delete(e.stream.getUserId()),e.stream.stop(),e.stream.setIsStreamAddedEventEmitted(!1),this.subscriptionManager_&&this.subscriptionManager_.deleteAutoRecoveryFlag(e.stream.getUserId(),e.stream.getType()),Va.emit(uo,{client:this,stream:e.stream}),this.emitter_.emit(il.STREAM_REMOVED,{stream:e.stream})})),e.on(tl.STREAM_UPDATED,(e=>{Va.emit(ho,{client:this,stream:e.stream}),this.emitter_.emit(il.STREAM_UPDATED,{stream:e.stream})})),e.on(tl.STREAM_SUBSCRIBED,(e=>{Va.emit(co,{client:this,stream:e.stream}),this.emitter_.emit(il.STREAM_SUBSCRIBED,{stream:e.stream})})),e.on(tl.ERROR,(e=>{const t=e.getCode();t!==mc.ICE_TRANSPORT_ERROR&&(t===mc.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLink(i),this.emitter_.emit(il.ERROR,e))}))}onPeerJoin(e){const{srcTinyId:t,userId:i,role:s}=e.data.data;this.userMap_.has(i)||(this.userMap_.set(i,new vh({userId:i,tinyId:t,role:s})),this.emitter_.emit(il.PEER_JOIN,{userId:i}))}onPeerLeave(e){const{srcTinyId:t,userId:i,reason:s=0}=e.data.data;this.log_.info(`peer leave [${i}]: ${Qs[s]}`),this.cleanUser({userId:i,tinyId:t})}cleanUser({userId:e,tinyId:t}){this.userMap_.delete(e),this.closeDownLink(t),this.emitter_.emit(il.PEER_LEAVE,{userId:e})}onPublishedUserList(e){try{const t=e.data.userList.map((e=>e.userId));this.connections_.forEach((e=>{const i=e.getUserId(),s=e.getTinyId();t.findIndex((e=>e===i))<0&&(this.log_.info(`peer unpublished detected [${i}]`),this.closeDownLink(s))})),e.data.userList.forEach((({userId:e,srcTinyId:t,flag:i})=>{if(e===this.userId_)return;const s=!!(1&i),n=!!(8&i),r=!!(4&i),a=!!(2&i),o=this.connections_.get(t);if(this.changeBigSmallRecords_.has(e)&&(a||s)&&this.checkSubscribeBigSmallVideo(o,a),o){const{audio:i,video:c,auxiliary:d,smallVideo:l}=o.getTrackState();!c&&s&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.ADD,kind:Pt}),!i&&n&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.ADD,kind:Dt}),!d&&r&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.ADD,kind:Ot}),!l&&a&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.ADD,kind:Vt}),c&&!s&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.REMOVE,kind:Pt}),i&&!n&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.REMOVE,kind:Dt}),d&&!r&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.REMOVE,kind:Ot}),l&&!a&&Va.emit(ro,{client:this,tinyId:t,userId:e,action:ks.REMOVE,kind:Vt})}else this.log_.info(`peer published detected [${e}]`),this.onRemoteStreamAdded({content:{audio:n,bigVideo:s,auxVideo:r,smallVideo:a,userId:e,tinyId:t}})}))}catch(t){}}onUpdateRemoteMuteStat(e){const t=e.data;(t&&t.userList||[]).forEach((e=>{const{srcTinyId:t,userId:i}=e;if(0===t||t===this.tinyId_)return;const s=this.connections_.get(t);if(!s)return void this.mutedStates_.delete(t);const n=s.getMainStream();if(!n||!n.getIsStreamAddedEventEmitted())return;const r=!!(1&e.flag),a=!!(8&e.flag),o=!!(2&e.flag),c=!!(64&e.flag),d=!!(16&e.flag),l=this.mutedStates_.get(t);if(void 0===l)return this.mutedStates_.set(t,{hasAudio:a,hasVideo:r,hasSmall:o,audioMuted:c,videoMuted:d}),r?d?this.emitter_.emit(il.MUTE_VIDEO,{userId:i}):this.emitter_.emit(il.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(il.MUTE_VIDEO,{userId:i}),void(a?c?this.emitter_.emit(il.MUTE_AUDIO,{userId:i}):this.emitter_.emit(il.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(il.MUTE_AUDIO,{userId:i}));{const e=!c&&a;(!l.audioMuted&&l.hasAudio)!==e&&(e?this.emitter_.emit(il.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(il.MUTE_AUDIO,{userId:i}));const s=!d&&r;(!l.videoMuted&&l.hasVideo)!==s&&(s?this.emitter_.emit(il.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(il.MUTE_VIDEO,{userId:i})),this.mutedStates_.set(t,{hasAudio:a,hasVideo:r,hasSmall:o,audioMuted:c,videoMuted:d})}}))}getEnv(){return this.env_}getSubscriptionManager(){return this.subscriptionManager_}async startPublishCDNStream(e={}){if(this.log_.info(`startPublishCDNStream with params: ${JSON.stringify(e)}; isJoined: ${this.isJoined_}; hasMainStream: ${!!this.localStream_}; hasAuxStream: ${!!this.localAuxStream_};`),e.streamType=e.streamType||Xt,e.streamType===Ot&&(e.streamType=xt),e.streamId=e.streamId||"",this.isJoined_){if(e.streamType===Xt&&!this.localStream_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Vn})});if(e.streamType===xt&&!this.localAuxStream_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Vn})})}await this.publishCDNManager_.startPublishTencentCDN(e),e.appId&&e.bizId&&e.url&&await this.publishCDNManager_.startPublishGivenCDN(e)}async stopPublishCDNStream(){if(!this.publishCDNManager_.getIsPublishingTencentCDN())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Un})});this.log_.info("stopPublishCDNStream"),await this.publishCDNManager_.stopPublishTencentCDN(),this.publishCDNManager_.getIsPublishingGivenCDN()&&await this.publishCDNManager_.stopPublishGivenCDN()}async startMixTranscode(e){if(!this.isJoined_||!this.mixTranscodeManager_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Bn})});ma(e.mode)&&(e.mode=vs.MANUAL);try{this.log_.info(`startMixTranscode with config ${JSON.stringify(e)}`),sd.uploadEvent({log:`mix-transcode-mode:${e.mode}`,userId:this.userId_}),await this.mixTranscodeManager_.startMixTranscode(e),sd.logSuccessEvent({userId:this.userId_,eventType:us})}catch(t){throw sd.logFailedEvent({userId:this.userId_,eventType:us,error:t}),t}}async stopMixTranscode(){if(!this.isJoined_||!this.mixTranscodeManager_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Hn})});try{await this.mixTranscodeManager_.stopMixTranscode(),sd.logSuccessEvent({userId:this.userId_,eventType:ps})}catch(e){throw sd.logFailedEvent({userId:this.userId_,eventType:ps,error:e}),e}}getSystemResult(){return this.checkSystemResult_}enableAudioVolumeEvaluation(e=2e3,t=!1){if(!fa(e))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Gn})});if(this.log_.info("enableAudioVolumeEvaluation with interval: "+e),e<=0)return this.enableAudioVolumeEvaluation_=!1,Rd.clearTask(this.audioVolumeIntervalId_),void(this.audioVolumeIntervalId_=null);e=Math.floor(Math.max(e,16)),Va.emit(eo,{interval:e}),this.audioVolumeIntervalId_&&(Rd.clearTask(this.audioVolumeIntervalId_),this.audioVolumeIntervalId_=null),this.enableAudioVolumeEvaluation_=!0,this.audioVolumeIntervalId_=Rd.run("raf",(()=>{const e=[];if(this.localStream_){const t=Math.floor(100*this.localStream_.getAudioLevel());e.push({userId:this.userId_,audioVolume:t,stream:this.localStream_})}this.connections_.forEach((t=>{const i=t.getSubscribedMainStream();if(i){const s=Math.floor(100*i.getAudioLevel());e.push({userId:t.getUserId(),audioVolume:s,stream:i})}})),this.emitter_.emit(il.AUDIO_VOLUME,{result:e})}),{fps:1e3/e,backgroundTask:t})}callExperimentalAPI(e,t){return eu.call(e,{client:this,...t})}setProperty(e,t){const i=`${e}_`;ma(this[i])||(this[i]=t)}uploadAllCallStats(){this.callDurationCalculator_.getDurationMap().forEach((({userId:e,type:t},i)=>{const s=this.callDurationCalculator_.getDuration(i,Pt),{dataFreeze:n}=this.badCaseDetector_.getDataFreezeDuration(i),{renderFreeze:r}=this.badCaseDetector_.getRenderFreezeDuration(i),a={userId:e,type:t,duration:s,dataFreeze:n,renderFreeze:r};sd.uploadEvent({log:"callStats-"+JSON.stringify(a),userId:this.userId_})})),this.badCaseDetector_.stop(),this.callDurationCalculator_.reset()}async enableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Jn})});if(!Xd())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:zn})});this.setIsEnableSmallStream(!0),this.log_.info("SmallStream successfully enabled")}async disableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Wn})});this.setIsEnableSmallStream(!1),this.log_.info("SmallStream successfully disabled")}setSmallStreamProfile(e){e&&e.framerate&&(e.frameRate=e.framerate),e.width*e.height>307200&&(e.width=320,e.height=240,this.log_.info("Small stream resolution is beyond limitation, which is invalid. Reset to 320 * 240")),Object.keys(this.smallStreamConfig_).forEach((t=>{e[t]&&(this.smallStreamConfig_[t]=e[t])}));const{width:t,height:i,bitrate:s,frameRate:n}=this.smallStreamConfig_;if(this.log_.info(`setSmallStreamProfile: bitrate=${s}, frameRate=${n}, height=${i}, width=${t}`),t<0||i<0||s<0||n<0)throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:qn})})}async setRemoteVideoStreamType(e,t){if(!(e instanceof Bl))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:Kn})});if(!e.getConnection())throw new gc({code:mc.INVALID_OPERATION,message:aa({key:Dn})});if(e.getType()!==Ni)switch(t){case Ns:case Ms:await this.changeVideoType(e,t)}}async changeVideoType(e,t){const i=e.getUserId(),s={stream:e,options:{video:t===Ns,smallVideo:t===Ms},isSubscribing:!1,reSubscribeCount:10};this.changeBigSmallRecords_.set(i,s),this.log_.info(`set [${i}] ${e.getType()} stream video prefer type: ${t}`)}async checkSubscribeBigSmallVideo(e,t){if(!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;const i=e.getUserId();let s=this.changeBigSmallRecords_.get(i)||{};const{video:n,smallVideo:r}=e.getSubscribeState(),{stream:a,options:o,isSubscribing:c,reSubscribeCount:d}=s;if(o.video&&n||o.smallVideo&&r&&t)return;if(c)return;let l={video:o.video,smallVideo:o.smallVideo};if(t&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{if(o&&a&&!c&&d>=1){s.isSubscribing=!0,s.reSubscribeCount=d-1;const e=a.getConnection();!t&&e.isSmallStreamSubscribed&&(l={video:!0,smallVideo:!1}),await(null==e?void 0:e.subscribe(a,l)),this.log_.info(`change [${i}] to ${l.smallVideo?"small":"big"} video successfully. count ${10-s.reSubscribeCount}.`),s.isSubscribing=!1,s.reSubscribeCount=10}}catch(h){this.log_.info(`change [${i}] to ${l.smallVideo?"small":"big"} video failed. count ${10-s.reSubscribeCount}.`),s.isSubscribing=!1,0===d&&this.changeBigSmallRecords_.delete(i)}}setIsEnableSmallStream(e){this.isEnableSmallStream_=e}getIsEnableSmallStream(){return this.isEnableSmallStream_}get smallStreamConfig(){return this.smallStreamConfig_}isPublished(){return!!this.localStream_}getUplinkConnection(){return this.uplinkConnection_}getLocalStream(){return this.localStream_}getMode(){return this.mode_}getBadCaseDetector(){return this.badCaseDetector_}getCallDurationCalculator(){return this.callDurationCalculator_}getIsJoined(){return this.isJoined_}getAllConnections(){const e=[...this.connections_.values()];return this.uplinkConnection_&&e.push(this.uplinkConnection_),e}isRelayMaybeFailed(){if(!this.signalChannel_.isOnline)return!1;const e=this.getAllConnections();if(0===e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return!1;return!0}getUseStringRoomId(){return this.useStringRoomId_}checkConnectionsToReconnect(){this.getAllConnections().forEach((e=>{if(!e.getIsReconnecting()){const t=e.getPeerConnection();t&&t.connectionState===Fi&&(this.log_.warn(`[${e.getUserId()}] pc is closed but not reconnect`),e.startReconnection())}}))}getEnableAutoPlayDialog(){return this.enableAutoPlayDialog_}sendSEIMessage(e,t){this.uplinkConnection_.sendSEI(e,t)}setProxyServer(e){if(this.log_.info(`set proxy server: ${JSON.stringify(e)}`),ga(e)){if(!e.startsWith("wss://"))throw new gc({code:mc.INVALID_PARAMETER,message:aa({key:fn})});this.proxy_=e}else if(ha(e)){const{websocketProxy:t,loggerProxy:i}=e;t&&(this.proxy_=t),i&&bi(i)}}setTurnServer(e){this.log_.info("set turn server: "+JSON.stringify(e));const t=[];Array.isArray(e)?e.forEach((e=>t.push(ba(e)))):ha(e)&&t.push(ba(e)),this.turnServers_=t}},e(Zh.prototype,"join",[Vh,Uh],Object.getOwnPropertyDescriptor(Zh.prototype,"join"),Zh.prototype),e(Zh.prototype,"leave",[$h],Object.getOwnPropertyDescriptor(Zh.prototype,"leave"),Zh.prototype),e(Zh.prototype,"getUserList",[Fh],Object.getOwnPropertyDescriptor(Zh.prototype,"getUserList"),Zh.prototype),e(Zh.prototype,"publish",[jh,Bh],Object.getOwnPropertyDescriptor(Zh.prototype,"publish"),Zh.prototype),e(Zh.prototype,"unpublish",[Hh,Gh],Object.getOwnPropertyDescriptor(Zh.prototype,"unpublish"),Zh.prototype),e(Zh.prototype,"subscribe",[Jh],Object.getOwnPropertyDescriptor(Zh.prototype,"subscribe"),Zh.prototype),e(Zh.prototype,"unsubscribe",[Wh],Object.getOwnPropertyDescriptor(Zh.prototype,"unsubscribe"),Zh.prototype),e(Zh.prototype,"switchRole",[zh,qh],Object.getOwnPropertyDescriptor(Zh.prototype,"switchRole"),Zh.prototype),e(Zh.prototype,"startPublishCDNStream",[Kh],Object.getOwnPropertyDescriptor(Zh.prototype,"startPublishCDNStream"),Zh.prototype),e(Zh.prototype,"startMixTranscode",[Qh],Object.getOwnPropertyDescriptor(Zh.prototype,"startMixTranscode"),Zh.prototype),e(Zh.prototype,"sendSEIMessage",[Xh,Yh],Object.getOwnPropertyDescriptor(Zh.prototype,"sendSEIMessage"),Zh.prototype),Zh);var iu,su,nu;let ru=0,au=0;var ou=new(iu=Vl(xl.TRTC.createClient),su=Vl(xl.TRTC.createStream),e((nu=class{constructor(){this.name_=Us,this.VERSION="4.15.1",this.Logger={loggerManager:Oo,LogLevel:qs,setLogLevel(e){Oo.setLogLevel(e),e<=1&&ra()},enableUploadLog(){Oo.enableUploadLog()},disableUploadLog(){Oo.warn("disableUploadLog"),Oo.disableUploadLog()}}}async checkSystemRequirements(){return await Md()}isScreenShareSupported(){return Od()}isSmallStreamSupported(){return Xd()}async getDevices(){if(Hd()||Bd())return[];return(await navigator.mediaDevices.enumerateDevices()).filter((e=>e.kind!==zt||"communications"!=e.deviceId)).map(((e,t)=>{let i=e.label;e.label||(i=e.kind+"_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}async getCameras(){if(Hd()||Bd())return[];return(await navigator.mediaDevices.enumerateDevices()).filter((e=>e.kind===qt)).map(((e,t)=>{let i=e.label;e.label||(i="camera_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}async getMicrophones(){if(Hd()||Bd())return[];return(await navigator.mediaDevices.enumerateDevices()).filter((e=>e.kind===zt&&"communications"!==e.deviceId)).map(((e,t)=>{let i=e.label;e.label||(i="microphone_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}async getSpeakers(){if(Hd()||Bd())return[];return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audiooutput"===e.kind)).map(((e,t)=>{let i=e.label;e.label||(i="speaker_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),s}))}createClient(e){xo&&(xo=!1,Oo.getLogLevel()!=ou.Logger.LogLevel.NONE&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info(`*   API Document: ${zs}index.html`),console.info("*   Changelog: https://cloud.tencent.com/document/product/647/38958"),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),Oo.info("TRTC Web SDK Version: 4.15.1"),Oo.info("UserAgent: "+navigator.userAgent),Oo.info("URL of current page: "+location.href));const t={version:this.VERSION},i=new tu({...t,...e,seq:++ru});return Va.emit(Xa,{client:i}),i}createStream(e){return new dh({...e,seq:++au})}}).prototype,"createClient",[iu],Object.getOwnPropertyDescriptor(nu.prototype,"createClient"),nu.prototype),e(nu.prototype,"createStream",[su],Object.getOwnPropertyDescriptor(nu.prototype,"createStream"),nu.prototype),nu);export{ou as default};
